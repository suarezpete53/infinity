(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){"use strict";var App=require("./app");var ENV=require("./env");var _=require("./vendor/underscore");var _logger=require("./logger");var SimpleEmitter=require("./emitter");var Util=require("./util");var Dom=require("./dom");var MVPDConfig=require("./mvpdconfig");var aeWrapperReady=false;var requestorId="";var configString="";var authZRequestMap={_requestIds:[]};var cachedMvpdId=function(){var _mvpdId=null;function updateCachedMvpdId(mvpdId){if(_mvpdId!==mvpdId){_logger.log('AdobeBaseAuth: "selectedProvider" was previously "'+_mvpdId+'" and is now "'+mvpdId+'".');_mvpdId=mvpdId}}function getCachedMvpdId(){return _mvpdId}return{update:updateCachedMvpdId,get:getCachedMvpdId}}();var cachedToken=function(){var _token=null;function updateCachedToken(token){if(_token!==token){_logger.log('AdobeBaseAuth: token was previously "'+_token+'" and is now "'+token+'".');_token=token}}function getCachedToken(){return _token}return{update:updateCachedToken,get:getCachedToken}}();var convertXmlStringToXmlDocument=function(parser){return function(xmlString){return parser.parseFromString(xmlString,"text/xml")}}(new window.DOMParser);var convertAdobeXmlToMvpdConfigObject=function(){var NodeTypes={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3};function addTo(obj,name,value){if(_.isUndefined(obj[name])){obj[name]=value}else{if(!_.isArray(obj[name])){obj[name]=[].concat(obj[name])}obj[name].push(value)}}function xml2json(xml){if(xml.nodeType===NodeTypes.TEXT_NODE){return xml.nodeValue}if(xml.nodeType===NodeTypes.ELEMENT_NODE&&xml.hasChildNodes()){var obj={},child,children,name,type,i,endi;for(i=0,children=xml.childNodes,endi=children.length;i<endi;i+=1){child=children.item(i);type=child.nodeType;if(type===NodeTypes.ELEMENT_NODE){name=child.nodeName;if(child.hasChildNodes()&&child.firstChild.nodeType===NodeTypes.TEXT_NODE){addTo(obj,name,child.textContent||child.innerText||child.firstChild.nodeValue)}else{addTo(obj,name,xml2json(child))}}}return obj}}return function(xml){var result;if(xml){_logger.log("convertAdobeXmlToMvpdConfigObject: converting Adobe config to mvpd JS object");var mvpds=xml.getElementsByTagName("mvpds");if(mvpds.length){_logger.log('convertAdobeXmlToMvpdConfigObject: found "mvpds" node(s)');result=xml2json(mvpds.item(0))}}return result}}();function _byMvpdId(id){return function(mvpd){return mvpd.ID===id}}var byMvpdId=_.memoize(_byMvpdId);var AdobeBaseAuth={type:"html5",PRODUCTION_ACCESS_ENABLER_URL:"https://entitlement.auth.adobe.com/entitlement/js/AccessEnabler.js",STAGING_ACCESS_ENABLER_URL:"https://entitlement.auth-staging.adobe.com/entitlement/js/AccessEnabler.js?debug",PLATFORM_PROPERTY:"html5",init:function(options){_logger.log("AdobeBaseAuth:init");SimpleEmitter.mixin(this);_.bindAll(this,"isValidMvpd","isVisibleMvpd");this.options=options;requestorId=options.requestorId;this.externalizeCallbacks();this.configuredEnv=options.vendorEnv;this.accessEnablerUrl=this.getUrlForEnv(ENV.getVendorOverrideParam())||options.adobeJsUrl||this.getUrlForEnv(options.vendorEnv)||this.PRODUCTION_ACCESS_ENABLER_URL},isReady:function(){if(!aeWrapperReady){_logger.warn("AdobeBaseAuth:isReady -- not ready!")}return aeWrapperReady},install:function(){_logger.log("AdobeBaseAuth:install");MVPDConfig.load(this.options);this.emit("adobeInitAttempt",{adobeVersion:this.type,requestorId:requestorId,adobeUrl:this.accessEnablerUrl,mvpdConfigUrl:MVPDConfig.getMvpdConfigUrl()});Util.loadScript(this.accessEnablerUrl)},getConfiguredEnvironment:function(){return this.configuredEnv},getEnv:function(url){if(_.isUndefined(url)){url=this.accessEnablerUrl}switch(url){case this.PRODUCTION_ACCESS_ENABLER_URL:return App.VENDOR_ENV_PROD;case this.STAGING_ACCESS_ENABLER_URL:return App.VENDOR_ENV_STAGING}return App.getEnvForUrl(url)},getUrlForEnv:function(env){switch(env){case App.VENDOR_ENV_STAGING:return this.STAGING_ACCESS_ENABLER_URL;case App.VENDOR_ENV_PROD:return this.PRODUCTION_ACCESS_ENABLER_URL}},getRequestorId:function(){return requestorId},getMvpdConfigEntry:function(id){if(!this.isReady())return undefined;return MVPDConfig.getMvpdConfigEntry(id)},isValidMvpd:function(mvpd){return _.isObject(mvpd)&&this.PLATFORM_PROPERTY in mvpd&&mvpd[this.PLATFORM_PROPERTY]===true},isVisibleMvpd:function(mvpd){if(_.isObject(mvpd)&&"visible"in mvpd&&_.isString(mvpd.visible)){var visible=mvpd.visible;if(visible==="all"||visible==="true"){return true}var platforms=visible.split(App.CONFIG_MULTIVALUE_DELIM);return _.contains(platforms,this.PLATFORM_PROPERTY)}return this.isValidMvpd(mvpd)},getPickerMVPDs:function(){if(!this.isReady())return[];return MVPDConfig.getVisibleMVPDs(this.isVisibleMvpd)},getMVPDs:function(){if(!this.isReady())return[];return MVPDConfig.getWhitelistedMVPDs(this.isValidMvpd)},getVisibleMvpdIds:function(){return _.pluck(this.getPickerMVPDs(),App.MVPD_ID_KEY)},isVisibleMvpdId:function(id){if(!id){return false}return _.contains(this.getVisibleMvpdIds(),id)},getValidMvpdIds:function(){return _.pluck(this.getMVPDs(),App.MVPD_ID_KEY)},isValidMvpdId:function(id){if(!id){return false}return _.contains(this.getValidMvpdIds(),id)},getMvpdById:function(id){_logger.log("AdobeBaseAuth:getMvpdById(id="+id+")");if(!this.isReady())return;if(!id){return}var mvpd=_.find(this.getMVPDs(),byMvpdId(id));if(_.isUndefined(mvpd)){_logger.warn('AdobeBaseAuth:getMvpdById - MVPD ID "'+id+'" was not found in the MVPD Config.')}return mvpd},getCachedMvpdId:function(){return cachedMvpdId.get()},externalizeCallbacks:function(){_logger.log("AdobeBaseAuth:externalizeCallbacks");window.entitlementLoaded=_.bind(this._adobeCallback_entitlementLoaded,this);window.selectedProvider=_.bind(this._adobeCallback_selectedProvider,this);window.setAuthenticationStatus=_.bind(this._adobeCallback_setAuthenticationStatus,this);window.setToken=_.bind(this._adobeCallback_setToken,this);window.tokenRequestFailed=_.bind(this._adobeCallback_tokenRequestFailed,this);window.displayProviderDialog=_.bind(this._adobeCallback_displayProviderDialog,this);window.sendTrackingData=_.bind(this._adobeCallback_sendTrackingData,this);window.createIFrame=_.bind(this._adobeCallback_createIFrame,this);window.destroyIFrame=_.bind(this._adobeCallback_destroyIFrame,this);window.setMetadataStatus=_.bind(this._adobeCallback_setMetadataStatus,this);window.setConfig=_.bind(this._adobeCallback_setConfig,this);window.reportAdobeErrorEvent=_.bind(this._adobeCallback_reportAdobeErrorEvent,this);window.preauthorizedResources=_.bind(this._adobeCallback_preauthorizedResources,this);window.setMvpdRedirectURL=_.bind(this._adobeCallback_setMvpdRedirectURL,this)},setRequestor:function(requestorId,serviceEndpoints,options){_logger.log("AdobeBaseAuth:setRequestor");this.emit("setRequestor",{requestorId:requestorId});_logger.info("Adobe:call - setRequestor",requestorId,serviceEndpoints,options);this.accessEnabler.setRequestor(requestorId,serviceEndpoints,options)},checkAuthentication:function(){_logger.log("AdobeBaseAuth:checkAuthentication");if(!this.isReady())return;this.emit("checkAuthentication",{});_logger.info("Adobe:call - checkAuthentication");this.accessEnabler.checkAuthentication()},getAuthentication:function(redirectUrl){_logger.log("AdobeBaseAuth:getAuthentication");if(!this.isReady())return;this.emit("getAuthentication",{redirectUrl:redirectUrl});_logger.info("Adobe:call - getAuthentication",redirectUrl);this.accessEnabler.getAuthentication(redirectUrl)},setAuthenticationStatus:function(isAuthenticated,errorCode){_logger.log("AdobeBaseAuth:setAuthenticationStatus");if(!this.isReady())return;_logger.log("AdobeBaseAuth:setAuthenticationStatus - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:setAuthenticationStatus - getProviderID response");if(isAuthenticated&&!providerId){_logger.error("AdobeBaseAuth:setAuthenticationStatus","Authenticated with invalid provider.");isAuthenticated=false;errorCode="N201";this.emit("errorEvent",{source:"cvp",data:{errorId:errorCode,level:"error",message:"Provider not in MVPD whitelist"}});return}this.emit("setAuthenticationStatus",{isAuthenticated:isAuthenticated,errorCode:errorCode});if(isAuthenticated){cachedMvpdId.update(providerId);this.emit("authNPass",{mvpdId:providerId,mvpd:this.getMvpdById(providerId),mvpdConfig:this.getMvpdConfigEntry(providerId)})}else{cachedMvpdId.update(null);cachedToken.update(null);this.emit("authNFail",{mvpdId:providerId,errorCode:errorCode})}},this)},_handleMvpdSelection:function(trackingData){var data={};var mvpdId=trackingData[0];cachedMvpdId.update(mvpdId);data.mvpdId=mvpdId;this.emit("mvpdSelection",data)},_handleAuthNDetection:function(trackingData){var data={};data.success=trackingData[0];if(data.success){data.mvpdId=trackingData[1];data.userId=trackingData[2];data.cached=trackingData[3]}this.emit("authenticationDetection",data)},_handleAuthZDetection:function(trackingData){var data={};data.success=trackingData[0];if(data.success){data.mvpdId=trackingData[1];data.userId=trackingData[2];data.cached=trackingData[3]}this.emit("authorizationDetection",data)},sendTrackingData:function(eventType,trackingData){_logger.log("AdobeBaseAuth:sendTrackingData");if(!this.isReady())return;switch(eventType){case"mvpdSelection":this._handleMvpdSelection(trackingData);this.emit("sendTrackingData",{eventType:eventType,trackingData:trackingData});break;case"authenticationDetection":_logger.log("AdobeBaseAuth:sendTrackingData - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:sendTrackingData - getProviderID response");if(trackingData[0]&&!providerId){_logger.error("AdobeBaseAuth:sendTrackingData","Authenticated with invalid provider.");trackingData[0]=false;trackingData[3]=false}this._handleAuthNDetection(trackingData);this.emit("sendTrackingData",{eventType:eventType,trackingData:trackingData})},this);break;case"authorizationDetection":_logger.log("AdobeBaseAuth:sendTrackingData - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:sendTrackingData - getProviderID response");if(trackingData[0]&&!providerId){_logger.error("AdobeBaseAuth:sendTrackingData","Authenticated with invalid provider.");trackingData[0]=false;trackingData[3]=false}this._handleAuthZDetection(trackingData);this.emit("sendTrackingData",{eventType:eventType,trackingData:trackingData})},this);break}},checkFeature:function(feature){var featureList=this.getFeatureList();if(!featureList){return false}if(_.isString(feature)){return _.contains(featureList,feature)}if(_.isArray(feature)){return _.difference(feature,featureList).length===0}return false},getFeatureList:function(){var mvpdId=cachedMvpdId.get();if(!mvpdId){_logger.warn("AuthManager:getFeatureList","Not authenticated with a provider.");return null}var mvpd=this.getMvpdById(mvpdId);if(!mvpd){_logger.error("AuthManager:getFeatureList",'Failed to map MVPD ID "'+mvpdId+'" to an MVPD object!');this.emit("errorEvent",{source:"cvp",data:{errorId:"CFG201",level:"error",message:"Provider not in MVPD whitelist",mvpdId:mvpdId}});return null}var list=null;var string="";var tokenRegex=/\w+/;var delimiterRegex=/\s*,\s*/;if("featureList"in mvpd&&"text"in mvpd.featureList){string=mvpd.featureList.text;if(tokenRegex.test(string)){list=_.compact(string.split(delimiterRegex))}}return list},checkPreauthorizedResources:function(resources){_logger.log("AdobeBaseAuth:checkPreauthorizedResources(resources)",resources);if(!this.isReady())return;_logger.info("Adobe:call - checkPreauthorizedResources",resources);this.accessEnabler.checkPreauthorizedResources(resources)},checkAuthorization:function(resourceId,feature){_logger.log("AdobeBaseAuth:checkAuthorization(resourceId, feature)",resourceId,feature);if(!this.isReady())return;_logger.log("AdobeBaseAuth:checkAuthorization - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:checkAuthorization - getProviderID response");if(!providerId){var errorCode="Z201";var errorString="Attempted to authorize while unauthenticated or with a provider that was not found in MVPD config.";var data={mvpdId:providerId,resource:resourceId,errorCode:errorCode,errorString:errorString};this.emit("tokenRequestFailed",data);this.emit("authZFail",data);this.emit("errorEvent",{source:"cvp",data:{errorId:errorCode,level:"error",message:errorString}});return}this.pushAuthZRequestMapEntry(resourceId,{feature:feature,mvpdId:providerId});this.emit("checkAuthorization",{mvpdId:providerId,resource:resourceId,feature:feature});_logger.info("Adobe:call - checkAuthorization",resourceId);this.accessEnabler.checkAuthorization(resourceId)},this)},getAuthZRequestMap:function(){return _.extend({},authZRequestMap)},pushAuthZRequestMapEntry:function(resourceId,entry){_logger.log("AdobeBaseAuth:pushAuthZRequestMapEntry");authZRequestMap._requestIds.push(resourceId);var slot=authZRequestMap[resourceId]=authZRequestMap[resourceId]||[];slot.push(entry)},pullAuthZRequestMapEntry:function(resourceId){_logger.log("AdobeBaseAuth:pullAuthZRequestMapEntry");if(!(resourceId in authZRequestMap)){_logger.error("AdobeBaseAuth:pullAuthZRequestMapEntry",'failed to locate resourceId "'+resourceId+'"');return}var index=_.indexOf(authZRequestMap._requestIds,resourceId);if(index===-1){_logger.error("AdobeBaseAuth:pullAuthZRequestMapEntry",'resourceId "'+resourceId+'" is not in list of requested IDs')}else{authZRequestMap._requestIds.splice(index,1)}var slot=authZRequestMap[resourceId];return slot.shift()},getOldestAuthZRequestId:function(){_logger.log("AdobeBaseAuth:getOldestAuthZRequestId");return authZRequestMap._requestIds.length&&authZRequestMap._requestIds[0]||null},setAccessToken:function(tokenString,feature){_logger.log("AdobeBaseAuth:setAccessToken");if(!this.isReady())return;if(arguments.length===0){cachedToken.update(null);return}var tokenObj={};var tokenParams={};var mvpdId=cachedMvpdId.get();tokenObj.accessTokenType="Adobe";tokenObj.accessToken=tokenString;tokenObj.mvpd=mvpdId;if(feature){var mvpd=this.getMvpdById(mvpdId);if(!mvpd){this.emit("errorEvent",{source:"cvp",data:{errorId:"T201",level:"error",message:"Provider not in MVPD whitelist",mvpdId:mvpdId}})}else if("featureList"in mvpd){tokenParams.fname=feature;if("text"in mvpd.featureList){tokenParams.flist=mvpd.featureList.text}if("signature"in mvpd.featureList){tokenParams.fsig=mvpd.featureList.signature}if("metadata"in mvpd){tokenParams.fmetadata=mvpd.metadata}if(!_.isEmpty(tokenParams)){tokenObj.tokenParams=tokenParams}}}cachedToken.update(tokenObj)},getAccessToken:function(){var token=cachedToken.get();_logger.log("AdobeBaseAuth:getAccessToken",token);return token},setToken:function(resource,token){_logger.log("AdobeBaseAuth:setToken");if(!this.isReady())return;if(_.isArray(resource)){resource=resource[0]}if(resource){var entry=this.pullAuthZRequestMapEntry(resource);if(!entry){_logger.error("AdobeBaseAuth:setToken",'No authZ map entry found for resource ID "'+resource+'"');return}if(entry.mvpdId!==cachedMvpdId.get()){_logger.error("AdobeBaseAuth:setToken","The authZ map entry for the token response is not for the currently authenticated MVPD");return}this.setAccessToken(token,entry.feature)}_logger.log("AdobeBaseAuth:setToken - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:setToken - getProviderID response");var data={mvpdId:providerId,resource:resource,token:token};this.emit("setToken",data);this.emit("authZPass",data)},this)},tokenRequestFailed:function(resource,errorCode,errorString){_logger.log("AdobeBaseAuth:tokenRequestFailed");if(!this.isReady())return;this.setAccessToken();if(resource){var entry=this.pullAuthZRequestMapEntry(resource);if(!entry){_logger.error("AdobeBaseAuth:tokenRequestFailed",'No authZ map entry found for resource ID "'+resource+'"');return}}_logger.log("AdobeBaseAuth:tokenRequestFailed - getProviderID request");this.getProviderID(function getProviderIDResponse(providerId){_logger.log("AdobeBaseAuth:tokenRequestFailed - getProviderID response");var data={mvpdId:providerId,resource:resource,errorCode:errorCode,errorString:errorString};this.emit("tokenRequestFailed",data);this.emit("authZFail",data)},this)},logout:function(){_logger.log("AdobeBaseAuth:logout");if(!this.isReady())return;this.emit("logout",{});_logger.info("Adobe:call - logout");this.accessEnabler.logout()},setSelectedProvider:function(id){_logger.log("AdobeBaseAuth:setSelectedProvider");if(!this.isReady())return;if(id===null){_logger.info("Adobe:call - setSelectedProvider","nulling out selected provider");this.accessEnabler.setSelectedProvider(null);return}if(!this.isValidMvpdId(id)){_logger.warn('AdobeBaseAuth:setSelectedProvider - MVPD id "'+id+'" was not allowed!');this.emit("errorEvent",{source:"cvp",data:{errorId:"N201",level:"error",message:"Provider not in MVPD whitelist",mvpdId:id}});return}this.emit("setSelectedProvider",{id:id});_logger.info("Adobe:call - setSelectedProvider",id);this.accessEnabler.setSelectedProvider(id)},getMetadata:function(key){_logger.log("AdobeBaseAuth:getMetadata");if(!this.isReady())return;_logger.info("Adobe:call - getMetadata",key);this.accessEnabler.getMetadata(key,_.toArray(arguments).slice(1))},getSelectedProvider:function(callback,context){_logger.log("AdobeBaseAuth:getSelectedProvider");if(!this.isReady())return;if(!_.isFunction(callback)){_logger.error("getSelectedProvider requires an async callback");throw new Error("AdobeBaseAuth::getSelectedProvider requires an async callback")}this.once("selectedProvider",callback,context);_logger.info("Adobe:call - getSelectedProvider");this.accessEnabler.getSelectedProvider()},getProviderID:function(callback,context){_logger.log("AdobeBaseAuth:getProviderID");if(!this.isReady())return;if(!_.isFunction(callback)){_logger.error("getProviderID requires an async callback");throw new Error("AdobeBaseAuth::getProviderID requires an async callback")}_logger.log("AdobeBaseAuth:getProviderID - getSelectedProvider request");this.getSelectedProvider(function getSelectedProviderResponse(data){_logger.log("AdobeBaseAuth:getProviderID - getSelectedProvider response");callback.call(context,data.MVPD)})},_adobeLoaded:function(){_logger.log("AdobeBaseAuth:_adobeLoaded");this.accessEnabler.bind("errorEvent","reportAdobeErrorEvent");var configInfo={callSetConfig:true,backgroundLogin:this.options.refreshlessLogin,backgroundLogout:this.options.refreshlessLogout,handleRedirect:this.options.handleRedirect};this.setRequestor(this.options.requestorId,null,configInfo)},_augmentErrorData:function(err){var errorIdRegex=/^([A-Z]+)([0-9]+)$/;if("errorId"in err){var errorId=err.errorId;var errorString=err.message;var errorHtml=errorString;if(errorString){var decoded=Dom.decodeHtml(errorString);errorString=decoded.text;errorHtml=errorString?decoded.html:errorString;err.message=errorString;err.messageHtml=errorHtml}var errorMatch=errorIdRegex.exec(errorId);if(errorMatch){err.errorCode=errorId;var errorGroup=errorMatch[1];var errorNumber=errorMatch[2];switch(errorGroup){case"SEC":switch(errorNumber){case"403":err.errorCategory=App.ErrorCategory.BLOCKED;err.devAction="Domain Security error. The requestor is using an invalid domain. All domains used by a particular Requestor ID need to be whitelisted by Adobe.";break;case"412":err.errorCategory=App.ErrorCategory.USER;err.resolution=App.Resolution.LOG_IN_AGAIN;break;case"420":err.errorCategory=App.ErrorCategory.BLOCKED;err.devAction="Load [https://]{SP_FQDN} in browser and manually accept the ssl certificates.  Mark proxy certs as trusted.";err.userAction="Invalid server certificate.  The authenticity of the host cannot be established.  Possible man-in-the-middle attack!";break;default:_logger.debug("Unknown error code "+errorId)}break;case"CFG":if(errorNumber.charAt(0)==="5"){err.errorCategory=App.ErrorCategory.BLOCKED;err.resolution=App.Resolution.TRY_AGAIN_LATER}else{switch(errorNumber){case"100":err.errorCategory=App.ErrorCategory.WARN;err.resolution=App.Resolution.FIX_TIME;break;default:_logger.debug("Unknown error code "+errorId)}}break;case"N":switch(errorNumber){case"000":err.errorCategory=App.ErrorCategory.LOG;break;case"001":err.errorCategory=App.ErrorCategory.INFO;break;case"005":err.errorCategory=App.ErrorCategory.LOG;break;case"010":err.errorCategory=App.ErrorCategory.LOG;err.devAction='User authenticated while degradation rule was in place.  Optionally inform the user that she is getting "complimentary" free access.';break;case"011":err.errorCategory=App.ErrorCategory.LOG;err.devAction="User was authenticated using TempPass. Inform the user; optionally present list of regular MVPDs.";break;case"111":err.errorCategory=App.ErrorCategory.INFO;err.devAction="Expired TempPass.  Inform user; present list of regular MVPDs; hide TempPass option.";break;case"130":err.errorCategory=App.ErrorCategory.BLOCKED;err.devAction="User has disabled storage.";err.resolution=App.Resolution.ALLOW_WRITE;break;case"500":err.errorCategory=App.ErrorCategory.USER;err.devAction="Internal error.  Use AccessEnablerDebug and inspect console logs.";err.resolution=App.Resolution.TRY_AGAIN_LATER;break;default:_logger.debug("Unknown error code "+errorId)}break;case"Z":switch(errorNumber){case"010":err.errorCategory=App.ErrorCategory.LOG;err.devAction="User was authorized while degradation rule was in place.";break;case"011":err.errorCategory=App.ErrorCategory.LOG;err.devAction="User was authorized using TempPass.  Optionally inform user.";break;case"100":err.errorCategory=App.ErrorCategory.USER;err.message=err.message||"You are not authorized to view this content. Please contact your TV provider for further assistance.";err.messageHtml=err.messageHtml||err.message;err.resolution=App.Resolution.CONTENT_DISALLOWED;break;case"110":err.errorCategory=App.ErrorCategory.USER;err.messageHtml=err.message="There was a problem verifying your account with your TV provider. Please try again.";err.resolution=App.Resolution.POSSIBLE_FRAUD;break;case"113":err.errorCategory=App.ErrorCategory.USER;err.message=err.message||"You are not authorized to view this content. Please contact your TV provider for further assistance.";err.messageHtml=err.messageHtml||err.message;err.resolution=App.Resolution.MVPD_NOT_AVAILABLE;break;case"120":err.errorCategory=App.ErrorCategory.USER;err.messageHtml=err.message="There was a problem verifying your account with your TV provider. Please try again.";err.resolution=App.Resolution.TRY_AGAIN_LATER;break;case"130":err.errorCategory=App.ErrorCategory.BLOCKED;err.messageHtml=err.message="There was a problem verifying your account with your TV provider. Please try again or contact your TV provider for further assistance.";err.resolution=App.Resolution.CONTENT_DISALLOWED;break;case"169":err.errorCategory=App.ErrorCategory.BLOCKED;err.devAction="Authorization denied because authzNone degradation rule has been applied for the specified resource. Inform the user.";err.messageHtml=err.message="Authorization was denied. Please try again or contact your TV provider for further assistance.";err.resolution=App.Resolution.CONTENT_DISALLOWED;break;case"500":err.errorCategory=App.ErrorCategory.BLOCKED;err.messageHtml=err.message="We are experiencing technical difficulties. Please try again or contact your TV provider for further assistance.";err.resolution=App.Resolution.TRY_AGAIN_LATER;break;default:_logger.debug("Unknown error code "+errorId)}break;case"P":switch(errorNumber){case"100":err.errorCategory=App.ErrorCategory.WARN;err.devAction="Preauthorization failed. Most likely this is due to requesting authorization for too many resources.";break;default:_logger.debug("Unknown error code "+errorId)}break;case"LS":switch(errorNumber){case"011":err.errorCategory=App.ErrorCategory.WARN;err.resolution=App.Resolution.LSO_WRITE;break;default:_logger.debug("Unknown error code "+errorId)}break}}}},_adobeCallback_reportAdobeErrorEvent:function(errorData){if(!_.isObject(errorData)){_logger.warn("Adobe:callback - reportAdobeErrorEvent","Cannot process errorData");return}_logger.info("Adobe:callback - reportAdobeErrorEvent",errorData.errorId,errorData);this.emit("adobeError",errorData);this._augmentErrorData(errorData);this.emit("errorEvent",{source:"adobe",data:errorData})},_adobeCallback_setConfig:function(config){_logger.info("Adobe:callback - setConfig",typeof config==="string"?"received config":"did not receive config");var mvpds;if(_.isString(config)){configString=config;var adobeConfig;try{adobeConfig=convertAdobeXmlToMvpdConfigObject(convertXmlStringToXmlDocument(configString))}catch(e){_logger.error("AdobeBaseAuth: failed to convert response from setConfig successfully from string to XML to JS object")}if(!_.isEmpty(adobeConfig)&&"mvpd"in adobeConfig){mvpds=_.isArray(adobeConfig.mvpd)?adobeConfig.mvpd:[adobeConfig.mvpd]}}if(mvpds){MVPDConfig.updateVendorConfig(mvpds);this.emit("adobeInitSuccess",{requestorId:this.options.requestorId,adobeUrl:this.accessEnablerUrl})}else{this.emit("adobeInitFailure",{errorCode:"CFG001",errorId:"CFG001",errorString:"setConfig response was invalid",errorCategory:App.ErrorCategory.BLOCKED,resolution:App.Resolution.TRY_AGAIN_LATER})}this._onMvpdConfigSuccess=_.bind(this._onMvpdConfigSuccess,this,{adobeVersion:this.type,adobeStaging:this.getEnv()===App.VENDOR_ENV_STAGING,adobeSwfUrl:this.options.adobeSwfUrl,adobeJsUrl:this.options.adobeJsUrl,requestorId:this.options.requestorId,customMVPDPicker:this.options.customPicker,mvpdConfigUrl:MVPDConfig.getMvpdConfigUrl(),accessEnablerId:this.accessEnablerId,accessEnablerUrl:this.accessEnablerUrl});MVPDConfig.ready.then(this._onMvpdConfigSuccess,this._onMvpdConfigFailure)},_onMvpdConfigSuccess:function(vendorData){_logger.log("MVPDConfig success allowed AccessEnabler to be ready!");aeWrapperReady=true;this.emit("ready",vendorData)},_onMvpdConfigFailure:function(){_logger.error("MVPDConfig failure prohibited AccessEnabler from being ready!")},getConfigString:function(){return configString},_adobeCallback_setMvpdRedirectURL:function(data){_logger.info("Adobe:callback - setMvpdRedirectURL(data)",data);this.emit("setMvpdRedirectURL",data)},_adobeCallback_entitlementLoaded:function(){_logger.info("Adobe:callback - entitlementLoaded()");this.accessEnabler=window.accessEnabler;this._adobeLoaded()},_adobeCallback_selectedProvider:function(result){_logger.info("Adobe:callback - selectedProvider(result)",result);if(!this.isReady())return;if(!_.isObject(result)||!_.isString(result.AE_State)||!(_.isString(result.MVPD)||_.isNull(result.MVPD))){_logger.error('AdobeBaseAuth: "selectedProvider" did not send a valid response:',result);result={MVPD:null}}var mvpdId=result.MVPD;var isInvalidProvider=false;if(mvpdId&&!this.isValidMvpdId(mvpdId)){_logger.debug('AdobeBaseAuth: "selectedProvider" response MVPD ("'+mvpdId+'") was not found in MVPDConfig.');isInvalidProvider=true;result.MVPD=mvpdId=null}cachedMvpdId.update(mvpdId);this.emit("selectedProvider",result);if(isInvalidProvider){this.emit("invalidProvider",{id:mvpdId})}},_adobeCallback_preauthorizedResources:function(resources){_logger.info("Adobe:callback - preauthorizedResources(resources)",resources);this.emit("preauthorizedResources",{resources:resources})},_adobeCallback_setToken:function(resource,token){_logger.info("Adobe:callback - setToken(resource, token)",resource,token);this.setToken(resource,token)},_adobeCallback_tokenRequestFailed:function(resource,errorCode,errorString){_logger.info("Adobe:callback - tokenRequestFailed(resource, errorCode, errorString)",resource,errorCode,errorString);this.tokenRequestFailed(resource,errorCode,errorString)},_adobeCallback_setAuthenticationStatus:function(isAuthenticated,errorCode){_logger.info("Adobe:callback - setAuthenticationStatus(isAuthenticated, errorCode)",isAuthenticated,errorCode);this.setAuthenticationStatus(Number(isAuthenticated),errorCode)},_adobeCallback_sendTrackingData:function(eventType,trackingData){var key,value;_logger.info("Adobe:callback - sendTrackingData(eventType, trackingData)",eventType,trackingData);for(key in trackingData){if(_.has(trackingData,key)){value=trackingData[key];if(value==="true"){trackingData[key]=true}if(value==="false"){trackingData[key]=false}}}this.sendTrackingData(eventType,trackingData)},_adobeCallback_setMetadataStatus:function(key,args,value){_logger.info("Adobe:callback - setMetadataStatus(key, args, value)",key,args,value);this.emit("setMetadataStatus",{key:key,args:args,value:value})},_adobeCallback_displayProviderDialog:function(){_logger.info("Adobe:callback - displayProviderDialog(providers)");this.displayProviderDialog()},displayProviderDialog:function(){if(!this.isReady())return;this.emit("displayProviderDialog",{mvpds:this.getPickerMVPDs()})},_adobeCallback_createIFrame:function(w,h){_logger.info("Adobe:callback - createIFrame(width, height)",w,h);var width=Util.toInt(w);var height=Util.toInt(h);this.emit("createIFrame",{width:width,height:height})},_adobeCallback_destroyIFrame:function(){_logger.info("Adobe:callback - destroyIFrame()");this.emit("destroyIFrame",{})}};module.exports=AdobeBaseAuth},{"./app":2,"./dom":7,"./emitter":8,"./env":9,"./logger":11,"./mvpdconfig":15,"./util":19,"./vendor/underscore":23}],2:[function(require,module,exports){exports.VERSION="2.4.9.4";var cdnOrigin="https://cvp1.cdn.turner.com";exports.CDN_ORIGIN=cdnOrigin;exports.CVP_CONFIG_ROOT=cdnOrigin+"/xslo/cvp/config";var CONFIG_ENV_PREPROD="preprod";var CONFIG_ENV_PROD="prod";exports.CONFIG_ENV_PREPROD=CONFIG_ENV_PREPROD;exports.CONFIG_ENV_PROD=CONFIG_ENV_PROD;exports.configEnvOptions=[CONFIG_ENV_PREPROD,CONFIG_ENV_PROD];exports.VENDOR_ENV_STAGING="staging";exports.VENDOR_ENV_PROD="prod";exports.ADOBE_ENTITLEMENT_STAGING_HOST="entitlement.auth-staging.adobe.com";exports.ADOBE_ENTITLEMENT_PRODUCTION_HOST="entitlement.auth.adobe.com";exports.ADOBE_API_STAGING_HOST="api.auth-staging.adobe.com";exports.ADOBE_API_PRODUCTION_HOST="api.auth.adobe.com";exports.getOriginForEnv=function(env){switch(env){case this.VENDOR_ENV_PROD:return location.protocol+"//"+this.ADOBE_ENTITLEMENT_PRODUCTION_HOST;case this.VENDOR_ENV_STAGING:return location.protocol+"//"+this.ADOBE_ENTITLEMENT_STAGING_HOST}};exports.MVPD_ID_KEY="ID";exports.DEFAULT_COUNTRY="US";exports.UNKNOWN_COUNTRY="N/A";exports.CONFIG_MULTIVALUE_DELIM=/\s*[|,]\s*/;exports.DISAPPROVING_MVPDS=["ATT","Comcast_SSO"];exports.MIN_LOGOS_TO_DISPLAY=1;exports.MAX_LOGOS_TO_DISPLAY=12;exports.ADOBE_IFRAME_NAME="mvpdframe";exports.ADOBE_WINDOW_NAME="mvpdwindow";exports.ErrorCategory={LOG:"LOG",INFO:"INFO",WARN:"WARN",AUTO:"AUTO",USER:"USER",BLOCKED:"BLOCKED",severity:["LOG","INFO","WARN","AUTO","USER","BLOCKED"]};exports.Resolution={RELOAD_PAGE:"001",TRY_AGAIN_LATER:"002",FIX_TIME:"013",ALLOW_WRITE:"015",LSO_WRITE:"022",LOG_IN_AGAIN:"101",CONTENT_DISALLOWED:"201",POSSIBLE_FRAUD:"202",MVPD_NOT_AVAILABLE:"203",UNKNOWN:"000"};exports.Strings={title:"Login",welcomemessage:"Get unlimited access to all your favorite content.<br/><br/>It's free through your participating TV Provider and available on your favorite devices.",welcomeloginbutton:"Get Started",rememberedcancelbutton:"Not My TV Provider",rememberedokbutton:"Continue to Log In",viewallbutton:"View All TV Providers",viewtopbutton:"View Top TV Providers",dontseebutton:"I Don't See My TV Provider",noprovidermessage:"This service is only available through participating TV Providers.<br/><br/>Please check back soon to see if your TV Provider has been added.",noproviderokbutton:"OK",
darkproviderokbutton:"OK",signinmessage:"Connecting...",signincancelbutton:"Cancel",errormessage:"There was a problem verifying your account with your TV Provider.<br/><br/>Please try again.",errorokbutton:"OK",successmessage:"Congratulations!<br><br>You're now ready to watch on mobile, tablet or the web.",watchnowbutton:"Watch Now"}},{}],3:[function(require,module,exports){"use strict";var App=require("./app");var _=require("./vendor/underscore");var _logger=require("./logger");var Util=require("./util");var periodically=Util.periodically;var Dom=require("./dom");var MVPDConfig=require("./mvpdconfig");var aspen;if(_.isUndefined(window.Aspen)||!_.isFunction(window.Aspen.createInstance)){_logger.debug("AspenController - Aspen was not found - aspen.js must be installed prior to cvp.auth.js")}else{aspen=window.Aspen.createInstance({aspenAppSignature:{applicationName:"auth",applicationVersion:App.VERSION,context:"default",deviceModel:"desktop",deviceType:"desktop",deviceVersion:"desktop",platformName:"javascript",platformVersion:undefined}})}var auth=null;var inited=false;var regcode;var commonMsgProps={};function send(type,obj){if(!aspen)return;var data=_.extend({},commonMsgProps,obj);aspen.send(type,data)}var initHeartbeat=periodically(send.bind(null,"adobeInitHeartbeat"),1e4);var authZHeartbeat=function(){var SECOND=1e3;var MINUTE=60*SECOND;var heartbeatTimer=null;var heartbeatDelay=10*SECOND;var aspenPayload=null;function determineHeartbeatDelay(delay){if(delay<MINUTE){return delay+10*SECOND}if(delay<5*MINUTE){return delay+30*SECOND}return delay+MINUTE}function heartbeat(){_logger.debug("AspenController - heartbeat",heartbeatDelay+" ms have passed");send("authorizationHeartbeat",aspenPayload);heartbeatDelay=determineHeartbeatDelay(heartbeatDelay);wait()}function wait(){heartbeatTimer=window.setTimeout(heartbeat,heartbeatDelay)}function clear(){if(heartbeatTimer){window.clearTimeout(heartbeatTimer);heartbeatTimer=null}}function start(authZData){clear();aspenPayload=authZData;wait()}function stop(){clear();aspenPayload=null}return{start:start,stop:stop}}();function adobeInitAttempt(obj){send("adobeInit",{clientVersion:obj.adobeVersion,requestorID:obj.requestorId,mvpdConfig:obj.mvpdConfigUrl,staging:obj.adobeStaging});initHeartbeat.start()}function adobeInitSuccess(obj){send("adobeInitSuccess",{requestorID:obj.requestorId,serverUrl:obj.adobeUrl});initHeartbeat.stop()}function adobeInitFailure(){send("adobeInitFailure",{});initHeartbeat.stop()}function mvpdConfigLoadAttempt(obj){send("mvpdConfigLoadAttempt",{requestorID:obj.requestorId,url:obj.mvpdConfigUrl})}function mvpdConfigLoadSuccess(){send("mvpdConfigLoadSuccess",{})}function mvpdConfigLoadFailure(){send("mvpdConfigLoadFailure",{})}function darkPhaseLoadAttempt(obj){send("darkPhaseLoadAttempt",{url:obj.darkPhaseUrl})}function darkPhaseLoadSuccess(){send("darkPhaseLoadSuccess",{})}function darkPhaseLoadFailure(){send("darkPhaseLoadFailure",{})}function regCodeInvalid(obj){regcode=undefined;send("invalidRegcode",{regCode:obj.regCode})}function regCodeValid(obj){regcode=obj.regCode;send("validRegcode",{regCode:obj.regCode})}function authNAttempt(obj){send("authenticationAttempt",{mvpdID:obj.id,regCode:regcode,requestorID:auth.getRequestorId()})}function authNSuccess(obj){send("authenticationSuccess",{mvpdID:obj.mvpdID,userID:obj.userID,requestorID:auth.getRequestorId()})}function statusUpdate(obj){if(obj.eventType==="authenticationDetection"&&obj.trackingData[0]===true&&obj.trackingData[3]===false){authNSuccess({mvpdID:obj.trackingData[1],userID:obj.trackingData[2]})}}function authZAttempt(obj){var data={mvpdID:obj.mvpdId,requestorID:auth.getRequestorId(),resource:obj.resource};send("authorizationAttempt",data);authZHeartbeat.start(data)}function authZSuccess(obj){send("authorizationSuccess",{mvpdID:obj.mvpdId,requestorID:auth.getRequestorId(),resource:obj.resource});authZHeartbeat.stop()}function authZFailure(obj){send("authorizationFailure",{mvpdID:obj.mvpdId,requestorID:auth.getRequestorId(),resource:obj.resource,errorCode:obj.errorCode,errorDescription:obj.errorString});authZHeartbeat.stop()}function providerList(obj){var mvpdNames=_.pluck(obj.mvpds,App.MVPD_ID_KEY).join(",");send("providerList",{list:mvpdNames})}function adobeEvent(obj){send("adobeEvent",obj)}function logout(){send("logout",{})}var authHandlers=function(){var handlers={adobeInitAttempt:adobeInitAttempt,adobeInitSuccess:adobeInitSuccess,adobeInitFailure:adobeInitFailure,registrationCodeInvalid:regCodeInvalid,registrationCodeValid:regCodeValid,setSelectedProvider:authNAttempt,sendTrackingData:statusUpdate,checkAuthorization:authZAttempt,setToken:authZSuccess,tokenRequestFailed:authZFailure,displayProviderDialog:providerList,adobeError:adobeEvent,logout:logout};return function enableAuthHandlers(onOrOff){var handler;if(!auth){return}for(var name in handlers){if(!_.has(handlers,name)){continue}handler=handlers[name];auth[onOrOff](name,handler)}}}();var mvpdConfigHandlers=function(){var handlers={mvpdConfigLoadAttempt:mvpdConfigLoadAttempt,mvpdConfigLoadSuccess:mvpdConfigLoadSuccess,mvpdConfigLoadFailure:mvpdConfigLoadFailure,darkPhaseLoadAttempt:darkPhaseLoadAttempt,darkPhaseLoadSuccess:darkPhaseLoadSuccess,darkPhaseLoadFailure:darkPhaseLoadFailure};return function enableMvpdConfigHandlers(onOrOff){var handler;for(var name in handlers){if(!_.has(handlers,name)){continue}handler=handlers[name];MVPDConfig[onOrOff](name,handler)}}}();function destroy(){authHandlers("off");mvpdConfigHandlers("off")}function init(options,authInstance){if(!aspen)return;if(inited){return}inited=true;auth=authInstance;_logger.log("AspenController - init",options);var aspenInitConfig={};aspenInitConfig.site=options.site;aspenInitConfig.context=options.aspenContext||options.context;aspenInitConfig.configBaseUrl=options.configBaseUrl;aspenInitConfig.dt=options.superduperdevtime;aspen.init(aspenInitConfig);authHandlers("on");mvpdConfigHandlers("on");Dom.on(window,"unload",destroy)}exports.send=send;exports.init=init},{"./app":2,"./dom":7,"./logger":11,"./mvpdconfig":15,"./util":19,"./vendor/underscore":23}],4:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var Promise=require("./vendor/promise");var App=require("./app");var ENV=require("./env");var _logger=require("./logger");var AdobeBaseAuth=require("./adobebaseauth");var ClientAuthNFsm=require("./clientauthnfsm");var ClientAuthZFsm=require("./clientauthzfsm");var AspenController=require("./aspencontroller");var SimpleEmitter=require("./emitter");var Util=require("./util");var Dom=require("./dom");var MVPDConfig=require("./mvpdconfig");var MVPDPicker=require("./mvpdpicker");var Store=require("./store");var RememberedProvider=require("./remembered");var LoginIframe=require("./loginiframe");var LoginPopup=require("./loginpopup");var LoginWindow=require("./loginwindow");var AuthManager=new SimpleEmitter;var authNFsm;var authZFsm;var Login={UNDEFINED:0,TEMPPASS:1,REDIRECT:2,IFRAME:3,POPUP:4,WINDOW:5,OVERRIDE_REDIRECT:6};var loginMethod=Login.UNDEFINED;var defaults={preauthZResourceLimit:5,omitAuthZTokenForResourceIds:["CBS"],tokenService:"https://token.vgtf.net/token/token_spe_mml?profile=mml",configEnv:App.CONFIG_ENV_PROD,vendorEnv:App.VENDOR_ENV_PROD,primaryMinCount:App.MIN_LOGOS_TO_DISPLAY,primaryMaxCount:App.MAX_LOGOS_TO_DISPLAY,hiddenMvpdIds:["TempPass"],autoAuth:false,autoAuthMvpdId:"TempPass",handleRedirect:true,refreshlessLogin:false,refreshlessLogout:false};var config={};var inited=false;var isAuthNed=false;var auth=null;function Deferred(){var _fulfill,_reject;var promise=new Promise(function(resolve,reject){_fulfill=resolve;_reject=reject});promise.fulfill=_fulfill;promise.reject=_reject;return promise}var authReadyPromise=new Deferred;var geoReadyPromise=new Deferred;var libReadyPromise=Promise.all([MVPDConfig.ready,geoReadyPromise,authReadyPromise]);var isReady=false;var accessEnablerOrigin="";var currentMvpdId=null;var nullProviderOnClose=false;var geoCountry;var preauthZRequest=null;var preauthZResourceDelimiter=",";var getSiteId=function(){var requestorIdToSiteIdMap={adultswim:"as",cartoonnetwork:"cn",trutv:"tru"};return function convertRequestorIdToSiteId(adobeRequestorId){var clientLower=adobeRequestorId.toLowerCase();return requestorIdToSiteIdMap[clientLower]||clientLower}}();function getConfiguredEnvironment(){if(auth)return auth.getConfiguredEnvironment()}function _doesMvpdIdDisapprove(mvpdId){if(!mvpdId){return false}var disapprovingMvpd=_.contains(App.DISAPPROVING_MVPDS,mvpdId);if(!disapprovingMvpd){return false}var configedEnv=getConfiguredEnvironment();var overrideEnv=ENV.getVendorOverrideParam();var changingEnvs=overrideEnv&&configedEnv&&overrideEnv!==configedEnv||false;var switchingToProd=changingEnvs&&overrideEnv===App.VENDOR_ENV_PROD||false;var disallowedCrossEnvironment=switchingToProd&&disapprovingMvpd;_logger.info("MVPD ID: "+mvpdId+", configured: "+configedEnv+", override: "+overrideEnv+", changing? "+changingEnvs+", switching to prod? "+switchingToProd+", disallowed cross-environment contamination? "+disallowedCrossEnvironment);return disallowedCrossEnvironment}var doesMvpdIdDisapprove=_.memoize(_doesMvpdIdDisapprove);function doesMvpdDisapprove(mvpd){return doesMvpdIdDisapprove(mvpd.ID)}function doesCurrentMvpdIdDisapprove(){return doesMvpdIdDisapprove(currentMvpdId)}function initAuth(options){options.platform="flash";authNFsm=new ClientAuthNFsm;authZFsm=new ClientAuthZFsm;auth=AdobeBaseAuth;auth.init(options)}function notifyNotReady(){_logger.warn("AuthManager is not ready.")}function notifyDisapproved(){_logger.warn("Selected MVPD disapproves access.  All Auth API is no-op.")}function getEnv(){if(!isReady)return notifyNotReady();return auth.getEnv()}function getCountryCode(){if(!isReady)return notifyNotReady();return geoCountry}function isVisibleMvpdId(mvpdId){if(!isReady)return notifyNotReady();return auth.isVisibleMvpdId(mvpdId)}function isValidMvpdId(mvpdId){if(!isReady)return notifyNotReady();return auth.isValidMvpdId(mvpdId)}function checkAuthentication(){_logger.log("AuthManager:checkAuthentication");if(!isReady)return notifyNotReady();auth.checkAuthentication()}function getAuthentication(redirectUrl){_logger.log("AuthManager:getAuthentication");if(!isReady)return notifyNotReady();redirectUrl=Util.createRedirectUrl(redirectUrl);auth.getAuthentication(redirectUrl)}function checkPreauthorizedResources(resourceIds){_logger.log("AuthManager:checkPreauthorizedResources");if(!isReady)return notifyNotReady();if(doesCurrentMvpdIdDisapprove()){return notifyDisapproved()}if(_.isString(resourceIds)){resourceIds=_.toArray(arguments)}if(!_.isArray(resourceIds)){throw new Error("AuthManager:checkPreauthorizedResources requires an array, instead of: "+resourceIds)}resourceIds=_.uniq(resourceIds.sort());if(resourceIds.length>config.preauthZResourceLimit){_logger.warn("AuthManager:checkPreauthorizedResources - You have provided "+resourceIds.length+" resource IDs. If you go over the MVPD limit, Adobe will return *no* resources as authorized.")}if(preauthZRequest&&resourceIds.join(preauthZResourceDelimiter)!==preauthZRequest.join(preauthZResourceDelimiter)){_logger.warn('AuthManager:checkPreauthorizedResources has already been requested with "'+preauthZRequest+'", by requesting "'+resourceIds+'" you have invalidated the preauthz cache.')}preauthZRequest=resourceIds;auth.checkPreauthorizedResources(resourceIds)}function checkFeature(feature){_logger.log("AuthManager:checkFeature");if(!isReady){notifyNotReady();return false}if(doesCurrentMvpdIdDisapprove()){notifyDisapproved();return false}return auth.checkFeature(feature)}function checkAuthorization(resourceId,feature){_logger.log("AuthManager:checkAuthorization");if(!isReady)return notifyNotReady();if(doesCurrentMvpdIdDisapprove()){return notifyDisapproved()}if(!feature){return auth.checkAuthorization(resourceId)}if(!checkFeature(feature)){_logger.warn("AuthManager:checkAuthorization",'feature "'+feature+'" was not found in feature list');this.emit("errorEvent",{source:"cvp",data:{errorId:"Z220",level:"error",message:'Did not call checkAuthorization because feature "'+feature+'" was not found in feature list'}})}else{auth.checkAuthorization(resourceId,feature)}}function getMetadata(){_logger.log("AuthManager:getMetadata");if(!isReady)return notifyNotReady();if(doesCurrentMvpdIdDisapprove()){return notifyDisapproved()}auth.getMetadata.apply(auth,arguments)}function getFeatureList(){_logger.log("AuthManager:getFeatureList");if(!isReady){notifyNotReady();return null}if(doesCurrentMvpdIdDisapprove()){notifyDisapproved();return null}return auth.getFeatureList()}function getAccessToken(options){_logger.log("AuthManager:getAccessToken");var tokenObj=auth.getAccessToken();if(_.isEmpty(tokenObj)){return null}if(_.isObject(options)){if("accessToken"in tokenObj){if(_.isString(options.prefix)){tokenObj.accessToken=options.prefix+tokenObj.accessToken}if(_.isString(options.suffix)){tokenObj.accessToken=tokenObj.accessToken+options.suffix}}}return tokenObj}function selectProvider(mvpdId){_logger.log("AuthManager:selectProvider");if(!isReady)return notifyNotReady();if(doesMvpdIdDisapprove(mvpdId)){return notifyDisapproved()}if(mvpdId===null){this.emit("nullProvider")}setTimeout(function(){auth.setSelectedProvider(mvpdId)},600)}function getProvider(callback,context){_logger.log("AuthManager:getProvider");if(!isReady)return notifyNotReady();auth.getSelectedProvider(callback,context)}function getProviderID(callback,context){_logger.log("AuthManager:getProviderID");if(!isReady)return notifyNotReady();auth.getProviderID(callback,context)}function logout(){_logger.log("AuthManager:logout");if(!isReady)return notifyNotReady();auth.logout()}function getMvpdById(mvpdId){_logger.log("AuthManager:getMvpdById");if(!isReady)return notifyNotReady();return auth.getMvpdById(mvpdId)}function getMvpdConfigEntry(mvpdId){_logger.log("AuthManager:getMvpdConfigEntry");if(!isReady)return notifyNotReady();return auth.getMvpdConfigEntry(mvpdId)}function getConfigString(){_logger.log("AuthManager:getConfigString");if(!isReady)return notifyNotReady();return auth.getConfigString()}function isMvpdIdForTempPass(mvpdId){return _.contains(config.hiddenMvpdIds,mvpdId)}function determineLoginMethod(mvpdId){if(loginMethod!==Login.UNDEFINED){_logger.log("determineLoginMethod - loginMethod is already determined: "+loginMethod);return loginMethod}if(!mvpdId){_logger.warn('Requested MVPD ID "'+mvpdId+'" was not valid for login.');return loginMethod=Login.UNDEFINED}if(isMvpdIdForTempPass(mvpdId)){_logger.log('Requested MVPD ID "'+mvpdId+'" was found to be used for TempPass. (hiddenMvpdIds)');return loginMethod=Login.TEMPPASS}var mvpd=getMvpdById(mvpdId);if(!mvpd){_logger.warn('Requested MVPD ID "'+mvpdId+'" was not found in the MVPD config or is disabled.');return loginMethod=Login.UNDEFINED}if(_.isString(mvpd.destinationURL)&&Util.parseUrl(mvpd.destinationURL)){return loginMethod=Login.OVERRIDE_REDIRECT}if(config.refreshlessLogin&&!mvpd.iFrameRequired){return loginMethod=Login.WINDOW}if(mvpd.iFrameRequired){var loginType=ENV.determineLoginType({mvpdId:mvpdId,requestorId:config.requestorId});if(loginType==="popup"){return loginMethod=Login.POPUP}return loginMethod=Login.IFRAME}return loginMethod=Login.REDIRECT}function openRequisiteLoginPortal(mvpd,options){if(loginMethod===Login.WINDOW){if(!LoginWindow.open(mvpd,options,accessEnablerOrigin)){loginMethod=Login.REDIRECT}}else if(loginMethod===Login.POPUP){if(!LoginPopup.open(mvpd,options,accessEnablerOrigin)){loginMethod=Login.REDIRECT}}}function prepareMvpdLogin(mvpdId,options){_logger.log("AuthManager:prepareMvpdLogin");if(loginMethod===Login.TEMPPASS){return}var mvpd=getMvpdById(mvpdId);if(!mvpd){throw new Error('Requested MVPD ID "'+mvpdId+'" was not found in the MVPD config or is disabled.')}if(loginMethod===Login.OVERRIDE_REDIRECT){this.emit("overrideRedirect");location.href=mvpd.destinationURL;return}else if(loginMethod!==Login.REDIRECT){openRequisiteLoginPortal(mvpd,options)}}function openLogin(mvpdId,options){_logger.log("AuthManager:openLogin");closeLogin();loginMethod=Login.UNDEFINED;determineLoginMethod(mvpdId);prepareMvpdLogin(mvpdId,options);this.selectProvider(mvpdId)}function byPrimaryOrder(mvpd){return"primaryOrder"in mvpd&&mvpd.primaryOrder>0&&"picker"in mvpd}function createPrimaryFilterForCountry(country){return function byPrimaryOrderForCountry(mvpd){return"countries"in mvpd&&_.contains(mvpd.countries,country)&&byPrimaryOrder(mvpd)}}var defaultCountryFilter=createPrimaryFilterForCountry(App.DEFAULT_COUNTRY);var defaultPrimaries;function getDefaultPrimaries(mvpds){return defaultPrimaries||(defaultPrimaries=_.filter(mvpds,defaultCountryFilter))}var countryPrimaries;function getCountryPrimaries(mvpds,country){return countryPrimaries||(countryPrimaries=_.filter(mvpds,createPrimaryFilterForCountry(country)))}function getPrimaries(mvpds){var country=getCountryCode();if(country===App.UNKNOWN_COUNTRY||country===App.DEFAULT_COUNTRY){return getDefaultPrimaries(mvpds)}var list=getCountryPrimaries(mvpds,country);if(!list.length){list=getDefaultPrimaries(mvpds)}return list}function openPicker(mvpds){_logger.log("AuthManager:openPicker");if(!isReady)return notifyNotReady();if(!mvpds){_logger.log("AuthManager:openPicker - forcing picker open");auth.displayProviderDialog()}else{_logger.log("AuthManager:openPicker - providing picker with mvpds");MVPDPicker.open({Strings:App.Strings,onRender:config.onPickerRendered,hasWelcomeSlate:!!config.hasWelcomeSlate,primaryMinCount:Number(config.primaryMinCount),primaryMaxCount:Number(config.primaryMaxCount),primaryMvpds:getPrimaries(mvpds),mvpds:mvpds})}}function closeLogin(){_logger.log("AuthManager:closeLogin");LoginWindow.close();LoginPopup.close();LoginIframe.close()}function closePicker(){_logger.log("AuthManager:closePicker");MVPDPicker.close()}function getMVPDs(){if(auth)return auth.getMVPDs()}function onAuthInitFailure(obj){_logger.log("AuthManager:onAuthInitFailure");authReadyPromise.reject(obj)}function getAdobeOrigin(){return App.getOriginForEnv(getConfiguredEnvironment())}function onAuthInitReady(obj){_logger.log("AuthManager:onAuthInitReady");isReady=true;accessEnablerOrigin=getAdobeOrigin();if(config.autoAuth&&config.autoAuthMvpdId&&authNFsm.supports.autoAuth){if(this.getMvpdById(config.autoAuthMvpdId)){_logger.log("AuthManager:onAuthInitReady",'configuring autoAuth for free preview with provider ID "'+config.autoAuthMvpdId+'"');authNFsm.setAutoAuth(true);authNFsm.setAutoAuthMvpdId(config.autoAuthMvpdId);if(config.autoAuthRetryLimit){authNFsm.setAutoAuthRetryLimit(config.autoAuthRetryLimit);if(config.autoAuthRetryDelay){authNFsm.setAutoAuthRetryDelay(config.autoAuthRetryDelay)}}}else{_logger.warn("AuthManager:onAuthInitReady",'autoAuth was configured; however, "'+config.autoAuthMvpdId+'" was not a valid MVPD ID, so autoAuth is not available.')}}auth.getProviderID(function getSelectedProviderResponse(mvpdId){currentMvpdId=mvpdId});authReadyPromise.fulfill(obj)}function onAuthNPass(obj){_logger.log("AuthManager:onAuthNPass");var mvpdId=obj.mvpdId;currentMvpdId=doesMvpdIdDisapprove(mvpdId)?null:mvpdId;if(!currentMvpdId){this.logout();return}isAuthNed=true;if(isVisibleMvpdId(currentMvpdId)){RememberedProvider.save(currentMvpdId)}this.emit("authNPass",_.omit(obj,["mvpd"]))}function onAuthNFail(obj){_logger.log("AuthManager:onAuthNFail");currentMvpdId=null;isAuthNed=false;this.emit("authNFail",obj)}function onPreauthorizedResources(obj){_logger.log("AuthManager:onPreauthorizedResources");_logger.log("AuthManager:onPreauthorizedResources - getProviderID request");getProviderID(function getProviderIDResponse(providerId){_logger.log("AuthManager:onPreauthorizedResources - getProviderID response");if(!providerId){this.emit("errorEvent",{source:"cvp",data:{errorId:"P001",level:"error",message:"Attempted to authorize while unauthenticated or with a provider that was not found in MVPD config."}});return}if(!_.isArray(obj.resources)){_logger.error("AuthManager:onPreauthorizedResources - failed to receive array of resourceIDs!");onPreauthorizedResourcesFailure({message:"No resources returned from AccessEnabler."});return}var preauthZResponse=obj.resources.sort();if(preauthZRequest&&preauthZResponse.join(preauthZResourceDelimiter)!==preauthZRequest.join(preauthZResourceDelimiter)){var missingIds=_.difference(preauthZRequest,preauthZResponse);_logger.info("AuthManager:onPreauthorizedResources - some resourceIDs were not preauthorized: "+missingIds);if(preauthZRequest.length!==preauthZResponse.length+missingIds.length){var extraIds=_.difference(preauthZResponse,preauthZRequest);_logger.warn("AuthManager:onPreauthorizedResources - unexpected resourceIDs were preauthorized -- "+extraIds+" -- or concurrent requests were made resulting in a race condition.")}}this.emit("preauthorizedResources",{resources:preauthZResponse})},this)}var onPreauthorizedResourcesFailure=_.bind(function onPreauthorizedResourcesFailure(error){this.emit("preauthorizedResources",{error:error,resources:[]})},AuthManager);function onAuthZPass(obj){_logger.log("AuthManager:onAuthZPass");this.emit("authZPass",obj)}function onAuthZFail(obj){_logger.log("AuthManager:onAuthZFail");this.emit("authZFail",obj)}function onMetadataStatus(obj){_logger.log("AuthManager:onMetadataStatus");this.emit("metadataStatus",obj)}function onTrackingData(obj){_logger.log("AuthManager:onTrackingData");this.emit("trackingData",obj)}function onAuthorizationDetection(obj){_logger.log("AuthManager:onAuthorizationDetection");this.emit("authorizationDetection",obj)}function onAuthenticationDetection(obj){_logger.log("AuthManager:onAuthenticationDetection");loginMethod=Login.UNDEFINED;this.emit("authenticationDetection",obj)}function onMvpdSelection(obj){_logger.log("AuthManager:onMvpdSelection");var mvpdId=obj.mvpdId;determineLoginMethod(mvpdId);prepareMvpdLogin(mvpdId);this.emit("mvpdSelection",obj);if(loginMethod===Login.REDIRECT){this.emit("loginRedirect")}}function onRegistrationCodeValid(obj){_logger.log("AuthManager:onRegistrationCodeValid");this.emit("registrationCodeValid",obj)}function onRegistrationCodeInvalid(obj){_logger.log("AuthManager:onRegistrationCodeInvalid");this.emit("registrationCodeInvalid",obj)}function onSetMvpdRedirectURL(obj){_logger.log("AuthManager:onSetMvpdRedirectURL");var url=obj.redirectURL;switch(loginMethod){case Login.IFRAME:LoginIframe.setSrc(url);break;case Login.POPUP:LoginPopup.setSrc(url);break;case Login.WINDOW:LoginWindow.setSrc(url);break;case Login.REDIRECT:default:location.href=url}}function onDisplayPicker(obj){_logger.log("AuthManager:onDisplayPicker");if(MVPDPicker.isDeactivated()){_logger.debug("MVPDPicker has been deactivated.");return}var mvpds=obj.mvpds||[];mvpds=_.reject(mvpds,doesMvpdDisapprove);openPicker(mvpds)}function onAuthVendorError(obj){_logger.log("AuthManager:onAuthVendorError");this.emit("error",obj);if("data"in obj&&"level"in obj.data&&obj.data.level==="error"&&"resolution"in obj.data){this.emit("resolvableError",obj.data)}}function onCreateIframe(obj){_logger.log("AuthManager:onCreateIframe");if(loginMethod!==Login.IFRAME){_logger.debug("AuthManager:onCreateIframe",'did not create iframe because either AutoAuth, redirect-login or popup-login in progress -- loginMethod = "'+loginMethod+'" -- ignoring Adobe callback');return}LoginIframe.open(config,obj)}function onDestroyIframe(){_logger.log("AuthManager:onDestroyIframe");LoginIframe.close()}function login(mvpdId,redirectUrl){_logger.log("AuthManager:login");if(!this.isValidMvpdId(mvpdId)){_logger.warn('AuthManager:login - "'+mvpdId+'" is not a valid MVPD ID; requesting Picker instead');this.getAuthentication(redirectUrl);return}function onCompletion(){this.off("authNPass",onLoginAuthNPass);this.off("authNFail",onLoginAuthNFail);MVPDPicker.reactivate()}function onLoginAuthNPass(){_logger.log("AuthManager:login",'successfully logged in with "'+mvpdId+'"');onCompletion.call(this)}function onLoginAuthNFail(){_logger.log("AuthManager:login",'failed to log in with "'+mvpdId+'"');onCompletion.call(this)}auth.once("displayProviderDialog",function(){_logger.log("AuthManager:login",'intercepting request to displayProviderDialog, setting provider to "'+mvpdId+'"');this.on("authNPass",onLoginAuthNPass,this);this.on("authNFail",onLoginAuthNFail,this);this.openLogin(mvpdId)},this);MVPDPicker.deactivate();this.getAuthentication(redirectUrl)}function _login(mvpdId,redirectUrl){_logger.log("AuthManager:_login");if(!this.isValidMvpdId(mvpdId)){_logger.warn('AuthManager:login - "'+mvpdId+'" is not a valid MVPD ID; requesting Picker instead');this.getAuthentication(redirectUrl);return}function onCompletion(){this.off("authNPass",onLoginAuthNPass);this.off("authNFail",onLoginAuthNFail);MVPDPicker.reactivate()}function onLoginAuthNPass(){_logger.log("AuthManager:login",'successfully logged in with "'+mvpdId+'"');onCompletion.call(this)}function onLoginAuthNFail(){_logger.log("AuthManager:login",'failed to log in with "'+mvpdId+'"');onCompletion.call(this)}auth.once("displayProviderDialog",function(){_logger.log("AuthManager:login",'intercepting request to displayProviderDialog, setting provider to "'+mvpdId+'"');this.on("authNPass",onLoginAuthNPass,this);this.on("authNFail",onLoginAuthNFail,this);this.openLogin(mvpdId)},this);MVPDPicker.deactivate();this._getAuthN(redirectUrl)}function init(options){if(inited){throw new Error("AuthManager.init() was already called.")}inited=true;this.options=options;if("logLevel"in options){_logger.setLevel(options.logLevel)}if("authLogLevel"in ENV.queryParams){_logger.setLevel(ENV.queryParams.authLogLevel)}_.extend(config,defaults,options);var authConfigEnv=ENV.getConfigOverrideParam();if(authConfigEnv){config.configEnv=authConfigEnv}config.refreshlessLogin="refreshlessLogin"in config&&config.refreshlessLogin||false;config.refreshlessLogout="refreshlessLogout"in config&&config.refreshlessLogout||false;if(!ENV.supports.refreshlessLogin){config.refreshlessLogin=false}if(!ENV.supports.refreshlessLogout){config.refreshlessLogout=false}if(!ENV.supports.handleRedirect){config.handleRedirect=false}config.customPicker=config.picker!=="default";config.requestorId=config.requestorId||config.clientId;config.site=config.site||getSiteId(config.clientId);initAuth(config);AspenController.init(config,auth);auth.install();auth.on("ready",authNFsm.handleInitReady,authNFsm);auth.on("adobeInitFailure",authNFsm.handleInitFailure,authNFsm);authNFsm.on("ready",_.bind(onAuthInitReady,this));authNFsm.on("initFailure",_.bind(onAuthInitFailure,this));auth.on("authNPass",authNFsm.handleAuthNPass,authNFsm);auth.on("authNFail",authNFsm.handleAuthNFail,authNFsm);authNFsm.on("authNPass",_.bind(onAuthNPass,this));authNFsm.on("authNFail",_.bind(onAuthNFail,this));auth.on("authZPass",authZFsm.handleAuthZPass,authZFsm);auth.on("authZFail",authZFsm.handleAuthZFail,authZFsm);authZFsm.on("authZPass",_.bind(onAuthZPass,this));authZFsm.on("authZFail",_.bind(onAuthZFail,this));auth.on("setMetadataStatus",onMetadataStatus,this);auth.on("sendTrackingData",onTrackingData,this);auth.on("authorizationDetection",onAuthorizationDetection,this);auth.on("authenticationDetection",onAuthenticationDetection,this);auth.on("mvpdSelection",onMvpdSelection,this);auth.on("displayProviderDialog",onDisplayPicker,this);auth.on("createIFrame",onCreateIframe,this);auth.on("destroyIFrame",onDestroyIframe,this);auth.on("errorEvent",onAuthVendorError,this);auth.on("preauthorizedResources",onPreauthorizedResources,this);auth.on("invalidProvider",authNFsm.handleInvalidProvider,authNFsm);auth.on("registrationCodeValid",onRegistrationCodeValid,this);auth.on("registrationCodeInvalid",onRegistrationCodeInvalid,this);auth.on("setMvpdRedirectURL",onSetMvpdRedirectURL,this);authNFsm.init(this);authZFsm.init(this);MVPDPicker.setup(this);MVPDConfig.ready.then(function(){function resolveGeoReadyPromise(code){geoCountry=code;geoReadyPromise.fulfill(code)}ENV.fetchCountryCode().then(resolveGeoReadyPromise,resolveGeoReadyPromise)});libReadyPromise.then(function(obj){AuthManager.emit("initReady",obj)},function(obj){AuthManager.emit("initFailure",obj)});if(!/mobi/i.test(navigator.userAgent)){Dom.on(window,"unload",function(){AuthManager.closeLogin()})}function handleLoginOpen(){AuthManager.emit("loginOpened")}function handleLoginClose(){AuthManager.emit("loginClosed")}LoginIframe.on("opened",handleLoginOpen);LoginIframe.on("closed",handleLoginClose);LoginPopup.on("opened",handleLoginOpen);LoginPopup.on("closed",handleLoginClose);LoginWindow.on("opened",handleLoginOpen);LoginWindow.on("closed",handleLoginClose);MVPDPicker.on("mvpdSelected",function onMvpdSelected(obj){var mvpdId=obj.mvpdId;_logger.log("AuthManager:pickerMvpdSelected:event",mvpdId);AuthManager.emit("pickerMvpdSelected",obj)});MVPDPicker.on("darkProviderSelected",function onDarkProviderSelected(obj){var mvpdId=obj.mvpdId;_logger.log("AuthManager:pickerDarkProviderSelected:event",mvpdId);AuthManager.emit("pickerDarkProviderSelected",obj)});MVPDPicker.on("helpClicked",function onHelpClicked(obj){_logger.log("AuthManager:pickerHelpClicked:event",obj.state);AuthManager.emit("pickerHelpClicked",obj)});MVPDPicker.on("closeClicked",function onCloseClicked(obj){_logger.log("AuthManager:pickerCloseClicked:event",obj.state);AuthManager.emit("pickerCloseClicked",obj)});MVPDPicker.on("opened",function onOpened(obj){_logger.log("AuthManager:pickerOpened:event");nullProviderOnClose=false;AuthManager.emit("pickerOpened",obj)});MVPDPicker.on("canceled",function onCanceled(obj){_logger.log("AuthManager:pickerCanceled:event",obj.state);nullProviderOnClose=true;getProviderID(function getProviderIDResponse(providerId){obj.mvpdId=providerId;AuthManager.emit("pickerCanceled",obj);AuthManager.closePicker()})});MVPDPicker.on("closed",function onClosed(obj){_logger.log("AuthManager:pickerClosed:event");AuthManager.closeLogin();var emitPickerClosed=_.bind(AuthManager.emit,AuthManager,"pickerClosed",obj);if(nullProviderOnClose){AuthManager.once("authNFail",emitPickerClosed);AuthManager.selectProvider(null)}else{emitPickerClosed()}});MVPDPicker.on("stateChange",function onStateChange(obj){_logger.log("AuthManager:pickerStateChange:event",obj.state);AuthManager.emit("pickerStateChange",obj)});this.on("pickerDarkProviderSelected",function onPickerDarkProviderSelected(obj){AspenController.send("darkProviderSelected",{mvpdID:obj.mvpdId,success:obj.success})});this.on("pickerHelpClicked",function onPickerHelpClicked(){AspenController.send("helpWindowOpened")});this.on("pickerOpened",function onPickerOpened(){AspenController.send("pickerWindowOpened")});this.on("pickerClosed",function onPickerClosed(){AspenController.send("pickerWindowClosed")});this.on("pickerCanceled",function onPickerCanceled(obj){AspenController.send("cancelLogin",{mvpdID:obj.mvpdId,requestorID:auth.getRequestorId()})});if(_.isFunction(config.onInitReady)){this.on("initReady",function callOnInitReady(){_logger.log("AuthManager:onInitReady:callback");config.onInitReady()})}if(_.isFunction(config.onInitFailure)){this.on("initFailure",function callOnInitFailure(){_logger.log("AuthManager:onInitFailure:callback");config.onInitFailure()})}if(_.isFunction(config.onAuthenticationPassed)){this.on("authNPass",function callOnAuthenticationPassed(obj){_logger.log("AuthManager:onAuthNPass:callback");config.onAuthenticationPassed(obj.mvpdId,obj.mvpdConfig)})}if(_.isFunction(config.onAuthenticationFailed)){this.on("authNFail",function callOnAuthenticationFailed(obj){_logger.log("AuthManager:onAuthNFail:callback");config.onAuthenticationFailed(obj.errorCode,obj.errorString,obj.errorHtml)})}if(_.isFunction(config.onPreauthorizedResources)){this.on("preauthorizedResources",function callOnPreauthorizedResources(obj){_logger.log("AuthManager:onPreauthorizedResources:callback");config.onPreauthorizedResources(obj.resources)})}if(_.isFunction(config.onAuthorizationPassed)){this.on("authZPass",function callOnAuthorizationPassed(obj){_logger.log("AuthManager:onAuthZPass:callback");
config.onAuthorizationPassed(obj.resource)})}if(_.isFunction(config.onAuthorizationFailed)){this.on("authZFail",function callOnAuthorizationFailed(obj){_logger.log("AuthManager:onAuthZFail:callback");config.onAuthorizationFailed(obj.resource,obj.errorCode,obj.errorString,obj.errorHtml)})}if(_.isFunction(config.onMetadataStatus)){this.on("metadataStatus",function callOnMetadataStatus(obj){_logger.log("AuthManager:onMetadataStatus:callback");config.onMetadataStatus(obj.key,obj.value)})}if(_.isFunction(config.onTrackingData)){this.on("trackingData",function callOnTrackingData(obj){_logger.log("AuthManager:onTrackingData:callback");config.onTrackingData(obj.eventType,obj.trackingData)})}if(_.isFunction(config.onAuthorizationDetection)){this.on("authorizationDetection",function callOnAuthorizationDetection(obj){_logger.log("AuthManager:onAuthorizationDetection:callback");if(!obj.success){config.onAuthorizationDetection(obj.success)}else{config.onAuthorizationDetection(obj.success,obj.mvpdId,obj.userId,obj.cached)}})}if(_.isFunction(config.onAuthenticationDetection)){this.on("authenticationDetection",function callOnAuthenticationDetection(obj){_logger.log("AuthManager:onAuthenticationDetection:callback");if(!obj.success){config.onAuthenticationDetection(obj.success)}else{config.onAuthenticationDetection(obj.success,obj.mvpdId,obj.userId,obj.cached)}})}if(_.isFunction(config.onMvpdSelection)){this.on("mvpdSelection",function callOnMvpdSelection(obj){_logger.log("AuthManager:onMvpdSelection:callback");config.onMvpdSelection(obj.mvpdId)})}if(_.isFunction(config.onRegistrationCodeValid)){this.on("registrationCodeValid",function callOnRegistrationCodeValid(obj){_logger.log("AuthManager:onRegistrationCodeValid:callback");config.onRegistrationCodeValid(obj.regCode)})}if(_.isFunction(config.onRegistrationCodeInvalid)){this.on("registrationCodeInvalid",function callOnRegistrationCodeInvalid(){_logger.log("AuthManager:onRegistrationCodeInvalid:callback");config.onRegistrationCodeInvalid()})}if(_.isFunction(config.onError)){this.on("error",function callOnError(obj){_logger.log("AuthManager:onError:callback");config.onError(obj.source,obj.data)})}if(_.isFunction(config.onResolvableError)){this.on("resolvableError",function callOnResolvableError(obj){_logger.log("AuthManager:onResolvableError:callback");config.onResolvableError(obj.data)})}if(_.isFunction(config.onLoginOpened)){this.on("loginOpened",function callOnLoginOpened(){_logger.log("AuthManager:onLoginOpened:callback");config.onLoginOpened()})}if(_.isFunction(config.onLoginClosed)){this.on("loginClosed",function callOnLoginClosed(){_logger.log("AuthManager:onLoginClosed:callback");config.onLoginClosed()})}if(_.isFunction(config.onPickerOpened)){this.on("pickerOpened",function callOnPickerOpened(){_logger.log("AuthManager:onPickerOpened:callback");config.onPickerOpened()})}if(_.isFunction(config.onPickerClosed)){this.on("pickerClosed",function callOnPickerClosed(){_logger.log("AuthManager:onPickerClosed:callback");config.onPickerClosed()})}if(_.isFunction(config.onPickerCanceled)){this.on("pickerCanceled",function callOnPickerCanceled(obj){_logger.log("AuthManager:onPickerCanceled:callback");config.onPickerCanceled(obj.state)})}if(_.isFunction(config.onPickerStateChange)){this.on("pickerStateChange",function callOnPickerStateChange(obj){_logger.log("AuthManager:onPickerStateChange:callback");config.onPickerStateChange(obj.state)})}if(_.isFunction(config.onPickerHelpClicked)){this.on("pickerHelpClicked",function callOnPickerHelpClicked(obj){_logger.log("AuthManager:onPickerHelpClicked:callback");config.onPickerHelpClicked(obj.state)})}if(_.isFunction(config.onPickerCloseClicked)){this.on("pickerCloseClicked",function callOnPickerCloseClicked(obj){_logger.log("AuthManager:onPickerCloseClicked:callback");config.onPickerCloseClicked(obj.state)})}if(_.isFunction(config.onPickerMvpdSelected)){this.on("pickerMvpdSelected",function callOnPickerMvpdSelected(obj){_logger.log("AuthManager:onPickerMvpdSelected:callback");config.onPickerMvpdSelected(obj.mvpdId)})}return this}function fsm_getInitErrors(){_logger.log("AuthManager.getInitErrors()");return authNFsm.getInitErrors()}function fsm_checkAuthentication(){_logger.log("AuthManager.checkAuthentication()");Promise.resolve().then(_.bind(authNFsm.checkAuthN,authNFsm))}function fsm_getAuthentication(redirectUrl){_logger.log("AuthManager.getAuthentication(redirectUrl)",redirectUrl);Promise.resolve().then(_.bind(authNFsm.getAuthN,authNFsm,redirectUrl))}function fsm_checkPreauthorizedResources(resourceIds){_logger.log("AuthManager.checkPreauthorizedResources(resourceIds)",resourceIds);if(!isReady)return notifyNotReady();if(doesCurrentMvpdIdDisapprove()){return notifyDisapproved()}if(!isAuthNed){_logger.warn("AuthManager.checkPreauthorizedResources should only be called if you are authenticated");onPreauthorizedResourcesFailure({mvpdId:null,errorCode:"N000",errorString:"User not authenticated."});return}Promise.resolve().then(_.bind(authNFsm.checkPreauthZ,authNFsm,resourceIds))}function fsm_checkAuthorization(resourceId,feature){_logger.log("AuthManager.checkAuthorization(resourceId, feature)",resourceId,feature);if(!isReady)return notifyNotReady();if(doesCurrentMvpdIdDisapprove()){return notifyDisapproved()}if(!isAuthNed){_logger.warn("AuthManager.checkAuthorization should only be called if you are authenticated");var errorCode="N000";var errorString="Attempted to authorize while unauthenticated.";var data={mvpdId:null,resource:resourceId,errorCode:errorCode,errorString:errorString};this.emit("authZFail",data);this.emit("errorEvent",{source:"cvp",data:{errorId:errorCode,level:"error",message:errorString}});return}Promise.resolve().then(_.bind(authZFsm.checkAuthZ,authZFsm,resourceId,feature))}function awaitAuthNResponse(){return new Promise(_.bind(function authNResolver(resolve,reject){function onRequestAuthNPass(data){this.off("authNFail",onRequestAuthNFail,this);resolve(data)}function onRequestAuthNFail(data){this.off("authNPass",onRequestAuthNPass,this);reject(data)}this.once("authNPass",onRequestAuthNPass,this);this.once("authNFail",onRequestAuthNFail,this)},this))}function awaitAuthZResponse(){return new Promise(_.bind(function authZResolver(resolve,reject){function onRequestAuthZPass(data){this.off("authZFail",onRequestAuthZFail,this);resolve(data)}function onRequestAuthZFail(data){this.off("authZPass",onRequestAuthZPass,this);reject(data)}this.once("authZPass",onRequestAuthZPass,this);this.once("authZFail",onRequestAuthZFail,this)},this))}function fsm_requestAuthN(resourceId){_logger.log("AuthManager.requestAuthN(resourceId)",resourceId);if(!isReady){notifyNotReady();return Promise.reject()}if(doesCurrentMvpdIdDisapprove()){notifyDisapproved();return Promise.reject()}var promise=this.awaitAuthNResponse();this.checkAuthentication(resourceId);return promise}function fsm_requestAuthZ(resourceId,feature){_logger.log("AuthManager.requestAuthZ(resourceId, feature)",resourceId,feature);if(!isReady){notifyNotReady();return Promise.reject()}if(doesCurrentMvpdIdDisapprove()){notifyDisapproved();return Promise.reject()}var promise=this.awaitAuthZResponse().then(function(data){if(feature){data.feature=feature}return data});this.checkAuthorization(resourceId,feature);return promise}function fsm_logout(){_logger.log("AuthManager.logout()");Promise.resolve().then(_.bind(authNFsm.logout,authNFsm))}function parseCdnToken(json){_logger.log("CDN token retrieved");var data;try{data=JSON.parse(json)}catch(e){_logger.error("Token service response was not valid JSON!");return Promise.reject({message:"Token service response was not valid JSON",token:{code:"TKN001"}})}if(typeof data!=="object"||!("auth"in data)||typeof data.auth!=="object"){_logger.error("Token service response could not be parsed!");return Promise.reject({message:"Token service response could not be parsed",token:{code:"TKN002"}})}if("error"in data.auth){_logger.error("Token service response contains an error!",data.auth.error);var errorObject=_.extend({},data.auth.error);if(!("code"in errorObject)){errorObject.code="TKN003"}return Promise.reject({message:"Token service error"+("message"in errorObject?" - "+errorObject.message:""),token:errorObject})}if(!("token"in data.auth)){_logger.error('Token service response did not contain "token" data!');return Promise.reject({message:"Token service response did not contain token",token:{code:"TKN004"}})}return data}function appendToken(url,token){return Util.augmentQueryString(url,{hdnts:token})}function fetchTokenizedUrl(videoUrlString,resourceId,opts){var options=opts||{};if(!_.isObject(options)){throw new Error("Invalid options parameter!")}var videoUrl=Util.parseUrl(videoUrlString);if(!videoUrlString||!videoUrl){throw new Error("Invalid URL")}function requestCdnToken(authZData){var resourceId=authZData.resource;var adobeToken=authZData.token;var data={format:"json"};data.mvpd=authZData.mvpdId;data.path=videoUrl.dir+"*";if(resourceId&&adobeToken){data.accessTokenType="Adobe";data.accessToken=adobeToken}var appData={};if("timeConsumed"in options){appData.clientTime=options.timeConsumed}if(!_.isEmpty(appData)){data.appData=JSON.stringify(appData)}return Util.request({url:config.tokenService,data:data}).catch(function onTokenRequestFail(err){var code="TKN"+("000"+(err.status||"0")).slice(-3);return Promise.reject({message:err.statusText,token:{code:code,error:err}})})}function appendCdnToken(cdnToken){return appendToken(videoUrlString,cdnToken.auth.token)}function appendManualToken(){return appendToken(videoUrlString,options.cdnToken)}if(_.contains(config.omitAuthZTokenForResourceIds,resourceId)){if(options.cdnToken){return Promise.resolve(appendManualToken())}return requestCdnToken({mvpdId:currentMvpdId}).then(parseCdnToken).then(appendCdnToken)}var checkAuthZ=this.requestAuthZ(resourceId).catch(function onAuthZFail(err){return Promise.reject({message:err.errorString,authorization:err})});if(options.cdnToken){return checkAuthZ.then(appendManualToken)}return checkAuthZ.then(requestCdnToken).then(parseCdnToken).then(appendCdnToken)}_.extend(AuthManager,{version:App.VERSION,Resolution:App.Resolution,Strings:App.Strings,init:init,ready:libReadyPromise,getInitErrors:fsm_getInitErrors,getEnv:getEnv,getMVPDs:getMVPDs,isAuthenticated:fsm_checkAuthentication,checkAuthentication:fsm_checkAuthentication,getAuthentication:fsm_getAuthentication,isVisibleMvpdId:isVisibleMvpdId,isValidMvpdId:isValidMvpdId,getProvider:getProvider,getProviderID:getProviderID,getMvpdConfigEntry:getMvpdConfigEntry,checkPreauthorizedResources:fsm_checkPreauthorizedResources,checkAuthorization:fsm_checkAuthorization,fetchTokenizedUrl:fetchTokenizedUrl,requestAuthN:fsm_requestAuthN,requestAuthZ:fsm_requestAuthZ,awaitAuthNResponse:awaitAuthNResponse,awaitAuthZResponse:awaitAuthZResponse,getMetadata:getMetadata,getFeatureList:getFeatureList,checkFeature:checkFeature,getAccessToken:getAccessToken,logout:fsm_logout,login:login,getRememberedProvider:_.bind(RememberedProvider.get,RememberedProvider),_checkPreauthZ:checkPreauthorizedResources,_checkAuthN:checkAuthentication,_getAuthN:getAuthentication,_checkAuthZ:checkAuthorization,_login:_login,_logout:logout,MVPDPicker:MVPDPicker,_:_,Util:Util,Dom:Dom,Promise:Promise,when:Promise.all,Store:Store,getCountryCode:getCountryCode,getConfigString:getConfigString,openLogin:openLogin,openPicker:openPicker,getMvpdById:getMvpdById,selectProvider:selectProvider,closeLogin:closeLogin,isPickerOpen:_.bind(MVPDPicker.isOpen,MVPDPicker),closePicker:closePicker,cancelPicker:closePicker});module.exports=AuthManager},{"./adobebaseauth":1,"./app":2,"./aspencontroller":3,"./clientauthnfsm":5,"./clientauthzfsm":6,"./dom":7,"./emitter":8,"./env":9,"./logger":11,"./loginiframe":12,"./loginpopup":13,"./loginwindow":14,"./mvpdconfig":15,"./mvpdpicker":16,"./remembered":17,"./store":18,"./util":19,"./vendor/promise":21,"./vendor/underscore":23}],5:[function(require,module,exports){"use strict";var App=require("./app");var _=require("./vendor/underscore");var machina=require("./vendor/machina");var _logger=require("./logger");var MVPDPicker=require("./mvpdpicker");var Store=require("./store");var ClientAuthNFsm=machina.Fsm.extend({supports:{autoAuth:true},initialize:function(){_.bindAll(this,"onPickerOpened","onPickerClosed","requestAutoAuth");MVPDPicker.on("opened",this.onPickerOpened);MVPDPicker.on("closed",this.onPickerClosed);this.on("handling",function(data){_logger.debug("[ClientAuthNFsm:"+this.state+"] handling "+data.inputType)});this.on("handled",function(data){_logger.debug("[ClientAuthNFsm:"+this.state+"] handled "+data.inputType)});this.on("nohandler",function(data){_logger.debug("[ClientAuthNFsm:"+this.state+"] nohandler",data.inputType)});this.on("transition",function(data){_logger.debug("[ClientAuthNFsm:"+this.state+'] transition from "'+data.fromState+'" to "'+data.toState+'" via "'+data.action+'"')});this.on("invalidstate",function(){_logger.debug("[ClientAuthNFsm:"+this.state+"] invalidstate")});this.on("deferred",function(){_logger.debug("[ClientAuthNFsm:"+this.state+"] deferred")})},onPickerOpened:function(obj){_logger.debug("PICKER OPENED!");this.handle("pickerOpened",obj)},onPickerClosed:function(obj){_logger.debug("PICKER CLOSED!");this.handle("pickerClosed",obj)},allowsAutoAuth:false,autoAuthAttempts:0,autoAuthRetryDelay:0,autoAuthRetryDelayMax:1e4,autoAuthRetryLimit:0,autoAuthRetryLimitMax:8,autoAuthStoreKey:"cvp.auth.autoAuthAttempt",autoAuthStoreExpiry:6e4,autoauthRetryTimer:null,setAutoAuth:function(bool){this.allowsAutoAuth=bool},setAutoAuthMvpdId:function(mvpdId){this.autoAuthMvpdId=mvpdId},setAutoAuthRetryDelay:function(num){this.autoAuthRetryDelay=Math.min(Math.max(0,Number(num)||0),this.autoAuthRetryDelayMax)},setAutoAuthRetryLimit:function(num){this.autoAuthRetryLimit=Math.min(Math.max(0,Number(num)||0),this.autoAuthRetryLimitMax)},recordAutoAuthAttempt:function(){var localCount=this.autoAuthAttempts;var sessionCount=Store.supportsSessionStorage()?Number(Store.getSession(this.autoAuthStoreKey))||0:0;this.autoAuthAttempts=Math.max(localCount,sessionCount)+1;if(Store.supportsSessionStorage()){Store.setSession(this.autoAuthStoreKey,this.autoAuthAttempts,{expires:_.now()+this.autoAuthStoreExpiry})}},resetAutoAuthAttempt:function(){this.autoAuthAttempts=0;if(Store.supportsSessionStorage()){Store.removeSession(this.autoAuthStoreKey)}},canAttemptAutoAuth:function(){if(!this.allowsAutoAuth){_logger.debug("auto-auth is not enabled");return false}if(this.autoAuthAttempts>this.autoAuthRetryLimit){_logger.debug("auto-auth has attempted "+this.autoAuthAttempts+" times, meeting/exceeding the retry limit of "+this.autoAuthRetryLimit);return false}return true},requestCheckPreauthZ:function(resourceIds){_logger.log("requestCheckPreauthZ",resourceIds);this.authManager._checkPreauthZ(resourceIds)},requestCheckAuthN:function(){_logger.log("requestCheckAuthN");this.authManager._checkAuthN()},requestGetAuthN:function(redirectUrl){_logger.log("requestGetAuthN",redirectUrl);this.clearError();this.authManager._getAuthN(redirectUrl)},requestLogOut:function(){this.authManager._logout()},requestAutoAuth:function(){_logger.log("requestAutoAuth");this.recordAutoAuthAttempt();this.authManager._login(this.autoAuthMvpdId)},clearAttempt:function(){if(this.autoauthRetryTimer){window.clearTimeout(this.autoauthRetryTimer);this.autoauthRetryTimer=null}},retryAutoAuth:function(){_logger.log("retryAutoAuth with "+this.autoAuthRetryDelay+" ms delay");this.clearAttempt();this.autoauthRetryTimer=window.setTimeout(this.requestAutoAuth,this.autoAuthRetryDelay)},cancelAutoAuth:function(){_logger.log("cancelAutoAuth");this.clearAttempt();_logger.debug("reactivating Picker");MVPDPicker.reactivate()},initErrors:[],getInitErrors:function(){return this.initErrors.slice(0)},constraints:{Initialized:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}},BreakingAdobeAutoLogin:{nextState:"Authenticating",checkList:{hasErrorEvent:false,hasFlowEvent:false}},Authenticating:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}},UserLogIn:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}},UserLogOut:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}},AutoAuthing:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}},AutoLogOut:{nextState:"Unauthenticated",checkList:{hasErrorEvent:false,hasFlowEvent:false}}},isMoreSevereThanCurrentError:function(err){var errorCategory="errorCategory";var severityList=App.ErrorCategory.severity;if(errorCategory in err&&errorCategory in this._error&&_.isArray(severityList)){return _.indexOf(severityList,err.errorCategory)>_.indexOf(severityList,this._error.errorCategory)}return false},setError:function(err){if(!this._error||this.isMoreSevereThanCurrentError(err)){this._error=err}},clearError:function(){delete this._error},resetConstraints:function(){var state=this.state;var constraints=this.constraints&&this.constraints[state];if(!constraints){_logger.debug("[ClientAuthNFsm:"+this.state+'] no constraints for state "'+state+'"');return}if(!constraints.checkList){_logger.warn("[ClientAuthNFsm:"+this.state+'] no checkList in constraints for state "'+state+'"');return}_logger.debug("[ClientAuthNFsm:"+state+'] resetting constraints for state "'+state+'"');_.each(constraints.checkList,function(value,key,list){list[key]=false})},proceedIfAllConstraintsAreMet:function(){var state=this.state;var constraints=this.constraints[state];if(!constraints){_logger.debug("[ClientAuthNFsm:"+state+'] no constraints for state "'+state+'"');return}if(_.all(constraints.checkList,_.identity)){this.transition(constraints.nextState)}},initialState:"Uninitialized",states:{Uninitialized:{init:"Initializing"},Initializing:{ready:function(obj){this.transition("Initialized");this.emit("ready",obj)},error:function(obj){if(obj.errorCategory&&obj.errorCategory===App.ErrorCategory.BLOCKED){_logger.error("[ClientAuthNFsm:"+this.state+"] Error "+obj.errorCode+": Fatal error during auth init!");this.emit("initFailure",obj);this.transition("InitFailed")}else{_logger.debug("[ClientAuthNFsm:"+this.state+"] Error "+obj.errorCode+": Non-fatal error during auth init.");this.initErrors.push(obj)}},failure:function(obj){this.emit("initFailure",obj);this.transition("InitFailed")}},InitFailed:{_onEnter:function(){this.authManager.off("error",this.handleAuthError,this)}},Initialized:{_onEnter:function(){this.resetConstraints()},authNPass:function(obj){this._success=obj;this.transition("Authenticated")},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()},checkAuthN:function(){this.transition("Authenticating");this.requestCheckAuthN()},getAuthN:function(redirectUrl){this.transition("Authenticating");this.requestGetAuthN(redirectUrl)},invalidProvider:function(){this.authManager.selectProvider(null)}},Unauthenticated:{_onEnter:function(){if(!this._error){_logger.warn("Unauthenticated but we do not know how/why");return}if(!this.isSwitchingProviders){if(this.canAttemptAutoAuth()&&!MVPDPicker.isOpen()){_logger.debug("[ClientAuthNFsm:"+this.state+"] Can auto-auth!");this.transition("AutoAuthing")}else{this.emit("authNFail",this._error)}}this.clearError()},authNPass:function(obj){this._success=obj;this.transition("Authenticated")},checkAuthN:function(){this.transition("Authenticating");this.requestCheckAuthN()},getAuthN:function(redirectUrl){this.isSwitchingProviders=false;this.redirectUrlForGetAuthN=redirectUrl;this.transition("BreakingAdobeAutoLogin")},invalidProvider:"AutoLogOut"},BreakingAdobeAutoLogin:{_onEnter:function(){this.resetConstraints();this.authManager.selectProvider(null)},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){if(obj.errorCode==="N005"){this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()}},_onExit:function(){this.requestGetAuthN(this.redirectUrlForGetAuthN);delete this.redirectUrlForGetAuthN}},Authenticating:{_onEnter:function(){this.resetConstraints()},pickerOpened:"UserLogIn",authNPass:function(obj){this._success=obj;this.transition("Authenticated")},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()},invalidProvider:"AutoLogOut",logout:"UserLogOut"},UserLogIn:{_onEnter:function(){this.resetConstraints()},pickerClosed:"Authenticating",authNPass:function(obj){this._success=obj;this.transition("Authenticated")},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()},getAuthN:function(){this.deferUntilTransition("Unauthenticated");this.authManager.selectProvider(null)},invalidProvider:"AutoLogOut"},UserLogOut:{_onEnter:function(){this.resetConstraints();this.requestLogOut()},authNPass:function(obj){this._success=obj;this.transition("Authenticated")},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()}},Authenticated:{_onEnter:function(){if(!this._success){_logger.warn("Authenticated but we do not know how/why");return}this.emit("authNPass",this._success);delete this._success;this.resetAutoAuthAttempt()},error:function(obj){this.setError(obj);this.transition("Unauthenticated")},checkPreauthZ:function(resourceIds){this.requestCheckPreauthZ(resourceIds)},checkAuthN:function(){this.transition("Authenticating");this.requestCheckAuthN()},getAuthN:function(){this.deferUntilTransition("Unauthenticated");this.isSwitchingProviders=true;this.authManager.selectProvider(null)},invalidProvider:"AutoLogOut",logout:"UserLogOut"},AutoAuthing:{_onEnter:function(){this.resetConstraints();this.requestAutoAuth()},authNPass:function(obj){if(obj.mvpdId===this.autoAuthMvpdId){_logger.debug("[AutoAuth:"+this.state+'] Logged in with "'+this.autoAuthMvpdId+'"!')}else{_logger.debug("[AutoAuth:"+this.state+"] Logged in with a provider.")}this._success=obj;this.transition("Authenticated")},authNFail:function(){if(this.canAttemptAutoAuth()){_logger.debug("[AutoAuth:"+this.state+'] Retrying auto-auth with "'+this.autoAuthMvpdId+'".');this.resetConstraints();this.retryAutoAuth()}else{_logger.warn("[AutoAuth:"+this.state+'] Unable to auto-auth with "'+this.autoAuthMvpdId+'" because of too many attempts.');this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()}},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()},invalidProvider:"AutoLogOut",_onExit:function(){this.cancelAutoAuth()}},AutoLogOut:{_onEnter:function(){this.resetConstraints();this.requestLogOut()},authNPass:function(obj){this._success=obj;this.transition("Authenticated")},authNFail:function(){this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){this.setError(obj);this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()}}},init:function(AuthManager){if(!AuthManager){throw new Error("AuthManager required for init!")}this.authManager=AuthManager;this.authManager.on("error",this.handleAuthError,this);this.handle("init")},handleInitReady:function(obj){this.handle("ready",obj)},handleInitFailure:function(obj){this.handle("failure",obj)},handleAuthNPass:function(obj){this.handle("authNPass",obj)},handleAuthNFail:function(obj){this.handle("authNFail",obj)},handleInvalidProvider:function(obj){this.handle("invalidProvider",obj)},checkPreauthZ:function(resourceIds){this.handle("checkPreauthZ",resourceIds)},checkAuthN:function(){this.handle("checkAuthN")},getAuthN:function(redirectUrl){this.handle("getAuthN",redirectUrl)},logout:function(){this.handle("logout")},ignoredErrorCodes:["P100","N001","N010","N011","N120","CFG100"],handleAuthError:function(obj){var errData=obj.data;var data={};data.errorCode=errData.errorCode||errData.errorId;if(errData.message){data.errorString=errData.message}if(errData.messageHtml){data.errorHtml=errData.messageHtml}if(errData.errorCategory){data.errorCategory=errData.errorCategory}if(errData.resolution){data.resolution=errData.resolution}if(this.state==="Initializing"){this.handle("error",data)}else{var errorId=errData.errorId;if(obj.source==="adobe"&&errorId.charAt(0)==="Z"){_logger.debug("Ignoring authZ error "+errorId);return}else if(errorId.indexOf("DRM")===0&&this.state==="Authenticated"){_logger.debug("Ignoring DRM error "+errorId);return}else{if(errorId==="N100"||errorId==="N110"){_logger.debug("Error "+errorId+": Expired authN; logging out user.");this.requestLogOut();return}if(_.contains(this.ignoredErrorCodes,errorId)){_logger.debug("Ignoring authN error "+errorId)}else{this.authManager.getProviderID(function getProviderIDResponse(providerId){data.mvpdId=providerId;this.handle("error",data)},this)}}}}});module.exports=ClientAuthNFsm},{"./app":2,"./logger":11,"./mvpdpicker":16,"./store":18,"./vendor/machina":20,"./vendor/underscore":23}],6:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var machina=require("./vendor/machina");var _logger=require("./logger");var ClientAuthZFsm=machina.Fsm.extend({initialize:function(){_.bindAll(this,"checkAuthZ");this.on("handling",function(data){_logger.debug("[ClientAuthZFsm:"+this.state+"] handling "+data.inputType)});this.on("handled",function(data){_logger.debug("[ClientAuthZFsm:"+this.state+"] handled "+data.inputType)});this.on("nohandler",function(data){_logger.debug("[ClientAuthZFsm:"+this.state+"] nohandler",data.inputType)});this.on("transition",function(data){_logger.debug("[ClientAuthZFsm:"+this.state+'] transition from "'+data.fromState+'" to "'+data.toState+'" via "'+data.action+'"')});this.on("invalidstate",function(){_logger.debug("[ClientAuthZFsm:"+this.state+"] invalidstate")});this.on("deferred",function(){_logger.debug("[ClientAuthZFsm:"+this.state+"] deferred")})},constraints:{Authorizing:{nextState:"Ready",checkList:{hasErrorEvent:false,hasFlowEvent:false}}},resetConstraints:function(){var state=this.state;switch(state){case"Authorizing":_logger.debug("[ClientAuthZFsm:"+state+'] resetting constraints for state "'+state+'"');_.each(this.constraints[state].checkList,function(constraint,i,list){list[i]=false});break;default:_logger.debug("[ClientAuthZFsm:"+this.state+'] no constraints to reset for state "'+state+'"')}},proceedIfAllConstraintsAreMet:function(){var state=this.state;var constraints=this.constraints[state];if(!constraints){_logger.debug("[ClientAuthZFsm:"+state+'] no constraints for state "'+state+'"');return}if(_.all(constraints.checkList,_.identity)){this.transition(constraints.nextState)}},initialState:"Offline",states:{Offline:{ready:"Ready"},Ready:{checkAuthZ:function(resourceId,feature){this.resourceId=resourceId;this.feature=feature;this.transition("Authorizing");this.authManager._checkAuthZ(resourceId,feature)}},Authorizing:{_onEnter:function(){this.resetConstraints()},authZPass:function(obj){_logger.debug("Received authz success flow event");this.emit("authZPass",obj);this.transition("Ready")},authZFail:function(){_logger.debug("Received authz failure flow event");this.constraints[this.state].checkList.hasFlowEvent=true;this.proceedIfAllConstraintsAreMet()},error:function(obj){_logger.debug("Received authz failure error event");this._error=obj;this.constraints[this.state].checkList.hasErrorEvent=true;this.proceedIfAllConstraintsAreMet()},_onExit:function(){if(this._error){this.emit("authZFail",this._error);this._error=null}}}},checkAuthZ:function(resourceId,feature){if(!arguments.length){resourceId=this.resourceId;feature=this.feature}this.handle("checkAuthZ",resourceId,feature)},handleInitReady:function(){this.handle("ready")},handleAuthZPass:function(obj){this.handle("authZPass",obj)},handleAuthZFail:function(obj){this.handle("authZFail",obj)},ignoredErrorCodes:["P100","N001","N010","N011","N120","Z010","Z011","CFG100"],handleAuthError:function(obj){var errData=obj.data;var errorId=errData.errorId;if(_.contains(this.ignoredErrorCodes,errorId)){_logger.debug("Ignoring authZ error "+errorId)}else{this.authManager.getProviderID(function getProviderIDResponse(providerId){var data={};data.mvpdId=providerId;data.resource=this.resourceId;data.errorCode=errData.errorCode||errData.errorId;if(errData.message){data.errorString=errData.message}if(errData.messageHtml){data.errorHtml=errData.messageHtml}if(errData.errorCategory){data.errorCategory=errData.errorCategory}if(errData.resolution){data.resolution=errData.resolution}this.handle("error",data)},this)}},init:function(AuthManager){if(!AuthManager){throw new Error("AuthManager required for init!")}this.authManager=AuthManager;this.authManager.on("initReady",this.handleInitReady,this);this.authManager.on("error",this.handleAuthError,this)}});module.exports=ClientAuthZFsm},{"./logger":11,"./vendor/machina":20,"./vendor/underscore":23}],7:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var Util=require("./util");function create(tag){return document.createElement(tag)}function id(elId){return document.getElementById(elId)}function tags(tagName,root){root=root||document;return _.toArray(root.getElementsByTagName(tagName))}function classes(className){return _.toArray(document.getElementsByClassName(className))}function all(selector,root){root=root||document;return _.toArray(root.querySelectorAll(selector))}function one(selector,root){root=root||document;return root.querySelector(selector)}function text(el,content){var prop="textContent"in el?"textContent":"innerText";if(arguments.length===1){return el[prop]}el[prop]=content;return el[prop]}function html(el,content){if(arguments.length===1){return el.innerHTML}el.innerHTML=content;return el.innerHTML}function ifNodeIsThis(node){return node===this}function matchesSelector(selector){return _.some(all(selector,this),_.bind(ifNodeIsThis,this))}function matches(el,selector){var fn=el.matches||el.matchesSelector||el.webkitMatchesSelector||el.msMatchesSelector||el.mozMatchesSelector||el.oMatchesSelector||matchesSelector;return fn.call(el,selector)}function ifNodeIsElement(node){return node!==null&&node.nodeType===1}function ifNodeIsElementAndMatches(node,selector){return ifNodeIsElement(node)&&(!selector||matches(node,selector))}function children(el,selector){var childNodes=_.toArray(el.children);if(!selector){return _.filter(childNodes,ifNodeIsElement)}return _.filter(childNodes,function(node){return ifNodeIsElementAndMatches(node,selector)})}function next(el,selector){var node=el.nextSibling;if(ifNodeIsElementAndMatches(node,selector)){return node}return next(node,selector)}function nextAll(el,selector){var siblings=[];while(el.nextSibling){el=el.nextSibling;if(ifNodeIsElementAndMatches(el,selector)){siblings.push(el)}}return siblings}function prev(el,selector){var node=el.previousSibling;if(ifNodeIsElementAndMatches(node,selector)){return node}return prev(node)}function prevAll(el,selector){var siblings=[];while(el.previousSibling){el=el.previousSibling;if(ifNodeIsElementAndMatches(el,selector)){siblings.push(el)}}return siblings}var whitespaceRegex=/\s+/;var ProtoArray=Array.prototype;var __push=ProtoArray.push;var __join=ProtoArray.join;var __splice=ProtoArray.splice;var __indexOf=ProtoArray.indexOf||function(item){for(var i=0,l=this.length;i<l;i+=1){
if(this[i]===item){return i}}return-1};function ClassList(el){this._element=el;if(el.className!==this._classCache){this._classCache=el.className;if(!this._classCache){return}var classes=_.uniq(Util.trim(this._classCache).split(whitespaceRegex));for(var i=0,endi=classes.length;i<endi;i+=1){__push.call(this,classes[i])}}}var ClassListProto=ClassList.prototype=[];ClassListProto._updateClassName=function(){this._element.className=this.toString()};ClassListProto._indexOf=function(token){return __indexOf.call(this,token)};ClassListProto.item=function(index){return this[index]||null};ClassListProto.contains=function(token){return this._indexOf(token)!==-1};ClassListProto.add=function(token){if(this.contains(token)){return}__push.call(this,token);this._updateClassName()};ClassListProto.remove=function(token){var i=this._indexOf(token);if(i===-1){return}__splice.call(this,i,1);this._updateClassName()};ClassListProto.toString=function(){return __join.call(this," ")};ClassListProto.toggle=function(token){if(this.contains(token)){this.remove(token)}else{this.add(token)}return this.contains(token)};function classList(el){return"classList"in el?el.classList:new ClassList(el)}function contains(ancestor,descendant){return ancestor.contains(descendant)}function parent(el){return el.parentNode}function siblings(el){var parentNode=parent(el);var siblingNodes=[];if(parentNode){siblingNodes=children(parentNode);siblingNodes=_.reject(siblingNodes,_.bind(ifNodeIsThis,el))}return siblingNodes}function attr(el,key,val){if(arguments.length===2){return el.getAttribute(key)}if(val===null){return el.removeAttribute(key)}return el.setAttribute(key,val)}function append(child,parent){parent=parent||document.body;return parent.appendChild(child)}function display(el,show){if(show){var prevDisplay=attr(el,"data-prevDisplay");el.style.display=prevDisplay===null?"block":prevDisplay}else{var currDisplay=el.style.display;if(currDisplay!=="none"){attr(el,"data-prevDisplay",currDisplay)}el.style.display="none"}return el}function hide(el){return display(el,false)}function show(el){return display(el,true)}function documentWidth(){return Math.max(document.documentElement.clientWidth||0,document.body.clientWidth||0)}function documentHeight(){return Math.max(document.documentElement.clientHeight||0,document.body.clientHeight||0)}function viewportWidth(){return typeof window.innerWidth==="number"?window.innerWidth:document.documentElement.clientWidth}function viewportHeight(){return typeof window.innerHeight==="number"?window.innerHeight:document.documentElement.clientHeight}function scrollLeft(){return Math.max(window.pageXOffset||0,document.documentElement.scrollLeft||0,document.body.scrollLeft||0)}function scrollTop(){return Math.max(window.pageYOffset||0,document.documentElement.scrollTop||0,document.body.scrollTop||0)}function getStyle(el,prop){if("getComputedStyle"in window){return window.getComputedStyle(el,null).getPropertyValue(prop)}if("currentStyle"in el){return el.currentStyle[prop]}}function center(domElement){if(_.isString(domElement)){domElement=id(domElement)}if(!domElement){return}var isFixed=getStyle(domElement,"position")==="fixed";var domElemStyle=domElement.style;var elementWidth=0;var elementHeight=0;var leftOffset=0;var topOffset=0;var scrolledX=isFixed?0:scrollLeft();var scrolledY=isFixed?0:scrollTop();var viewportX=viewportWidth();var viewportY=viewportHeight();elementWidth=getStyle(domElement,"width");elementHeight=getStyle(domElement,"height");if(elementWidth===undefined){if("offsetWidth"in domElement){elementWidth=domElement.offsetWidth}else{elementWidth=domElemStyle.width}}if(elementHeight===undefined){if("offsetHeight"in domElement){elementHeight=domElement.offsetHeight}else{elementHeight=domElemStyle.height}}elementWidth=Util.toInt(elementWidth);elementHeight=Util.toInt(elementHeight);leftOffset=scrolledX;topOffset=scrolledY;if(viewportX>elementWidth){leftOffset=scrolledX+(viewportX-elementWidth)/2}if(viewportY>elementHeight){topOffset=scrolledY+(viewportY-elementHeight)/2}domElemStyle.top=String(Math.round(topOffset))+"px";domElemStyle.left=String(Math.round(leftOffset))+"px"}function remove(element){while(element.firstChild){element.removeChild(element.firstChild)}if(element.parentNode){element.parentNode.removeChild(element)}}function decodeHtml(encodedHtml){var res={};var encodedRegex=/\&(\#|lt|gt|amp)/;var root="implementation"in document&&"createHTMLDocument"in document.implementation?document.implementation.createHTMLDocument("").body:document.createElement("div");html(root,encodedHtml);if(encodedRegex.test(encodedHtml)){html(root,text(root))}_.each(all("script, style, img, object, iframe",root),remove);res.html=html(root);res.text=text(root);return res}function on(element,type,handler){element.addEventListener(type,handler,false)}function off(element,type,handler){element.removeEventListener(type,handler,false)}var ready=function(){var listeners=[];var doc=document;var win=window;var domContentLoaded="DOMContentLoaded";var windowLoad="load";var loaded=/^(?:loaded|complete)$/.test(doc.readyState);function execReadyListener(fn){setTimeout(fn,0)}function whenReady(){var fn;off(doc,domContentLoaded,whenReady);off(win,windowLoad,whenReady);loaded=1;while(fn=listeners.shift()){execReadyListener(fn)}}if(!loaded){on(doc,domContentLoaded,whenReady);on(win,windowLoad,whenReady)}return function(fn){loaded?execReadyListener(fn):listeners.push(fn)}}();var JSONP=function(){var SCRIPT="script";var doc=window.document;var noop=Function.prototype;function _JSONP(opts){var data=opts.data||{};var callbackParam=opts.callbackParam;var callbackName=opts.callbackName||"__jsonp_"+Date.now();var success=opts.success||noop;var failure=opts.failure||noop;if(callbackParam){data[callbackParam]=callbackName}var url=Util.augmentQueryString(opts.url,data);var first=doc.getElementsByTagName(SCRIPT)[0];var script=doc.createElement(SCRIPT);var overwritten=window[callbackName];function teardown(){script.onerror=null;remove(script);script=null;if(overwritten==null){delete window[callbackName]}else{window[callbackName]=overwritten}}function onLoad(data){success(data);teardown()}function onError(){failure();teardown()}window[callbackName]=onLoad;script.async=true;script.src=url;script.onerror=onError;first.parentNode.insertBefore(script,first)}return _JSONP}();exports.JSONP=JSONP;exports.on=on;exports.off=off;exports.ready=ready;exports.create=create;exports.id=id;exports.tags=tags;exports.classes=classes;exports.all=all;exports.one=one;exports.text=text;exports.html=html;exports.matches=matches;exports.children=children;exports.next=next;exports.nextAll=nextAll;exports.prev=prev;exports.prevAll=prevAll;exports.classList=classList;exports.contains=contains;exports.parent=parent;exports.siblings=siblings;exports.attr=attr;exports.append=append;exports.hide=hide;exports.show=show;exports.documentWidth=documentWidth;exports.documentHeight=documentHeight;exports.viewportWidth=viewportWidth;exports.viewportHeight=viewportHeight;exports.scrollLeft=scrollLeft;exports.scrollTop=scrollTop;exports.getStyle=getStyle;exports.center=center;exports.remove=remove;exports.decodeHtml=decodeHtml},{"./util":19,"./vendor/underscore":23}],8:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var _logger=require("./logger");function EventEmitter(){this._events={}}var slice=_.toArray;var isArray=_.isArray;var now=_.now;function indexOf(list,fn,context){for(var i=0,endi=list.length;i<endi;i+=1){if(list[i].fn===fn&&list[i].context===context){return i}}return-1}function throwException(e){return function(){throw e}}function emitEvent(type,data,event){var eventQ=slice(this._events[type]||[]);var eventName=event||type;for(var obj,i=0,endi=eventQ.length;i<endi;i+=1){obj=eventQ[i];try{if(isArray(data)&&obj.options&&obj.options.apply){obj.fn.apply(obj.context,data)}else{if(obj.options&&obj.options.once){this.off(eventName,obj.fn,obj.context)}obj.fn.call(obj.context,data,{target:obj.context,type:eventName,timeStamp:now()})}}catch(e){_logger.error('exception thrown from handler of "'+eventName+'" event (check e.stack or obj.fn to see what function threw the exception)',e);if("stack"in e){_logger.error(e.stack)}window.setTimeout(throwException(e),0)}}}var mixinPrototype={on:function on(event,fn,context,options){if(typeof fn!=="function"){_logger.error('A callback function was not provided to listen to the event "'+event+'".');return this}context=context||this;var events=this._events=this._events||{};var eventQ=events[event]||(events[event]=[]);if(indexOf(eventQ,fn,context)===-1){eventQ.push({fn:fn,context:context,options:options})}return this},once:function once(event,fn,context,options){if(typeof fn!=="function"){_logger.error('A callback function was not provided to listen to the event "'+event+'" once.');return this}context=context||this;options=options||{};options.once=true;return this.on(event,fn,context,options)},off:function off(event,fn,context){var events=this._events;if(!(event in events)){_logger.warn('The provided callback function was not listening to the event "'+event+'".');return this}context=context||this;var eventQ=events[event];var fnIndex=indexOf(eventQ,fn,context);if(fnIndex!==-1){eventQ.splice(fnIndex,1);if(eventQ.length===0){delete events[event]}}return this},emit:function emit(event,data){emitEvent.call(this,event,data);emitEvent.call(this,"*",data,event);return this}};EventEmitter.mixin=function mixin(obj){for(var method in mixinPrototype){obj[method]=mixinPrototype[method]}this.apply(obj);return obj};EventEmitter.prototype=mixinPrototype;module.exports=EventEmitter},{"./logger":11,"./vendor/underscore":23}],9:[function(require,module,exports){"use strict";var App=require("./app");var _=require("./vendor/underscore");var Util=require("./util");var Dom=require("./dom");var Promise=require("./vendor/promise");var _logger=require("./logger");var MVPDConfig=require("./mvpdconfig");var supports={};var queryParams=Util.parseQueryString(window.location.search);function getConfigOverrideParam(){var authConfigEnv="authConfigEnv"in queryParams?queryParams.authConfigEnv:null;return authConfigEnv&&_.contains(App.configEnvOptions,authConfigEnv)?authConfigEnv:null}function getVendorOverrideParam(){return"authVendorEnv"in queryParams?queryParams.authVendorEnv:null}var msEdgeRegex=/\bEdge\/\d+\./;var msIERegex=/\bTrident\/\d+\./;var ua=navigator.userAgent||"";var isEdge=msEdgeRegex.test(ua);var isIE=msIERegex.test(ua);var requiresIframeLogin=isIE||isEdge;var falseyRegex=/false|no|off/i;supports.retina=Number(window.devicePixelRatio)>=2;supports.handleRedirect="forceHandleRedirect"in queryParams?!falseyRegex.test(queryParams.forceHandleRedirect):true;supports.popup="forcePopup"in queryParams?!falseyRegex.test(queryParams.forcePopup):!requiresIframeLogin;supports.refreshlessLogin="forceRefreshlessLogin"in queryParams?!falseyRegex.test(queryParams.forceRefreshlessLogin):true;supports.refreshlessLogout="forceRefreshlessLogout"in queryParams?!falseyRegex.test(queryParams.forceRefreshlessLogout):true;function determineLoginType(){var IFRAME="iframe",POPUP="popup",type=exports.supports.popup?POPUP:IFRAME;return type}var geoPromise;var geoJsonpCallback="cvp_onGeolocationReceived";function fetchCountryCode(){if(geoPromise)return geoPromise;geoPromise=new Promise(function geoPromiseResolver(resolve){function onGeolocationSuccess(res){_logger.debug("geolocation success");var code=App.UNKNOWN_COUNTRY;if(_.isObject(res)&&_.isString(res.country)){code=res.country}resolve(code)}function onGeolocationFailure(){_logger.warn("geolocation failure");resolve(App.UNKNOWN_COUNTRY)}var geoServiceUrl=MVPDConfig.getGeoServiceUrl();if(!geoServiceUrl){_logger.warn("No geolocation service URL provided.");onGeolocationFailure();return}Dom.JSONP({url:geoServiceUrl,callbackParam:"callback",callbackName:geoJsonpCallback,success:onGeolocationSuccess,failure:onGeolocationFailure})});return geoPromise}exports.queryParams=queryParams;exports.getVendorOverrideParam=getVendorOverrideParam;exports.getConfigOverrideParam=getConfigOverrideParam;exports.supports=supports;exports.determineLoginType=determineLoginType;exports.fetchCountryCode=fetchCountryCode},{"./app":2,"./dom":7,"./logger":11,"./mvpdconfig":15,"./util":19,"./vendor/promise":21,"./vendor/underscore":23}],10:[function(require,module,exports){var AuthManager=require("./authmanager");window.CVP=window.CVP||{};window.CVP.AuthManager=AuthManager;module.exports=AuthManager},{"./authmanager":4}],11:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var from=_.toArray;var includes=_.includes;var assign=_.assign;function repeat(string,count){return Array(count+1).join(string)}var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return from(arr)}}var allQuotes=/"/g;var escapedQuote='\\"';var integerPattern=/^\d+$/;var identifierPattern=/^[a-zA-Z_][a-zA-Z_0-9]*$/;var ellipses="…";var hasOwnProp_=Object.prototype.hasOwnProperty;var hasOwn=function hasOwn(obj,key){return hasOwnProp_.call(obj,key)};var toString=Function.prototype.call.bind(Object.prototype.toString);var getObjectType=function getObjectType(value){return toString(value).slice(8,-1)};var formatString=function formatString(value){return'"'+value.replace(allQuotes,escapedQuote)+'"'};var formatPrimitive=function formatPrimitive(value){return""+value};var formatError=function formatError(value){return"{"+Error.prototype.toString.call(value)+"}"};var formatFunction=function formatFunction(value){return"(Function"+(value.name?" "+value.name:"")+")"};var formatRegExp=Function.prototype.call.bind(RegExp.prototype.toString);var formatDate=Function.prototype.call.bind(Date.prototype.toString);var formatElement=function formatElement(value){return"<"+(value.nodeName?value.nodeName+(value.id?"#"+value.id:"")+(value.classList.length?"."+[].concat(_toConsumableArray(value.classList)).join("."):""):"")+"/>"};function formatProperty(ctxt,value,depth,key,isArray){var str="";var name=key.match(identifierPattern)?key:formatString(key);var desc={value:undefined};try{desc=Object.getOwnPropertyDescriptor(value,key)}catch(e){try{desc.value=value[key]}catch(e){}}if(desc.get&&desc.set){str="[Getter/Setter]"}else{if(desc.get){str="[Getter]"}if(desc.set){str="[Setter]"}}if(!str){str=includes(ctxt.seen,desc.value)?"[Circular]":formatValue(ctxt,desc.value,depth-1)}return isArray&&key.match(integerPattern)?str:name+": "+str}function formatObject(ctxt,object,depth,keys){var output=[];var length=keys.length;var maxNumProperties=Math.min(Math.max(0,ctxt.maxObjectProperties),keys.length);var remainingProps=length-maxNumProperties;output.push.apply(output,_toConsumableArray(keys.slice(0,maxNumProperties).map(function(key){return formatProperty(ctxt,object,depth,key,false)})));if(remainingProps>0){output.push(ellipses+" "+remainingProps+" more item"+(remainingProps===1?"":"s"))}return output}var isNonIntegerKey=function isNonIntegerKey(key){return(typeof key==="undefined"?"undefined":_typeof(key))==="symbol"||!key.match(integerPattern)};function formatArray(ctxt,array,depth,keys){var output=[];var length=array.length;var maxLength=Math.min(Math.max(0,ctxt.maxArrayLength),length);var remaining=length-maxLength;for(var key,value,i=0,endi=maxLength;i<endi;++i){key=String(i);value="";if(hasOwn(array,key)){value=formatProperty(ctxt,array,depth,key,true)}output.push(value)}if(remaining>0){output.push(ellipses+" "+remaining+" more item"+(remaining===1?"":"s"))}output.push.apply(output,_toConsumableArray(keys.filter(isNonIntegerKey).map(function(key){return formatProperty(ctxt,array,depth,key,true)})));return output}function reduceToSingleString(output,base,braces,breakLength){var level=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var length=output.reduce(function(prev,curr){return prev+curr.length+1},0);var indent=level?repeat("  ",level):"";return indent+(length>breakLength?braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  "+indent)+" "+braces[1]:braces[0]+base+(output.length?" "+output.join(", ")+" ":"")+braces[1])}function formatValue(ctxt,value,depth){if(depth<0)return ellipses;if(value===ellipses)return ellipses;var type=typeof value==="undefined"?"undefined":_typeof(value);if(type==="string")return formatString(value);if(value==null||type!=="function"&&type!=="object")return formatPrimitive(value);if(value instanceof Window)return"{Window"+(window.name?" "+window.name:"")+"}";if(value instanceof Document)return"{Document}";if(value instanceof Element)return formatElement(value);var objType=getObjectType(value);var isArray=false;var string=void 0;var base="";switch(objType){case"Array":base=objType+"["+value.length+"]";isArray=true;break;case"Date":return formatDate(value);case"Error":return formatError(value);case"Function":return formatFunction(value);case"RegExp":return formatRegExp(value);case"Arguments":base=objType+"["+value.length+"]";isArray=true;value=from(value);break;case"Object":try{string=JSON.stringify(value)}catch(e){string=""}if(string!==""&&string!=="{}")return string;break;default:base=""+objType}var keys=Object.keys(value);ctxt.seen.push(value);var output=isArray?formatArray(ctxt,value,depth,keys):formatObject(ctxt,value,depth,keys);ctxt.seen.pop();var braces=isArray?["[","]"]:["{","}"];return reduceToSingleString(output,base,braces,ctxt.breakLength,ctxt.depth-depth)}var stringifyDefaultOptions={depth:2,maxArrayLength:20,maxObjectProperties:20,breakLength:60};function stringify(obj){var ctxt={seen:[]};ctxt=assign(ctxt,stringifyDefaultOptions);return formatValue(ctxt,obj,ctxt.depth)}var Levels={NONE:100,ERROR:300,WARN:400,INFO:500,DEBUG:600,LOG:700,ALL:900};var logLevel=Levels.WARN;function setLevel(level){level=level.toUpperCase();logLevel=level in Levels?Levels[level]:/NO|NONE|OFF|SILENT|QUIET/.test(level)?Levels.NONE:Levels.ALL;return logLevel}var debugRegex=/\bdmtdebug=(\w+)/;var debugMatch=debugRegex.exec(window.location.href);if(!debugMatch&&window!==window.top){try{debugMatch=debugRegex.exec(window.top.location.href)}catch(e){}}if(debugMatch){setLevel(debugMatch[1])}function isFunction(obj){return typeof obj==="function"}var supportsConsole="console"in window&&"log"in window.console&&isFunction(window.console.log);var noop=Function.prototype;var consoleAdapter=supportsConsole?{log:console.log.bind(console),debug:isFunction(window.console.debug)?console.debug.bind(console):this.log,info:isFunction(window.console.info)?console.info.bind(console):this.log,warn:isFunction(window.console.warn)?console.warn.bind(console):this.log,error:isFunction(window.console.error)?console.error.bind(console):this.log}:{log:noop,debug:noop,info:noop,warn:noop,error:noop};function log(api,level){if(logLevel<level)return;for(var _len=arguments.length,msg=Array(_len>2?_len-2:0),_key=2;_key<_len;_key++){msg[_key-2]=arguments[_key]}var text=msg.map(stringify).join(" ");consoleAdapter[api](text)}module.exports={log:log.bind(undefined,"log",Levels.LOG),debug:log.bind(undefined,"debug",Levels.DEBUG),info:log.bind(undefined,"info",Levels.INFO),warn:log.bind(undefined,"warn",Levels.WARN),error:log.bind(undefined,"error",Levels.ERROR),setLevel:setLevel}},{"./vendor/underscore":23}],12:[function(require,module,exports){"use strict";var App=require("./app");var _logger=require("./logger");var SimpleEmitter=require("./emitter");var _=require("./vendor/underscore");var Dom=require("./dom");var backdropId="mvpdbackdrop";var iframeContainerId="mvpddiv";var iframeId=App.ADOBE_IFRAME_NAME;var isOpened=false;var backdropEl=null;var iframeContainerEl=null;var iframeEl=null;var closeButtonEl=null;var backdropDefaultStyle={position:"fixed",top:"0px",left:"0px",backgroundColor:"#000",width:"100%",height:"100%",opacity:"0.4",zIndex:"2999",filter:"alpha(opacity=40)"};var iframeContainerDefaultStyle={position:"absolute",top:"50px",margin:"0",backgroundColor:"white",borderRadius:"4px",boxShadow:"4px 4px 8px #111",zIndex:"3000"};var iframeDefaultStyle={frameborder:"0",border:"0"};var closeButtonDefaultStyle={backgroundImage:'url("http://z.cdn.turner.com/xslo/cvp/js/cvp.auth/close.png")',backgroundRepeat:"no-repeat",zIndex:"3001",position:"absolute",top:"3px",right:"3px",width:"54px",height:"14px",cursor:"pointer"};var recenterIFrameContainer;var debouncedRecenter;function createRecenterFn(el){return _.bind(Dom.center,Dom,el)}var dimensionStyle={};function createDimensionStyle(widthStr,heightStr){return{width:widthStr+"px",height:heightStr+"px"}}var emitter=new SimpleEmitter;function create(config,options){if(options.width&&options.height){dimensionStyle=createDimensionStyle(options.width.toString(),options.height.toString())}backdropEl=Dom.id(backdropId);if(backdropEl){_logger.debug("LoginIframe",'Unexpected presence of DOM element with ID "'+backdropId+'".')}else{backdropEl=Dom.create("div");Dom.attr(backdropEl,"id",backdropId);_.extend(backdropEl.style,backdropDefaultStyle);Dom.append(backdropEl)}backdropEl.onclick=null;Dom.show(backdropEl);iframeContainerEl=Dom.id(iframeContainerId);if(iframeContainerEl){_logger.debug("LoginIframe",'Unexpected presence of DOM element with ID "'+iframeContainerId+'".')}else{iframeContainerEl=Dom.create("div");Dom.attr(iframeContainerEl,"id",iframeContainerId);if(_.isString(config.iframeStyleOverride)){iframeContainerEl.className=config.iframeStyleOverride}else{_.extend(iframeContainerEl.style,iframeContainerDefaultStyle,dimensionStyle)}Dom.hide(iframeContainerEl);recenterIFrameContainer=createRecenterFn(iframeContainerEl);debouncedRecenter=_.debounce(recenterIFrameContainer,250);Dom.on(window,"resize",debouncedRecenter);Dom.on(window,"orientationchange",debouncedRecenter);iframeEl=Dom.id(iframeId);if(iframeEl){_logger.debug("LoginIframe",'Unexpected presence of DOM element with ID "'+iframeId+'".')}else{iframeEl=Dom.create("iframe");_.extend(iframeEl.style,iframeDefaultStyle,dimensionStyle);iframeEl.name=iframeId;iframeEl.id=iframeId;iframeEl.scrolling="no";Dom.append(iframeEl,iframeContainerEl)}closeButtonEl=Dom.create("span");if(_.isString(config.closeButtonStyleOverride)){closeButtonEl.className=config.closeButtonStyleOverride}else{_.extend(closeButtonEl.style,closeButtonDefaultStyle)}closeButtonEl.onclick=emitter.close;Dom.append(closeButtonEl,iframeContainerEl);Dom.append(iframeContainerEl);try{window.frames[iframeId].name=iframeId}catch(e){_logger.debug("LoginIframe",'Failed to force the name of the "'+iframeId+'" iframe into the DOM.')}}}function destroy(){if(backdropEl){Dom.remove(backdropEl);backdropEl=null}if(closeButtonEl){closeButtonEl.onclick=null;Dom.remove(closeButtonEl);closeButtonEl=null}if(iframeEl){Dom.remove(iframeEl);iframeEl=null;try{delete window.frames[iframeId]}catch(e){}}if(iframeContainerEl){Dom.remove(iframeContainerEl);iframeContainerEl=null}if(debouncedRecenter){Dom.off(window,"resize",debouncedRecenter);Dom.off(window,"orientationchange",debouncedRecenter);debouncedRecenter=null}recenterIFrameContainer=null}function open(config,options){if(isOpened){return}if(!backdropEl||!iframeContainerEl||!iframeEl){destroy();create(config,options)}Dom.show(backdropEl);recenterIFrameContainer();Dom.show(iframeContainerEl);isOpened=true;emitter.emit("opened")}function close(){if(!isOpened){return}Dom.hide(iframeContainerEl);destroy();isOpened=false;emitter.emit("closed")}function setSrc(url){if(iframeEl){iframeEl.src=url}}_.extend(emitter,{isOpened:function(){return isOpened},isClosed:function(){return!isOpened},open:open,close:close,setSrc:setSrc});module.exports=emitter},{"./app":2,"./dom":7,"./emitter":8,"./logger":11,"./vendor/underscore":23}],13:[function(require,module,exports){"use strict";var App=require("./app");var _logger=require("./logger");var SimpleEmitter=require("./emitter");var WindowWatcher=require("./windowwatcher");var Dom=require("./dom");var loginPopup=new WindowWatcher(App.ADOBE_IFRAME_NAME);function onOpened(){_logger.log("LoginPopup - onOpened");this.emit("opened")}function onClosed(){_logger.log("LoginPopup - onClosed");this.emit("closed")}function open(mvpd,options,origin){_logger.log("LoginPopup - open");if(loginPopup.isOpened()){return}var basicPopupWidth=1e3;var basicPopupHeight=600;var viewportWidth=Dom.viewportWidth();var viewportHeight=Dom.viewportHeight();var iframeWidth=mvpd.iFrameWidth;var iframeHeight=mvpd.iFrameHeight;var defaultPopupWidth=Math.min(basicPopupWidth,viewportWidth||basicPopupWidth,screen.availWidth||basicPopupWidth);var defaultPopupHeight=Math.min(basicPopupHeight,viewportHeight||basicPopupHeight,screen.availHeight||basicPopupHeight);var popupWidth=options&&options.width||mvpd.popupWidth||iframeWidth||defaultPopupWidth;var popupHeight=options&&options.height||mvpd.popupHeight||iframeHeight||defaultPopupHeight;var popupLeft=(window.screenX||window.screenLeft||0)+Math.max(25,Math.round((viewportWidth-popupWidth)/2));var popupTop=(window.screenY||window.screenTop||0)+Math.max(25,Math.round((viewportHeight-popupHeight)/2));var windowOptions=["width="+popupWidth,"height="+popupHeight,"left="+popupLeft,"top="+popupTop];return loginPopup.open(origin,windowOptions.join(","))}function close(){_logger.log("LoginPopup - close");loginPopup.close()}function isOpened(){return loginPopup.isOpened()}function setSrc(url){return loginPopup.setSrc(url)}var emitter=SimpleEmitter.mixin({isOpened:isOpened,setSrc:setSrc,open:open,close:close});loginPopup.on("opened",onOpened,emitter);loginPopup.on("closed",onClosed,emitter);module.exports=emitter},{"./app":2,"./dom":7,"./emitter":8,"./logger":11,"./windowwatcher":24}],14:[function(require,module,exports){"use strict";var App=require("./app");var _logger=require("./logger");var SimpleEmitter=require("./emitter");var WindowWatcher=require("./windowwatcher");var loginWindow=new WindowWatcher(App.ADOBE_WINDOW_NAME);function onOpened(){_logger.log("LoginWindow - onOpened");this.emit("opened")}function onClosed(){_logger.log("LoginWindow - onClosed");this.emit("closed")}function open(mvpd,options,origin){_logger.log("LoginWindow - open");return loginWindow.open(origin)}function close(){_logger.log("LoginWindow - close");loginWindow.close()}function isOpened(){return loginWindow.isOpened()}function setSrc(url){return loginWindow.setSrc(url)}var emitter=SimpleEmitter.mixin({isOpened:isOpened,setSrc:setSrc,open:open,close:close});loginWindow.on("opened",onOpened,emitter);loginWindow.on("closed",onClosed,emitter);module.exports=emitter},{"./app":2,"./emitter":8,"./logger":11,"./windowwatcher":24}],15:[function(require,module,exports){"use strict";var App=require("./app");var Promise=require("./vendor/promise");var _=require("./vendor/underscore");var _logger=require("./logger");var Util=require("./util");var Dom=require("./dom");var SimpleEmitter=require("./emitter");var MVPDConfig=new SimpleEmitter;var KNOWN_PLATFORMS=["flash","Android","iOS","Win8","Xbox","appletv","roku","firetv","tvos","androidtv"];var platform="";var mvpdConfigUrl="";var requestorId="";var propertyIds=[];var propertyMVPDs=[];var sanitizedMVPDs=[];var darkMvpdIds=[];var hiddenMvpdIds=[];var cacheBustValue=Math.round(_.now()/3e5).toString(36);function Deferred(){var _fulfill,_reject;var promise=new Promise(function(resolve,reject){_fulfill=resolve;_reject=reject});promise.fulfill=_fulfill;promise.reject=_reject;return promise}var waitingForWhitelistMerge=new Deferred;var waitingForPropertyMvpds=new Deferred;var waitingForVendorMvpds=new Deferred;var geoServiceUrl;var darkPhaseUrl;var darkPhaseCallbackName="cvp_onDarkPhaseReceived";var waitingForDarkPhaseConfig=new Deferred;var darkPhasePromise=new Deferred;var mvpdJsonpCallbackName="cvp_onMVPDConfigReceived";function determineMvpdConfigUrl(site,env){var url=App.CVP_CONFIG_ROOT+"/"+site+"/tve"+(env===App.CONFIG_ENV_PREPROD?"/preprod":"")+"/mvpdconfig.js";url=Util.augmentQueryString(url,{_:cacheBustValue});return url}function getMvpdConfigUrl(){return mvpdConfigUrl}function getGeoServiceUrl(){return geoServiceUrl}function getDarkPhaseUrl(){return darkPhaseUrl}function requestDarkPhaseData(){return darkPhasePromise}function normalizeMVPD(mvpd){if(_.isString(mvpd.iFrameRequired)){mvpd.iFrameRequired=mvpd.iFrameRequired==="true"}if(_.isString(mvpd.iFrameWidth)){mvpd.iFrameWidth=Util.toInt(mvpd.iFrameWidth)}if(_.isString(mvpd.iFrameHeight)){mvpd.iFrameHeight=Util.toInt(mvpd.iFrameHeight)}if(!("logoURL"in mvpd)&&"logoUrl"in mvpd){mvpd.logoURL=mvpd.logoUrl}if(!(App.MVPD_ID_KEY in mvpd)&&"id"in mvpd){mvpd[App.MVPD_ID_KEY]=mvpd.id}return mvpd}function interpretMvpdConfigEntry(config){var newConfig={};function getDefaultProperties(){return _.omit(config,["country","format"].concat(_.without(KNOWN_PLATFORMS,platform)))}function toUsefulData(memo,value,key){if(!_.isEmpty(value)||_.isString(value)){memo[key]=value}return memo}function getFormatProperties(){var flashFormatObj=_.reduce(_.findWhere(config.format,{os:"flash"}),toUsefulData,{});var platformFormatObj=_.reduce(_.findWhere(config.format,{os:platform}),toUsefulData,{});return _.extend({},flashFormatObj,platformFormatObj)}function getCountries(){var countries=[App.DEFAULT_COUNTRY];if(_.isString(config.country)){countries=_.compact(_.uniq(_.map(config.country.split(App.CONFIG_MULTIVALUE_DELIM),_.compose(Util.toUpper,Util.trim))))}return countries}newConfig=normalizeMVPD(_.extend(getDefaultProperties(),getFormatProperties()));newConfig.countries=getCountries();return newConfig}function updateClientConfig(mvpds){if(_.isEmpty(mvpds)||!_.isArray(mvpds)){_logger.error("MVPDConfig:updateClientConfig failed to receive list of MVPDs!");waitingForPropertyMvpds.reject({errorCode:"CFG012",errorId:"CFG012",errorString:"invalid client mvpd list",errorCategory:App.ErrorCategory.BLOCKED,resolution:App.Resolution.TRY_AGAIN_LATER});return}propertyMVPDs=_.map(mvpds,interpretMvpdConfigEntry);propertyIds=_.pluck(propertyMVPDs,App.MVPD_ID_KEY);_logger.log("MVPDConfig:updateClientConfig",propertyIds.length+" MVPDs listed in mvpdconfig: "+propertyIds.join(", "));waitingForPropertyMvpds.fulfill(propertyMVPDs)}function updateVendorConfig(mvpds){if(_.isEmpty(mvpds)||!_.isArray(mvpds)){_logger.error("MVPDConfig:updateVendorConfig failed to receive list of MVPDs!");waitingForVendorMvpds.reject({errorCode:"CFG002",errorId:"CFG002",errorString:"invalid vendor mvpd list",errorCategory:App.ErrorCategory.BLOCKED,resolution:App.Resolution.TRY_AGAIN_LATER});return}mvpds=_.map(mvpds,normalizeMVPD);var mvpdIds=_.pluck(mvpds,App.MVPD_ID_KEY);_logger.log("MVPDConfig:updateVendorConfig",mvpdIds.length+" MVPDs provided from vendor: "+mvpdIds.join(", "));waitingForVendorMvpds.fulfill(mvpds)}function fulfillWaitingForDarkPhase(value){waitingForDarkPhaseConfig.fulfill(value)}function darkPhaseLoadFailure(){_logger.warn("Failed to obtain dark phase data");fulfillWaitingForDarkPhase(true);darkPhasePromise.reject()}function darkPhaseLoadSuccess(data){_logger.log("Successfully obtained dark phase data");if(_.isObject(data)&&!_.isEmpty(data)){darkMvpdIds=_.keys(data);_logger.debug("MVPDConfig found dark phase providers",darkMvpdIds);MVPDConfig.emit("darkPhaseLoadSuccess");fulfillWaitingForDarkPhase(true);darkPhasePromise.fulfill(data)}else{_logger.debug("MVPDConfig found no dark phase providers");MVPDConfig.emit("darkPhaseLoadFailure");darkPhaseLoadFailure()}}function mvpdConfigLoadFailure(){_logger.error("Failed to obtain MVPDConfig");MVPDConfig.emit("mvpdConfigLoadFailure");waitingForPropertyMvpds.reject({errorCode:"CFG010",errorId:"CFG010",errorString:"mvpdconfig load failure",errorCategory:App.ErrorCategory.BLOCKED,resolution:App.Resolution.TRY_AGAIN_LATER})}function mvpdConfigLoadSuccess(data){_logger.log("Successfully obtained MVPDConfig");if(_.isUndefined(data)||!_.isString(data.brand)){mvpdConfigLoadFailure();
throw new Error(mvpdJsonpCallbackName+" did not receive valid data or brand")}if(data.brand!==requestorId){mvpdConfigLoadFailure();throw new Error(mvpdJsonpCallbackName+' received a "brand" ('+data.brand+') that did not match "requestorId" ('+requestorId+")")}if(!_.isArray(data.mvpd)){mvpdConfigLoadFailure();throw new Error(mvpdJsonpCallbackName+' received invalid "mvpd" data')}if(_.isObject(data.geo)&&_.isString(data.geo.url)){geoServiceUrl=data.geo.url;_logger.debug("MVPDConfig geo service URL obtained from MVPDConfig: ",geoServiceUrl)}else{_logger.debug("MVPDConfig geo service URL was not obtained from MVPDConfig.")}if(_.isObject(data.mvpdHelper)&&_.isString(data.mvpdHelper.url)){darkPhaseUrl=Util.augmentQueryString(data.mvpdHelper.url,{_:cacheBustValue});_logger.debug("MVPDConfig darkPhase URL obtained from MVPDConfig: ",darkPhaseUrl);MVPDConfig.emit("darkPhaseLoadAttempt",{darkPhaseUrl:darkPhaseUrl});Dom.JSONP({url:darkPhaseUrl,callbackName:darkPhaseCallbackName,success:darkPhaseLoadSuccess,failure:darkPhaseLoadFailure})}else{_logger.debug("MVPDConfig darkPhase URL was not obtained from MVPDConfig.");fulfillWaitingForDarkPhase(false)}MVPDConfig.emit("mvpdConfigLoadSuccess");updateClientConfig(data.mvpd)}function load(options){requestorId=options.requestorId;platform=options.platform;if(!platform){throw new Error('The "platform" was undetermined.  Cannot proceed.')}hiddenMvpdIds=options.hiddenMvpdIds||[];mvpdConfigUrl=options.mvpdConfigUrl;var site=options.site;var configEnv=options.configEnv;if(site&&!_.isString(mvpdConfigUrl)){mvpdConfigUrl=determineMvpdConfigUrl(site,configEnv)}if(!mvpdConfigUrl){_logger.error("MVPDConfig:load",'Could not determine `mvpdConfigUrl` for site "'+site+'"');mvpdConfigLoadFailure();return}MVPDConfig.emit("mvpdConfigLoadAttempt",{requestorId:requestorId,mvpdConfigUrl:mvpdConfigUrl});_logger.log("MVPDConfig:load","Requesting mvpdconfig from "+mvpdConfigUrl);Dom.JSONP({url:mvpdConfigUrl,callbackName:mvpdJsonpCallbackName,success:mvpdConfigLoadSuccess,failure:mvpdConfigLoadFailure})}function fail(err){_logger.error("MVPDConfig failure",err);waitingForWhitelistMerge.reject(err)}function mergeLists(res){var vendorMVPDs=res[0];var clientMVPDs=res[1];var diffMvpds=_.difference(_.pluck(vendorMVPDs,App.MVPD_ID_KEY),propertyIds);_logger.log("MVPDConfig:mergeLists",diffMvpds.length+" vendor-provided MVPDs did not appear in client mvpdconfig: "+diffMvpds.join(", "));_.each(vendorMVPDs,function(vendorMVPD){var propertyIdsIndex=_.indexOf(propertyIds,vendorMVPD[App.MVPD_ID_KEY]);if(propertyIdsIndex!==-1){var propertyMVPD=clientMVPDs[propertyIdsIndex];var mvpd=_.extend({},vendorMVPD,propertyMVPD);sanitizedMVPDs.push(mvpd)}});_logger.log("MVPDConfig:mergeLists","configured MVPDs ("+sanitizedMVPDs.length+"): "+_.pluck(sanitizedMVPDs,App.MVPD_ID_KEY).join(", "));waitingForWhitelistMerge.fulfill()}function isDarkMvpd(mvpd){return _.contains(darkMvpdIds,mvpd[App.MVPD_ID_KEY])}function isHiddenMvpd(mvpd){return _.contains(hiddenMvpdIds,mvpd[App.MVPD_ID_KEY])}function getWhitelistedMVPDs(filter){var mvpds=darkMvpdIds.length?_.reject(sanitizedMVPDs,isDarkMvpd):sanitizedMVPDs.slice();return filter?_.filter(mvpds,filter):mvpds}function getVisibleMVPDs(filter){filter=filter||_.identity;var combofilter=function(mvpd){return filter(mvpd)||isDarkMvpd(mvpd)};var mvpds=hiddenMvpdIds.length?_.reject(sanitizedMVPDs,isHiddenMvpd):sanitizedMVPDs.slice();return _.filter(mvpds,combofilter)}function getMvpdConfigEntry(id){if(_.isNull(id)){return undefined}if(_.isUndefined(id)){return propertyMVPDs.slice()}var index=_.indexOf(propertyIds,id);if(index===-1){return undefined}return _.extend({},propertyMVPDs[index])}Promise.all([waitingForVendorMvpds,waitingForPropertyMvpds]).then(mergeLists,fail);var mvpdConfigReady=Promise.all([waitingForWhitelistMerge,waitingForDarkPhaseConfig]);_.extend(MVPDConfig,{ready:mvpdConfigReady,load:load,getGeoServiceUrl:getGeoServiceUrl,getDarkPhaseUrl:getDarkPhaseUrl,requestDarkPhaseData:requestDarkPhaseData,updateClientConfig:updateClientConfig,updateVendorConfig:updateVendorConfig,getWhitelistedMVPDs:getWhitelistedMVPDs,getVisibleMVPDs:getVisibleMVPDs,getMvpdConfigUrl:getMvpdConfigUrl,getMvpdConfigEntry:getMvpdConfigEntry});module.exports=MVPDConfig},{"./app":2,"./dom":7,"./emitter":8,"./logger":11,"./util":19,"./vendor/promise":21,"./vendor/underscore":23}],16:[function(require,module,exports){"use strict";var App=require("./app");var _=require("./vendor/underscore");var machina=require("./vendor/machina");var _logger=require("./logger");var Dom=require("./dom");var Util=require("./util");var eventually=Util.eventually;var ENV=require("./env");var MVPDConfig=require("./mvpdconfig");var RememberedProvider=require("./remembered");var LoginIframe=require("./loginiframe");var LoginPopup=require("./loginpopup");var LoginWindow=require("./loginwindow");var inited=false;var pickerId="mvpdpicker";var pickerFrameId="mvpdPickerFrame";var pickerFrameSrc="about:blank";var config={};var searchFieldDefaultText="Enter your TV Provider";var mvpdIds=[];var lastProvider=null;var mvpdpicker=null;var mvpdbackdrop=null;var search=null;var mvpdsByName=null;function createDarkPhaseMarkup(data){var placeholder=/\$\{([^${}\r\n]+)\}/g;function evaluate(input){return input.replace(placeholder,function(match,key){key=Util.trim(key);if(_.isObject(data.meta)&&key in data.meta){var meta=data.meta[key];if(_.isObject(meta)&&"text"in meta){var text=_.isString(meta.text)?meta.text:key;if(meta.type==="url"&&_.isString(meta.url)){return'<a target="_blank" href="'+_.escape(meta.url)+'">'+text+"</a>"}else{return text}}else{return key}}return key})}return _.map(data.lines,evaluate).join("<br/>")}function isInMvpdList(id){return _.contains(mvpdIds,id)}function normalizeEvent(originalEvent){var event=_.extend({},originalEvent||window.event);if(!event.target){event.target=originalEvent.srcElement||document}return event}function handleSearchFieldBlur(event){event=normalizeEvent(event);var search=event.target;if(Util.trim(search.value)===""){search.value=searchFieldDefaultText}}function handleSearchFieldFocus(event){event=normalizeEvent(event);var search=event.target;if(search.value===searchFieldDefaultText){search.value=""}}var linkedList=null;var linkedListParent=null;function createLinkedList(value,index,list){return{el:value,next:index<list.length-1?list[index+1]:null}}function appendToList(el){linkedListParent.appendChild(el)}function insertInListBefore(el,next){linkedListParent.insertBefore(el,next)}var getPickerEl=function(){var pickerEl;return function(){return pickerEl||document.getElementById(pickerId)}}();function isInPicker(el){var pickerEl=getPickerEl();if(pickerEl){return pickerEl.contains(el)}return false}function isNextPointerVisible(obj){return isInPicker(obj.next)}function isElPointerVisible(obj){return isInPicker(obj.el)}function showListElement(obj){var index=_.indexOf(linkedList,obj)+2;if(!obj.next){appendToList(obj.el)}else if(isNextPointerVisible(obj)){insertInListBefore(obj.el,obj.next)}else if(index<linkedList.length){var nextVisible=_.find(linkedList.slice(index),isElPointerVisible);if(nextVisible){insertInListBefore(obj.el,nextVisible.el)}else{appendToList(obj.el)}}else{appendToList(obj.el)}}function hideListElement(obj){var parent=Dom.parent(obj.el);if(!parent){return}parent.removeChild(obj.el)}function showAllItems(){if(!linkedList){return}var list=linkedList.slice(0).reverse();_.each(list,showListElement)}function createSearchRegExp(text){return new RegExp(_.map(text.replace(/\s+/,"").split("",15),Util.escapeRegExp).join(".*"),"i")}function handleEachTextEntry(event){if(linkedList===null&&mvpdsByName&&mvpdsByName.length){linkedListParent=Dom.parent(mvpdsByName[0]);linkedList=_.map(mvpdsByName,createLinkedList)}var enteredText=event.target.value;if(!enteredText||enteredText===searchFieldDefaultText){showAllItems();return}if(!linkedList||!linkedList.length){return}var searchRE=createSearchRegExp(enteredText);for(var obj,el,i=0,endi=linkedList.length;i<endi;i+=1){obj=linkedList[i];el=obj.el;if(searchRE.test(Dom.text(el))){showListElement(obj)}else{hideListElement(obj)}}}var handleTextEntry=_.debounce(handleEachTextEntry,600);function deferTextEntry(event){handleTextEntry(normalizeEvent(event))}function centerPicker(){Dom.center(mvpdpicker)}var recenterPicker=_.debounce(centerPicker,250);function createImage(imageUrl){var image=new Image;image.src=imageUrl;return image}function preloadLogos(mvpds){return _.map(_.pluck(mvpds,"pickerImage"),createImage)}var stateClassNameMap={welcome:"state-welcome",remembered:"state-remember",findbylogo:"state-mvpdlogo",findbyname:"state-mvpdlist",noprovider:"state-notfound",darkprovider:"state-dark",signin:"state-signin",error:"state-error",success:"state-success"};function onStateChange(obj){var classList=Dom.classList(mvpdpicker);_.each(stateClassNameMap,function(value){classList.remove(value)});classList.add(stateClassNameMap[obj.state])}function determinePickerImage(arrayOrObject){var pickerObj;if(_.isObject(arrayOrObject)&&arrayOrObject.url){return arrayOrObject.url}if(_.isArray(arrayOrObject)&&arrayOrObject.length!==0){if(ENV.supports.retina){pickerObj=_.find(arrayOrObject,function(item){return"retina"in item&&item.retina&&"url"in item})}if(!pickerObj){pickerObj=_.find(arrayOrObject,function(item){return"url"in item})}if(pickerObj){return pickerObj.url}}}function augmentMVPD(arrayOrObject){function processForPickerImage(item){var pickerImage=determinePickerImage(item.picker);if(pickerImage){item.pickerImage=pickerImage}return item}if(_.isArray(arrayOrObject)){return _.each(arrayOrObject,processForPickerImage)}if(_.isObject(arrayOrObject)&&"picker"in arrayOrObject){return processForPickerImage(arrayOrObject)}return arrayOrObject}function sortMvpdsByName(mvpd){return mvpd.displayName.toLowerCase()}var pickerMarkup='<div class="header">'+'<div class="help"></div>'+'<div class="close"></div>'+'<div class="title"><span><%= Strings.title %></span></div>'+"</div>"+'<div class="steps"></div>'+'<div class="slates">'+'<div class="slate welcome">'+'<div class="message welcomemessage"><%= Strings.welcomemessage %></div>'+'<button class="welcomeloginbutton"><span><%= Strings.welcomeloginbutton %></span></button>'+"</div>"+'<div class="slate remembered">'+'<div class="message rememberedmessage"></div>'+'<div class="footer rememberedfooter">'+'<button class="rememberedcancelbutton"><span><%= Strings.rememberedcancelbutton %></span></button>'+'<button class="rememberedokbutton"><span><%= Strings.rememberedokbutton %></span></button>'+"</div>"+"</div>"+'<div class="slate pickbylogo">'+'<ul class="mvpdsbylogo">'+"<% _.each(primaryMvpds, function (mvpd, index) { %>"+'<li data-mvpdid="<%- mvpd.ID %>" title="<%- mvpd.displayName %>"><img class="mvpdlogo" alt="<%- mvpd.displayName %>" src="<%- mvpd.pickerImage %>"></li>'+"<% }); %>"+"</ul>"+'<div class="footer">'+'<button class="viewallbutton"><span><%= Strings.viewallbutton %></span></button>'+"</div>"+"</div>"+'<div class="slate findbyname">'+'<div class="searchheader">'+'<div class="searchfield">'+'<input class="mvpdsearch" type="text" value="Search">'+"</div>"+"</div>"+'<div class="searchpane">'+'<ul class="mvpdsbyname">'+"<% _.each(mvpds, function (mvpd) { %>"+'<li data-mvpdid="<%- mvpd.ID %>"><%- mvpd.displayName %></li>'+"<% }); %>"+"</ul>"+"</div>"+'<div class="footer searchfooter">'+"<% if (canUseLogoView) { %>"+'<button class="viewtopbutton"><span><%= Strings.viewtopbutton %></span></button>'+"<% } %>"+'<button class="dontseebutton"><span><%= Strings.dontseebutton %></span></button>'+"</div>"+"</div>"+'<div class="slate noprovider">'+'<div class="message noprovidermessage"><%= Strings.noprovidermessage %></div>'+'<button class="okbutton noproviderokbutton"><span><%= Strings.noproviderokbutton %></span></button>'+"</div>"+'<div class="slate darkprovider">'+'<div class="message darkprovidermessage"></div>'+'<button class="okbutton darkproviderokbutton"><span><%= Strings.darkproviderokbutton %></span></button>'+"</div>"+'<div class="slate signin">'+'<div class="message signinmessage"><%= Strings.signinmessage %></div>'+'<div class="spinnerbox">'+'<div class="spinner"></div>'+"</div>"+'<button class="cancelbutton signincancelbutton"><span><%= Strings.signincancelbutton %></span></button>'+"</div>"+'<div class="slate error">'+'<div class="message errormessage"><%= Strings.errormessage %></div>'+'<button class="okbutton errorokbutton"><span><%= Strings.errorokbutton %></span></button>'+"</div>"+'<div class="slate success">'+'<div class="message successmessage"><%= Strings.successmessage %></div>'+'<button class="watchnowbutton"><span><%= Strings.watchnowbutton %></span></button>'+"</div>"+"</div>";var pickerTemplate=_.template(pickerMarkup);var picker=new machina.Fsm({initialState:"closed",_priorPickingState:"findbylogo",initialize:function(){_.bindAll(this,"reactivate","deactivate","onOpened","onClosed");this._reactivateTimer=eventually(this.reactivate,2e4);this._indeterminateTimer=eventually(restartLogin,12e3);this._redundantAuthNCheckTimer=eventually(redundantCheckAuthN,6e3)},setup:function(AuthManager){if(!AuthManager){throw new Error("AuthManager required!")}this.authManager=AuthManager;this.on("handling",function(data){_logger.debug("[picker:"+this.state+"] handling "+data.inputType)});this.on("handled",function(data){_logger.debug("[picker:"+this.state+"] handled "+data.inputType)});this.on("nohandler",function(data){_logger.debug("[picker:"+this.state+"] nohandler",data.inputType)});this.on("transition",function(data){_logger.debug("[picker:"+this.state+'] transition from "'+data.fromState+'" to "'+data.toState+'" via "'+data.action+'"')});this.on("invalidstate",function(){_logger.debug("[picker:"+this.state+"] invalidstate")});this.on("deferred",function(){_logger.debug("[picker:"+this.state+"] deferred")});LoginIframe.on("opened",this.handleLoginOpen,this);LoginIframe.on("closed",this.handleLoginClose,this);LoginPopup.on("opened",this.handleLoginOpen,this);LoginPopup.on("closed",this.handleLoginClose,this);LoginWindow.on("opened",this.handleLoginOpen,this);LoginWindow.on("closed",this.handleLoginClose,this);this.authManager.on("authNPass",function(){picker.handle("authNPass")});this.authManager.on("authNFail",function(){picker.handle("authNFail")});this.on("opened",this.onOpened);this.on("closed",this.onClosed);this.on("stateChange",onStateChange)},handleLoginOpen:function(){this.handle("loginOpened")},handleLoginClose:function(){this.handle("loginClosed")},onOpened:function(){_logger.log("MVPDPicker:onOpened");if(_.isFunction(config.onRender)){if(config.onRender.length){config.onRender.call(mvpdpicker,this.display)}else{config.onRender.call(mvpdpicker);this.display()}}else{this.display()}},onClosed:function(){mvpdpicker.className="";var mvpdpickerClassList=Dom.classList(mvpdpicker);var mvpdbackdropClassList=Dom.classList(mvpdbackdrop);mvpdpickerClassList.remove("visible");mvpdpickerClassList.add("hidden");mvpdbackdropClassList.remove("visible");mvpdbackdropClassList.add("hidden");Dom.off(window,"resize",recenterPicker);Dom.off(window,"orientationchange",recenterPicker);Dom.off(mvpdpicker,"click",delegateClickHandler);Dom.off(search,"blur",handleSearchFieldBlur);Dom.off(search,"focus",handleSearchFieldFocus);Dom.off(search,"keydown",deferTextEntry)},deactivate:function(){this.handle("deactivate")},reactivate:function(){this.handle("reactivate")},isOpen:function(){return!this.isDeactivated()&&this.state!=="closed"},isDeactivated:function(){return this.state==="deactivated"},create:function(config){_logger.log("MVPDPicker:create");if(_.isArray(config.primaryMvpds)){preloadLogos(config.primaryMvpds)}var mvpdpickerEl=Dom.create("div");mvpdpickerEl.id=pickerId;mvpdpickerEl.className="hidden";var pickerFrameEl=Dom.create("iframe");pickerFrameEl.id=pickerFrameId;pickerFrameEl.className="hidden";pickerFrameEl.src=pickerFrameSrc;pickerFrameEl.scrolling="no";pickerFrameEl.frameborder="0";Dom.append(pickerFrameEl);Dom.append(mvpdpickerEl);mvpdpicker=mvpdpickerEl;mvpdbackdrop=pickerFrameEl;mvpdpicker.innerHTML=pickerTemplate({Strings:config.Strings,canUseLogoView:config.canUseLogoView,primaryMaxCount:config.primaryMaxCount,primaryMvpds:config.primaryMvpds,mvpds:config.mvpds});inited=true},destroy:function(){_logger.log("MVPDPicker:destroy");Dom.remove(mvpdpicker);Dom.remove(mvpdbackdrop);mvpdpicker=null;mvpdbackdrop=null;inited=false},open:function(opts){_logger.log("MVPDPicker:open");config=opts;mvpdIds=_.pluck(config.mvpds,App.MVPD_ID_KEY);var canUseLogoView=config.primaryMvpds&&config.primaryMvpds.length>=config.primaryMinCount;if(!inited||!Dom.id(pickerId)){var mvpds=_.sortBy(config.mvpds,sortMvpdsByName);var primaryMvpds=_.sortBy(config.primaryMvpds,"primaryOrder").slice(0,config.primaryMaxCount);augmentMVPD(primaryMvpds);this.create({Strings:config.Strings,canUseLogoView:canUseLogoView,primaryMinCount:config.primaryMinCount,primaryMaxCount:config.primaryMaxCount,primaryMvpds:primaryMvpds,mvpds:mvpds})}if(inited||Dom.id(pickerId)){this.handle("open",{hasWelcomeSlate:config.hasWelcomeSlate,canUseLogoView:canUseLogoView})}else{_logger.error("MVPDPicker:open - failed to render to DOM!")}},display:function(){_logger.log("MVPDPicker:display");search=Dom.one(".mvpdsearch",mvpdpicker);mvpdsByName=Dom.all(".mvpdsbyname li",mvpdpicker);Dom.on(window,"resize",recenterPicker);Dom.on(window,"orientationchange",recenterPicker);var mvpdpickerClassList=Dom.classList(mvpdpicker);var mvpdbackdropClassList=Dom.classList(mvpdbackdrop);mvpdbackdropClassList.remove("hidden");mvpdbackdropClassList.add("visible");mvpdpickerClassList.remove("hidden");mvpdpickerClassList.add("visible");centerPicker();Dom.on(mvpdpicker,"click",delegateClickHandler);search.value=searchFieldDefaultText;showAllItems();Dom.on(search,"blur",handleSearchFieldBlur);Dom.on(search,"focus",handleSearchFieldFocus);Dom.on(search,"keydown",deferTextEntry)},close:function(){_logger.log("MVPDPicker:close");this.transition("closed")},states:{deactivated:{_onEnter:function(){this._reactivateTimer.start()},reactivate:"closed",_onExit:function(){this._reactivateTimer.stop()}},closed:{_onEnter:function(){if(this.priorState&&this.priorState!=="deactivated"){if(this.priorState!=="success"){this.emit("canceled",{state:this.priorState})}this.emit("closed")}},deactivate:"deactivated",open:function(obj){this.emit("opened");lastProvider=RememberedProvider.get();if(lastProvider&&(!isInMvpdList(lastProvider)||!this.authManager.isValidMvpdId(lastProvider))){RememberedProvider.forget();lastProvider=null}if(obj.hasWelcomeSlate){this.transition("welcome")}else if(lastProvider){populateRememberedProvider();this.transition("remembered")}else if(obj.canUseLogoView){this.transition("findbylogo")}else{this.transition("findbyname")}}},welcome:{_onEnter:function(){this.emit("stateChange",{state:"welcome"})},helpClicked:helpClicked,closeClicked:closeClicked,welcomeLoginClicked:"findbylogo"},findbylogo:{_onEnter:function(){this._priorPickingState=this.state;if(this._usedRememberedProvider){RememberedProvider.forget();delete this._usedRememberedProvider}this.emit("stateChange",{state:"findbylogo"})},darkProviderSelected:darkProviderSelected,helpClicked:helpClicked,closeClicked:closeClicked,viewAllClicked:"findbyname",loginOpened:"signin",authNPass:"success"},findbyname:{_onEnter:function(){this._priorPickingState=this.state;this.emit("stateChange",{state:"findbyname"})},darkProviderSelected:darkProviderSelected,helpClicked:helpClicked,closeClicked:closeClicked,viewTopClicked:"findbylogo",dontSeeClicked:"noprovider",loginOpened:"signin",authNPass:"success"},noprovider:{_onEnter:function(){this.emit("stateChange",{state:"noprovider"})},helpClicked:helpClicked,closeClicked:closeClicked,noproviderOkClicked:transitionToProviderSelection},darkprovider:{_onEnter:function(){this.emit("stateChange",{state:"darkprovider"})},helpClicked:helpClicked,closeClicked:closeClicked,darkproviderOkClicked:transitionToProviderSelection},remembered:{_onEnter:function(){this._usedRememberedProvider=true;this.emit("stateChange",{state:"remembered"})},helpClicked:helpClicked,closeClicked:closeClicked,rememberedCancelClicked:"findbylogo",rememberedOkClicked:loginWithRememberedProvider,loginOpened:"signin",authNPass:"success"},signin:{_onEnter:function(){this.emit("stateChange",{state:"signin"})},helpClicked:helpClicked,closeClicked:closeClicked,loginClosed:"indeterminate",signinCancelClicked:restartLogin,authNPass:"success",authNFail:"error"},indeterminate:{_onEnter:function(){this._indeterminateTimer.start();this._redundantAuthNCheckTimer.start()},helpClicked:helpClicked,closeClicked:closeClicked,signinCancelClicked:restartLogin,authNPass:"success",authNFail:"error",_onExit:function(){this._indeterminateTimer.stop();this._redundantAuthNCheckTimer.stop()}},error:{_onEnter:function(){this.emit("stateChange",{state:"error"})},helpClicked:helpClicked,closeClicked:closeClicked,errorOkClicked:restartLogin},success:{_onEnter:function(){this.emit("stateChange",{state:"success"})},helpClicked:helpClicked,closeClicked:closeClicked,authNFail:"closed",watchNowClicked:"closed"}}});function handleInvalidMvpd(id){if(isInMvpdList(id)){picker.handle("darkProviderSelected",id)}else{picker.transition("noprovider")}}function handleMvpdClick(){var mvpdId=Dom.attr(this,"data-mvpdid");if(picker.authManager.isValidMvpdId(mvpdId)){picker.authManager.openLogin(mvpdId)}else{handleInvalidMvpd(mvpdId)}picker.emit("mvpdSelected",{mvpdId:mvpdId})}function helpClicked(){picker.emit("helpClicked",{state:picker.state})}function closeClicked(){picker.emit("closeClicked",{state:picker.state});picker.transition("closed")}function transitionToProviderSelection(){picker.transition(picker._priorPickingState)}function redundantCheckAuthN(){picker.authManager._checkAuthN()}function restartLogin(){_logger.debug("restarting login");picker.authManager.closeLogin();transitionToProviderSelection();picker.authManager.getAuthentication()}function darkProviderFailure(mvpdId){picker.emit("darkProviderSelected",{mvpdId:mvpdId,success:false});picker.transition("noprovider")}function requestDarkPhaseDataSuccess(el,mvpdId,data){if(mvpdId in data&&"lines"in data[mvpdId]){var darkData=data[mvpdId];el.innerHTML=createDarkPhaseMarkup(darkData);picker.emit("darkProviderSelected",{mvpdId:mvpdId,success:true});picker.transition("darkprovider")}else{_logger.debug('Failed to find dark data for provider "'+mvpdId+'"!');darkProviderFailure(mvpdId)}}function requestDarkPhaseDataFailure(mvpdId){_logger.debug('Failed to obtain dark provider data for provider "'+mvpdId+'"!');darkProviderFailure()}function darkProviderSelected(mvpdId){var el=Dom.one("#mvpdpicker .darkprovidermessage");if(!el){_logger.error("Could not find .darkprovidermessage!");darkProviderFailure(mvpdId);return}var success=_.bind(requestDarkPhaseDataSuccess,picker,el,mvpdId);var failure=_.bind(requestDarkPhaseDataFailure,picker,mvpdId);MVPDConfig.requestDarkPhaseData().then(success,failure)}function populateRememberedProvider(){var el=Dom.one("#mvpdpicker .rememberedmessage");if(!el){_logger.debug("Failed to find Picker remembered message.");return}if(!lastProvider){el.innerHTML=""}var mvpd=picker.authManager.getMvpdById(lastProvider);var name=mvpd.displayName||mvpd.ID;var logo=mvpd.pickerImage||null;var array=[];array.push('<p class="rememberedprovider">'+(logo?'<img src="'+logo+'" width="'+mvpd.picker[0].width+'" height="'+mvpd.picker[0].height+'" alt="'+name+'">':name)+"</p>");el.innerHTML=array.join("")}function loginWithRememberedProvider(){picker.authManager.openLogin(lastProvider)}function delegateClickHandler(event){event=event||window.event;var target=event.target||event.srcElement;var classList=Dom.classList(target);var targetTag=target.tagName;var parentTag=target.parentNode.tagName;if(targetTag==="SPAN"&&parentTag==="BUTTON"){classList=Dom.classList(target.parentNode)}if(targetTag==="IMG"&&classList.contains("mvpdlogo")){return handleMvpdClick.apply(Dom.parent(target),arguments)}if(targetTag==="LI"&&Dom.attr(target,"data-mvpdid")){return handleMvpdClick.apply(target,arguments)}if(classList.contains("help")){return picker.handle("helpClicked")}if(classList.contains("close")){return picker.handle("closeClicked")}if(classList.contains("welcomeloginbutton")){picker.handle("welcomeLoginClicked")}if(classList.contains("viewallbutton")){return picker.handle("viewAllClicked")}if(classList.contains("viewtopbutton")){return picker.handle("viewTopClicked")}if(classList.contains("dontseebutton")){return picker.handle("dontSeeClicked")}if(classList.contains("noproviderokbutton")){return picker.handle("noproviderOkClicked")}if(classList.contains("darkproviderokbutton")){return picker.handle("darkproviderOkClicked")}if(classList.contains("rememberedcancelbutton")){return picker.handle("rememberedCancelClicked")}if(classList.contains("rememberedokbutton")){return picker.handle("rememberedOkClicked")}if(classList.contains("signincancelbutton")){return picker.handle("signinCancelClicked")}if(classList.contains("errorokbutton")){return picker.handle("errorOkClicked")}if(classList.contains("watchnowbutton")){return picker.handle("watchNowClicked")}}module.exports=picker},{"./app":2,"./dom":7,"./env":9,"./logger":11,"./loginiframe":12,"./loginpopup":13,"./loginwindow":14,"./mvpdconfig":15,"./remembered":17,"./util":19,"./vendor/machina":20,"./vendor/underscore":23}],17:[function(require,module,exports){"use strict";var _logger=require("./logger");var Store=require("./store");var RememberedProvider={storeKey:"cvp.auth.rememberedProvider",forget:function(){_logger.debug("[RememberedProvider] forgetting provider...");return Store.remove(this.storeKey)},get:function(){return Store.get(this.storeKey)},save:function(value){_logger.debug("[RememberedProvider] saving provider...",value);return Store.set(this.storeKey,value)}};module.exports=RememberedProvider},{"./logger":11,"./store":18}],18:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var _logger=require("./logger");var localStorageImpl={_testKey:"__testlocalstorage__",_ready:undefined,_hasLocalStorage:function(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){return false}},_testLocalStorage:function(){try{this._setItem(this._testKey,this._testKey)}catch(e){return false}if(this._getItem(this._testKey)!==this._testKey){return false}this._removeItem(this._testKey);return true},isSupported:function(){if(this._ready===undefined){this._ready=this._hasLocalStorage()&&this._testLocalStorage()}return this._ready},_wrap:function(fn,args){if(this.isSupported()){return fn.apply(this,args)}else{_logger.warn("Unable to access localStorage.")}},_setItem:function(key,value){return window.localStorage.setItem(key,value)},_getItem:function(key){return window.localStorage.getItem(key)},_removeItem:function(key){return window.localStorage.removeItem(key)},setItem:function(){return this._wrap(this._setItem,arguments)},getItem:function(){return this._wrap(this._getItem,arguments)},removeItem:function(){return this._wrap(this._removeItem,arguments)}};var sessionStorageImpl={_testKey:"__testsessionstorage__",_ready:undefined,_hasSessionStorage:function(){try{return"sessionStorage"in window&&window.sessionStorage!==null}catch(e){return false}},_testSessionStorage:function(){try{this._setItem(this._testKey,this._testKey)}catch(e){return false}if(this._getItem(this._testKey)!==this._testKey){return false}this._removeItem(this._testKey);return true},isSupported:function(){if(this._ready===undefined){this._ready=this._hasSessionStorage()&&this._testSessionStorage()}return this._ready},_wrap:function(fn,args){if(this.isSupported()){return fn.apply(this,args)}else{_logger.warn("Unable to access sessionStorage.")}},_setItem:function(key,value){return window.sessionStorage.setItem(key,value)},_getItem:function(key){return window.sessionStorage.getItem(key)},_removeItem:function(key){return window.sessionStorage.removeItem(key)},setItem:function(){return this._wrap(this._setItem,arguments)},getItem:function(){return this._wrap(this._getItem,arguments)},removeItem:function(){return this._wrap(this._removeItem,arguments)}};var StoreData=function(){function StoreData(value,options){this.value=value;this.timeStamp=options&&options.timeStamp||_.now();if(options&&options.expires){this.expires=options.expires}}StoreData.parse=function(storedString){var obj;var value;var options;try{obj=JSON.parse(storedString);if("data"in obj){value=obj.data}if("meta"in obj){options=obj.meta}}catch(e){return null}return new StoreData(value,options)};StoreData.prototype.toObject=function(){var obj={};obj.data=this.value;obj.meta={timeStamp:this.timeStamp};if(this.expires){obj.meta.expires=this.expires}return obj};StoreData.prototype.stringify=function(){var string;try{string=JSON.stringify(this.toObject())}catch(e){string=null}return string};StoreData.prototype.isExpired=function(){return this.expires&&_.now()>this.expires};return StoreData}();function setItem(key,value,options){this.removeItem(key);if(value===null||value===undefined){_logger.log('[Store:setItem] No value to save for key "'+key+'"');return true}var data=new StoreData(value,options);if(data.isExpired()){_logger.log('[Store:setItem] Item of key "'+key+'" has expired and will not be stored.');return true}var string=data.stringify();if(string===null){_logger.debug('[Store:setItem] Item of key "'+key+'" could not be stringified and will not be stored.');return false}try{this.setItem(key,string);return true}catch(e){_logger.warn('[Store:setItem] Item of key "'+key+'" could not be stored: ',e);return false}}function getItem(key){var string;try{string=this.getItem(key)}catch(e){_logger.warn('[Store:getItem] Item of key "'+key+'" could not be retrieved: ',e);return false}if(string===null){_logger.log('[Store:getItem] Item of key "'+key+'" did not return a value.');return null}var data=StoreData.parse(string);if(!data){_logger.debug('[Store:getItem] Item of key "'+key+'" could not be parsed and will not be retrieved.');return false}if(data.isExpired()){_logger.log('[Store:getItem] Item of key "'+key+'" has expired and will not be retrieved.');this.removeItem(key);return null}return data.value}function removeItem(key){try{this.removeItem(key);return true}catch(e){_logger.warn('[Store:removeItem] Item of key "'+key+'" could not be removed: ',e);return false}}exports.set=_.bind(setItem,localStorageImpl);exports.get=_.bind(getItem,localStorageImpl);exports.remove=_.bind(removeItem,localStorageImpl);exports.supportsLocalStorage=_.bind(localStorageImpl.isSupported,localStorageImpl);exports.setSession=_.bind(setItem,sessionStorageImpl);exports.getSession=_.bind(getItem,sessionStorageImpl);exports.removeSession=_.bind(removeItem,sessionStorageImpl);exports.supportsSessionStorage=_.bind(sessionStorageImpl.isSupported,sessionStorageImpl)},{"./logger":11,"./vendor/underscore":23}],19:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var Promise=require("./vendor/promise");var Dom=require("./dom");function assert(value,msg){if(!value){throw new Error(msg||value+" is not truthy")}}function assertEqual(val1,val2,msg){if(val1!==val2){throw new Error(msg||val1+" does not equal "+val2)}}function toNum(str){return+str}function toInt(num){return parseInt(num,10)}var toUpper=_.bind(Function.prototype.call,String.prototype.toUpperCase);var nativeTrim=String.prototype.trim;var allSpaceAtEndsRegex=/^\s+|\s+$/g;function shimTrim(){return this.replace(allSpaceAtEndsRegex,"")}var libTrim=_.isFunction(nativeTrim)?nativeTrim:shimTrim;function trim(text){return text==null?"":libTrim.call(text)}var urlRegex=/^((([^:\/?#]+):)?(?:\/\/(([^\/?#]*)(?::(\d+))?))?)(([^?#]*\/)([^\/?#]*)?)(\?([^#]*))?(#(.*))?$/;var allUrlEncodedSpaces=/%20/g;function parseUrl(url){var a=window.document.createElement("a");a.href=url;var href=a.href;a=null;var match=urlRegex.exec(href);if(match){return{href:match[0]||"",origin:match[1]||"",
protocol:match[2]||"",scheme:match[3]||"",host:match[4]||"",hostname:match[5]||"",port:match[6]||"",pathname:match[7]||"",dir:match[8]||"",file:match[9]||"",search:match[10]||"",query:match[11]||"",hash:match[12]||"",anchor:match[13]||""}}}var allQueryParamsRegex=/([^?&=]+)(?:=([^&=]+))?/g;var decode=window.decodeURIComponent;function parseQueryString(queryString){var queryObject={};queryString.replace(allQueryParamsRegex,function($0,$1,$2){queryObject[$1]=$2?decode($2):"";return $0});return queryObject}var encode=window.encodeURIComponent;function toQueryKeyValueString(value,key){return encode(key)+(value!==""?"="+encode(_.isObject(value)?JSON.stringify(value):value):"")}function encodeParams(obj){var queryArray=_.map(obj,toQueryKeyValueString);return queryArray.join("&").replace(allUrlEncodedSpaces,"+")}function toQueryString(hash){var params=encodeParams(hash);var queryString=params?"?"+params:"";return queryString}function augmentQueryString(url,data){var urlParts=parseUrl(url);var queryParts=parseQueryString(urlParts.query);queryParts=_.extend({},queryParts,data);var queryString=toQueryString(queryParts);return urlParts.origin+urlParts.pathname+queryString+urlParts.hash}var loadScript=function loadScript(){var counter=0;var tag="script";return function(url,callbackOrConfig){if(typeof url!=="string"){throw new Error("invalid param!")}var options={};switch(typeof callbackOrConfig){case"object":options=callbackOrConfig;break;case"function":options.success=callbackOrConfig;break}var el=Dom.create(tag),s1=Dom.tags(tag)[0],readyRE=/^(complete|loaded)$/,done=false,timedout=function(){el.onerror()},timer=_.isFinite(options.timeout)?window.setTimeout(timedout,options.timeout):null,noop=function(){},success=_.isFunction(options.success)?options.success:noop,failure=_.isFunction(options.failure)?options.failure:noop,complete=_.isFunction(options.complete)?options.complete:noop,cleanup=function(){window.setTimeout(complete,0);window.clearTimeout(timer);el.onload=el.onreadystatechange=el.onerror=null;if(options.cleanup){if(el.parentElement){el.parentElement.removeChild(el)}}el=null};el.onload=el.onreadystatechange=function(){if(!done&&(!("readyState"in el)||readyRE.test(el.readyState))){done=true;window.setTimeout(success,0);window.setTimeout(cleanup,0)}};el.onerror=function(){if(!done){done=true;window.setTimeout(failure,0);window.setTimeout(cleanup,0)}};el.id=options.id||"cvpauth_load_"+(counter+=1);el.src=url;s1.parentNode.insertBefore(el,s1)}}();var allRegexMetasRegex=/[\-\[\]{}()*+?.,\\\^\$|#\s]/g;function escapeRegExp(text){return text.replace(allRegexMetasRegex,"\\$&")}function padInt(num,places){if(num<0||isNaN(num)){return String(num)}places=places||2;num=Math.floor(num).toString();var padding=places-num.length;if(padding<=0){return num}var ohs=new Array(padding+1).join("0");return ohs+num}var simpleUrlRegex=/^([^?#]+)(\?[^#]+)?(#.+)?/;function createRedirectUrl(url){if(url===null||url===""){return null}if(url===undefined){url=window.location.href}var regexResult=simpleUrlRegex.exec(url);if(!regexResult){return url}var location=regexResult[1]||"";var query=regexResult[2]||"";var fragment=regexResult[3]||"";var queryObject=parseQueryString(query);if(fragment){var date=new Date;var hr=padInt(date.getHours());var min=padInt(date.getMinutes());var sec=padInt(date.getSeconds());queryObject._=hr+min+sec}var queryString=toQueryString(queryObject);url=location+queryString+fragment;return url}function eventually(cb,ms){var timeout;function stop(){if(!timeout)return;window.clearTimeout(timeout);timeout=null}function start(){stop();timeout=window.setTimeout(cb,ms)}if(!isFinite(ms)||typeof cb!=="function")throw new Error("usage: eventually(cb, ms)");return{start:start,stop:stop}}function periodically(cb,ms){var timeout,count=0,tick=function(){cb(++count,ms)},stop=function(){window.clearInterval(timeout)},start=function(){if(timeout)stop();timeout=window.setInterval(tick,ms||1e3)};return{start:start,stop:stop}}function request(opts){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;var method=opts.method||"GET";var url=opts.url;var data=opts.data||null;var headers=opts.headers||{};if(method==="POST"){headers["Content-Type"]="application/x-www-form-urlencoded"}else{url=augmentQueryString(url,data);data=null}xhr.open(method,url);xhr.onload=function(){if(200<=this.status&&this.status<300){resolve(this.response)}else{reject({status:this.status,statusText:this.statusText,body:this.response})}};xhr.onerror=function(){reject({status:0,statusText:"Network Error"})};_.each(opts.headers,function(value,key){xhr.setRequestHeader(key,value)});xhr.send(data)})}exports.assert=assert;exports.assertEqual=assertEqual;exports.toNum=toNum;exports.toInt=toInt;exports.toUpper=toUpper;exports.trim=trim;exports.parseUrl=parseUrl;exports.parseQueryString=parseQueryString;exports.augmentQueryString=augmentQueryString;exports.loadScript=loadScript;exports.escapeRegExp=escapeRegExp;exports.padInt=padInt;exports.createRedirectUrl=createRedirectUrl;exports.eventually=eventually;exports.periodically=periodically;exports.request=request},{"./dom":7,"./vendor/promise":21,"./vendor/underscore":23}],20:[function(require,module,exports){"use strict";var _=require("./underscore");var slice=[].slice;var NEXT_TRANSITION="transition";var NEXT_HANDLER="handler";var HANDLING="handling";var HANDLED="handled";var NO_HANDLER="nohandler";var TRANSITION="transition";var INVALID_STATE="invalidstate";var DEFERRED="deferred";var NEW_FSM="newfsm";var utils={makeFsmNamespace:function(){var machinaCount=0;return function(){return"fsm."+machinaCount++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:utils.makeFsmNamespace(),targetReplayState:"",state:undefined,priorState:undefined,_priorAction:"",_currentAction:""}}};if(!_.deepExtend){var behavior={"*":function(obj,sourcePropKey,sourcePropVal){obj[sourcePropKey]=sourcePropVal},object:function(obj,sourcePropKey,sourcePropVal){obj[sourcePropKey]=deepExtend({},obj[sourcePropKey]||{},sourcePropVal)},array:function(obj,sourcePropKey,sourcePropVal){obj[sourcePropKey]=[];_.each(sourcePropVal,function(item,idx){behavior[getHandlerName(item)](obj[sourcePropKey],idx,item)},this)}},getActualType=function(val){if(_.isArray(val)){return"array"}if(_.isDate(val)){return"date"}if(_.isRegExp(val)){return"regex"}return typeof val},getHandlerName=function(val){var propType=getActualType(val);return behavior[propType]?propType:"*"},deepExtend=function(obj){_.each(slice.call(arguments,1),function(source){_.each(source,function(sourcePropVal,sourcePropKey){behavior[getHandlerName(sourcePropVal)](obj,sourcePropKey,sourcePropVal)})});return obj};_.mixin({deepExtend:deepExtend})}var Fsm=function(options){_.extend(this,options);_.defaults(this,utils.getDefaultOptions());this.initialize.apply(this,arguments);machina.emit(NEW_FSM,this);if(this.initialState){this.transition(this.initialState)}};_.extend(Fsm.prototype,{initialize:function(){},emit:function(eventName){var args=arguments;if(this.eventListeners["*"]){_.each(this.eventListeners["*"],function(callback){try{callback.apply(this,slice.call(args,0))}catch(exception){if(console&&typeof console.log!=="undefined"){console.log(exception.toString())}}},this)}if(this.eventListeners[eventName]){_.each(this.eventListeners[eventName],function(callback){try{callback.apply(this,slice.call(args,1))}catch(exception){if(console&&typeof console.log!=="undefined"){console.log(exception.toString())}}},this)}},handle:function(inputType){if(!this.inExitHandler){var states=this.states,current=this.state,args=slice.call(arguments,0),handlerName,handler,catchAll,action;this.currentActionArgs=args;if(states[current][inputType]||states[current]["*"]||this["*"]){handlerName=states[current][inputType]?inputType:"*";catchAll=handlerName==="*";if(states[current][handlerName]){handler=states[current][handlerName];action=current+"."+handlerName}else{handler=this["*"];action="*"}if(!this._currentAction)this._currentAction=action;this.emit.call(this,HANDLING,{inputType:inputType,args:args.slice(1)});if(_.isFunction(handler))handler=handler.apply(this,catchAll?args:args.slice(1));if(_.isString(handler))this.transition(handler);this.emit.call(this,HANDLED,{inputType:inputType,args:args.slice(1)});this._priorAction=this._currentAction;this._currentAction="";this.processQueue(NEXT_HANDLER)}else{this.emit.call(this,NO_HANDLER,{inputType:inputType,args:args.slice(1)})}this.currentActionArgs=undefined}},transition:function(newState){if(!this.inExitHandler&&newState!==this.state){var curState=this.state;if(this.states[newState]){if(this.states[curState]&&this.states[curState]._onExit){this.inExitHandler=true;this.states[curState]._onExit.call(this);this.inExitHandler=false}this.targetReplayState=newState;this.priorState=curState;this.state=newState;this.emit.call(this,TRANSITION,{fromState:this.priorState,action:this._currentAction,toState:newState});if(this.states[newState]._onEnter){this.states[newState]._onEnter.call(this)}if(this.targetReplayState===newState){this.processQueue(NEXT_TRANSITION)}return}this.emit.call(this,INVALID_STATE,{state:this.state,attemptedState:newState})}},processQueue:function(type){var filterFn=type===NEXT_TRANSITION?function(item){return item.type===NEXT_TRANSITION&&(!item.untilState||item.untilState===this.state)}:function(item){return item.type===NEXT_HANDLER};var toProcess=_.filter(this.eventQueue,filterFn,this);this.eventQueue=_.difference(this.eventQueue,toProcess);_.each(toProcess,function(item){this.handle.apply(this,item.args)},this)},clearQueue:function(type,name){if(!type){this.eventQueue=[]}else{var filter;if(type===NEXT_TRANSITION){filter=function(evnt){return evnt.type===NEXT_TRANSITION&&(name?evnt.untilState===name:true)}}else if(type===NEXT_HANDLER){filter=function(evnt){return evnt.type===NEXT_HANDLER}}this.eventQueue=_.filter(this.eventQueue,filter)}},deferUntilTransition:function(stateName){if(this.currentActionArgs){var queued={type:NEXT_TRANSITION,untilState:stateName,args:this.currentActionArgs};this.eventQueue.push(queued);this.emit.call(this,DEFERRED,{state:this.state,queuedArgs:queued})}},deferUntilNextHandler:function(){if(this.currentActionArgs){var queued={type:NEXT_HANDLER,args:this.currentActionArgs};this.eventQueue.push(queued);this.emit.call(this,DEFERRED,{state:this.state,queuedArgs:queued})}},on:function(eventName,callback){var self=this;if(!self.eventListeners[eventName]){self.eventListeners[eventName]=[]}self.eventListeners[eventName].push(callback);return{eventName:eventName,callback:callback,off:function(){self.off(eventName,callback)}}},off:function(eventName,callback){if(!eventName){this.eventListeners={}}else{if(this.eventListeners[eventName]){if(callback){this.eventListeners[eventName]=_.without(this.eventListeners[eventName],callback)}else{this.eventListeners[eventName]=[]}}}}});Fsm.prototype.trigger=Fsm.prototype.emit;var ctor=function(){};var inherits=function(parent,protoProps,staticProps){var fsm;if(protoProps&&protoProps.hasOwnProperty("constructor")){fsm=protoProps.constructor}else{fsm=function(){parent.apply(this,arguments)}}_.deepExtend(fsm,parent);ctor.prototype=parent.prototype;fsm.prototype=new ctor;if(protoProps){_.deepExtend(fsm.prototype,protoProps)}if(staticProps){_.deepExtend(fsm,staticProps)}fsm.prototype.constructor=fsm;fsm.__super__=parent.prototype;return fsm};Fsm.extend=function(protoProps,classProps){var fsm=inherits(this,protoProps,classProps);fsm.extend=this.extend;return fsm};var machina={Fsm:Fsm,utils:utils,on:function(eventName,callback){if(!this.eventListeners[eventName]){this.eventListeners[eventName]=[]}this.eventListeners[eventName].push(callback);return callback},off:function(eventName,callback){if(this.eventListeners[eventName]){this.eventListeners[eventName]=_.without(this.eventListeners[eventName],callback)}},trigger:function(eventName){var args=arguments,listeners=this.eventListeners[eventName]||[];if(listeners&&listeners.length){_.each(listeners,function(callback){callback.apply(null,slice.call(args,1))})}},eventListeners:{newFsm:[]}};machina.emit=machina.trigger;module.exports=machina},{"./underscore":23}],21:[function(require,module,exports){var setTimeoutFunc=require("./setImmediate.js");function noop(){}function bind(fn,thisArg){return function(){fn.apply(thisArg,arguments)}}function Promise(fn){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");if(typeof fn!=="function")throw new TypeError("not a function");this._state=0;this._handled=false;this._value=undefined;this._deferreds=[];doResolve(fn,this)}function handle(self,deferred){while(self._state===3){self=self._value}if(self._state===0){self._deferreds.push(deferred);return}self._handled=true;Promise._immediateFn(function(){var cb=self._state===1?deferred.onFulfilled:deferred.onRejected;if(cb===null){(self._state===1?resolve:reject)(deferred.promise,self._value);return}var ret;try{ret=cb(self._value)}catch(e){reject(deferred.promise,e);return}resolve(deferred.promise,ret)})}function resolve(self,newValue){try{if(newValue===self)throw new TypeError("A promise cannot be resolved with itself.");if(newValue&&(typeof newValue==="object"||typeof newValue==="function")){var then=newValue.then;if(newValue instanceof Promise){self._state=3;self._value=newValue;finale(self);return}else if(typeof then==="function"){doResolve(bind(then,newValue),self);return}}self._state=1;self._value=newValue;finale(self)}catch(e){reject(self,e)}}function reject(self,newValue){self._state=2;self._value=newValue;finale(self)}function finale(self){if(self._state===2&&self._deferreds.length===0){Promise._immediateFn(function(){if(!self._handled){Promise._unhandledRejectionFn(self._value)}})}for(var i=0,len=self._deferreds.length;i<len;i++){handle(self,self._deferreds[i])}self._deferreds=null}function Handler(onFulfilled,onRejected,promise){this.onFulfilled=typeof onFulfilled==="function"?onFulfilled:null;this.onRejected=typeof onRejected==="function"?onRejected:null;this.promise=promise}function doResolve(fn,self){var done=false;try{fn(function(value){if(done)return;done=true;resolve(self,value)},function(reason){if(done)return;done=true;reject(self,reason)})}catch(ex){if(done)return;done=true;reject(self,ex)}}Promise.prototype["catch"]=function(onRejected){return this.then(null,onRejected)};Promise.prototype.then=function(onFulfilled,onRejected){var prom=new this.constructor(noop);handle(this,new Handler(onFulfilled,onRejected,prom));return prom};Promise.all=function(arr){var args=Array.prototype.slice.call(arr);return new Promise(function(resolve,reject){if(args.length===0)return resolve([]);var remaining=args.length;function res(i,val){try{if(val&&(typeof val==="object"||typeof val==="function")){var then=val.then;if(typeof then==="function"){then.call(val,function(val){res(i,val)},reject);return}}args[i]=val;if(--remaining===0){resolve(args)}}catch(ex){reject(ex)}}for(var i=0;i<args.length;i++){res(i,args[i])}})};Promise.resolve=function(value){if(value&&typeof value==="object"&&value.constructor===Promise){return value}return new Promise(function(resolve){resolve(value)})};Promise.reject=function(value){return new Promise(function(resolve,reject){reject(value)})};Promise.race=function(values){return new Promise(function(resolve,reject){for(var i=0,len=values.length;i<len;i++){values[i].then(resolve,reject)}})};Promise._immediateFn=typeof setImmediate==="function"&&function(fn){setImmediate(fn)}||function(fn){setTimeoutFunc(fn,0)};Promise._unhandledRejectionFn=function _unhandledRejectionFn(err){if(typeof console!=="undefined"&&console){console.warn("Possible Unhandled Promise Rejection:",err)}};Promise._setImmediateFn=function _setImmediateFn(fn){Promise._immediateFn=fn};Promise._setUnhandledRejectionFn=function _setUnhandledRejectionFn(fn){Promise._unhandledRejectionFn=fn};module.exports=typeof window.Promise==="function"?window.Promise:Promise},{"./setImmediate.js":22}],22:[function(require,module,exports){"use strict";var global=window;var nextHandle=1;var tasksByHandle={};var currentlyRunningATask=false;var doc=global.document;var registerImmediate;function setImmediate(callback){if(typeof callback!=="function"){callback=new Function(""+callback)}var args=new Array(arguments.length-1);for(var i=0;i<args.length;i++){args[i]=arguments[i+1]}var task={callback:callback,args:args};tasksByHandle[nextHandle]=task;registerImmediate(nextHandle);return nextHandle++}function clearImmediate(handle){delete tasksByHandle[handle]}function run(task){var callback=task.callback;var args=task.args;switch(args.length){case 0:callback();break;case 1:callback(args[0]);break;case 2:callback(args[0],args[1]);break;case 3:callback(args[0],args[1],args[2]);break;default:callback.apply(undefined,args);break}}function runIfPresent(handle){if(currentlyRunningATask){setTimeout(runIfPresent,0,handle)}else{var task=tasksByHandle[handle];if(task){currentlyRunningATask=true;try{run(task)}finally{clearImmediate(handle);currentlyRunningATask=false}}}}function canUsePostMessage(){if(global.postMessage&&!global.importScripts){var postMessageIsAsynchronous=true;var oldOnMessage=global.onmessage;global.onmessage=function(){postMessageIsAsynchronous=false};global.postMessage("","*");global.onmessage=oldOnMessage;return postMessageIsAsynchronous}}function installPostMessageImplementation(){var messagePrefix="setImmediate$"+Math.random()+"$";var onGlobalMessage=function(event){if(event.source===global&&typeof event.data==="string"&&event.data.indexOf(messagePrefix)===0){runIfPresent(+event.data.slice(messagePrefix.length))}};if(global.addEventListener){global.addEventListener("message",onGlobalMessage,false)}else{global.attachEvent("onmessage",onGlobalMessage)}registerImmediate=function(handle){global.postMessage(messagePrefix+handle,"*")}}function installMessageChannelImplementation(){var channel=new MessageChannel;channel.port1.onmessage=function(event){var handle=event.data;runIfPresent(handle)};registerImmediate=function(handle){channel.port2.postMessage(handle)}}function installReadyStateChangeImplementation(){var html=doc.documentElement;registerImmediate=function(handle){var script=doc.createElement("script");script.onreadystatechange=function(){runIfPresent(handle);script.onreadystatechange=null;html.removeChild(script);script=null};html.appendChild(script)}}function installSetTimeoutImplementation(){registerImmediate=function(handle){setTimeout(runIfPresent,0,handle)}}if(canUsePostMessage()){installPostMessageImplementation()}else if(global.MessageChannel){installMessageChannelImplementation()}else if(doc&&"onreadystatechange"in doc.createElement("script")){installReadyStateChangeImplementation()}else{installSetTimeoutImplementation()}module.exports.setImmediate=typeof window.setImmediate==="function"?window.setImmediate:setImmediate;module.exports.clearImmediate=typeof window.clearImmediate==="function"?window.clearImmediate:clearImmediate},{}],23:[function(require,module,exports){(function(){var root=this;var previousUnderscore=root._;var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind,nativeCreate=Object.create;var Ctor=function(){};var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.8.2";var optimizeCb=function(func,context,argCount){if(context===void 0)return func;switch(argCount==null?3:argCount){case 1:return function(value){return func.call(context,value)};case 2:return function(value,other){return func.call(context,value,other)};case 3:return function(value,index,collection){return func.call(context,value,index,collection)};case 4:return function(accumulator,value,index,collection){return func.call(context,accumulator,value,index,collection)}}return function(){return func.apply(context,arguments)}};var cb=function(value,context,argCount){if(value==null)return _.identity;if(_.isFunction(value))return optimizeCb(value,context,argCount);if(_.isObject(value))return _.matcher(value);return _.property(value)};_.iteratee=function(value,context){return cb(value,context,Infinity)};var createAssigner=function(keysFunc,undefinedOnly){return function(obj){var length=arguments.length;if(length<2||obj==null)return obj;for(var index=1;index<length;index++){var source=arguments[index],keys=keysFunc(source),l=keys.length;for(var i=0;i<l;i++){var key=keys[i];if(!undefinedOnly||obj[key]===void 0)obj[key]=source[key]}}return obj}};var baseCreate=function(prototype){if(!_.isObject(prototype))return{};if(nativeCreate)return nativeCreate(prototype);Ctor.prototype=prototype;var result=new Ctor;Ctor.prototype=null;return result};var MAX_ARRAY_INDEX=Math.pow(2,53)-1;var isArrayLike=function(collection){var length=collection&&collection.length;return typeof length=="number"&&length>=0&&length<=MAX_ARRAY_INDEX};_.each=_.forEach=function(obj,iteratee,context){iteratee=optimizeCb(iteratee,context);var i,length;if(isArrayLike(obj)){for(i=0,length=obj.length;i<length;i++){iteratee(obj[i],i,obj)}}else{var keys=_.keys(obj);for(i=0,length=keys.length;i<length;i++){iteratee(obj[keys[i]],keys[i],obj)}}return obj};_.map=_.collect=function(obj,iteratee,context){iteratee=cb(iteratee,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,results=Array(length);for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;results[index]=iteratee(obj[currentKey],currentKey,obj)}return results};function createReduce(dir){function iterator(obj,iteratee,memo,keys,index,length){for(;index>=0&&index<length;index+=dir){var currentKey=keys?keys[index]:index;memo=iteratee(memo,obj[currentKey],currentKey,obj)}return memo}return function(obj,iteratee,memo,context){iteratee=optimizeCb(iteratee,context,4);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length,index=dir>0?0:length-1;if(arguments.length<3){memo=obj[keys?keys[index]:index];index+=dir}return iterator(obj,iteratee,memo,keys,index,length)}}_.reduce=_.foldl=_.inject=createReduce(1);_.reduceRight=_.foldr=createReduce(-1);_.find=_.detect=function(obj,predicate,context){var key;if(isArrayLike(obj)){key=_.findIndex(obj,predicate,context)}else{key=_.findKey(obj,predicate,context)}if(key!==void 0&&key!==-1)return obj[key]};_.filter=_.select=function(obj,predicate,context){var results=[];predicate=cb(predicate,context);_.each(obj,function(value,index,list){if(predicate(value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(cb(predicate)),context)};_.every=_.all=function(obj,predicate,context){predicate=cb(predicate,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length;for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(!predicate(obj[currentKey],currentKey,obj))return false}return true};_.some=_.any=function(obj,predicate,context){predicate=cb(predicate,context);var keys=!isArrayLike(obj)&&_.keys(obj),length=(keys||obj).length;for(var index=0;index<length;index++){var currentKey=keys?keys[index]:index;if(predicate(obj[currentKey],currentKey,obj))return true}return false};_.contains=_.includes=_.include=function(obj,target,fromIndex){if(!isArrayLike(obj))obj=_.values(obj);return _.indexOf(obj,target,typeof fromIndex=="number"&&fromIndex)>=0};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){var func=isFunc?method:value[method];return func==null?func:func.apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matcher(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matcher(attrs))};_.max=function(obj,iteratee,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(iteratee==null&&obj!=null){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value>result){result=value}}}else{iteratee=cb(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=value;lastComputed=computed}})}return result};_.min=function(obj,iteratee,context){var result=Infinity,lastComputed=Infinity,value,computed;if(iteratee==null&&obj!=null){obj=isArrayLike(obj)?obj:_.values(obj);for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value<result){result=value}}}else{iteratee=cb(iteratee,context);_.each(obj,function(value,index,list){computed=iteratee(value,index,list);if(computed<lastComputed||computed===Infinity&&result===Infinity){result=value;lastComputed=computed}})}return result};_.shuffle=function(obj){var set=isArrayLike(obj)?obj:_.values(obj);var length=set.length;var shuffled=Array(length);for(var index=0,rand;index<length;index++){rand=_.random(0,index);if(rand!==index)shuffled[index]=shuffled[rand];shuffled[rand]=set[index]}return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(!isArrayLike(obj))obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};_.sortBy=function(obj,iteratee,context){iteratee=cb(iteratee,context);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iteratee(value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iteratee,context){var result={};iteratee=cb(iteratee,context);_.each(obj,function(value,index){var key=iteratee(value,index,obj);behavior(result,value,key)});return result}};_.groupBy=group(function(result,value,key){if(_.has(result,key))result[key].push(value);else result[key]=[value]});_.indexBy=group(function(result,value,key){result[key]=value});_.countBy=group(function(result,value,key){if(_.has(result,key))result[key]++;else result[key]=1});_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(isArrayLike(obj))return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return isArrayLike(obj)?obj.length:_.keys(obj).length};_.partition=function(obj,predicate,context){predicate=cb(predicate,context);var pass=[],fail=[];_.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)});return[pass,fail]};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];return _.initial(array,array.length-n)};_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return _.rest(array,Math.max(0,array.length-n))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,startIndex){var output=[],idx=0;for(var i=startIndex||0,length=input&&input.length;i<length;i++){var value=input[i];if(isArrayLike(value)&&(_.isArray(value)||_.isArguments(value))){if(!shallow)value=flatten(value,shallow,strict);var j=0,len=value.length;output.length+=len;while(j<len){output[idx++]=value[j++]}}else if(!strict){output[idx++]=value}}return output};_.flatten=function(array,shallow){return flatten(array,shallow,false)};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted,iteratee,context){if(array==null)return[];if(!_.isBoolean(isSorted)){context=iteratee;iteratee=isSorted;isSorted=false}if(iteratee!=null)iteratee=cb(iteratee,context);var result=[];var seen=[];for(var i=0,length=array.length;i<length;i++){var value=array[i],computed=iteratee?iteratee(value,i,array):value;if(isSorted){if(!i||seen!==computed)result.push(value);seen=computed}else if(iteratee){if(!_.contains(seen,computed)){seen.push(computed);result.push(value)}}else if(!_.contains(result,value)){result.push(value)}}return result};_.union=function(){return _.uniq(flatten(arguments,true,true))};_.intersection=function(array){if(array==null)return[];var result=[];var argsLength=arguments.length;for(var i=0,length=array.length;i<length;i++){var item=array[i];if(_.contains(result,item))continue;for(var j=1;j<argsLength;j++){if(!_.contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result};_.difference=function(array){var rest=flatten(arguments,true,true,1);return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){return _.unzip(arguments)};_.unzip=function(array){var length=array&&_.max(array,"length").length||0;var result=Array(length);for(var index=0;index<length;index++){result[index]=_.pluck(array,index)}return result};_.object=function(list,values){var result={};for(var i=0,length=list&&list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){var i=0,length=array&&array.length;if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else if(isSorted&&length){i=_.sortedIndex(array,item);return array[i]===item?i:-1}if(item!==item){return _.findIndex(slice.call(array,i),_.isNaN)}for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){var idx=array?array.length:0;if(typeof from=="number"){idx=from<0?idx+from+1:Math.min(idx,from+1)}if(item!==item){return _.findLastIndex(slice.call(array,0,idx),_.isNaN)}while(--idx>=0)if(array[idx]===item)return idx;return-1};function createIndexFinder(dir){return function(array,predicate,context){predicate=cb(predicate,context);var length=array!=null&&array.length;var index=dir>0?0:length-1;for(;index>=0&&index<length;index+=dir){if(predicate(array[index],index,array))return index}return-1}}_.findIndex=createIndexFinder(1);_.findLastIndex=createIndexFinder(-1);_.sortedIndex=function(array,obj,iteratee,context){iteratee=cb(iteratee,context,1);var value=iteratee(obj);var low=0,high=array.length;while(low<high){var mid=Math.floor((low+high)/2);if(iteratee(array[mid])<value)low=mid+1;else high=mid}return low};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=step||1;var length=Math.max(Math.ceil((stop-start)/step),0);var range=Array(length);for(var idx=0;idx<length;idx++,start+=step){range[idx]=start}return range};var executeBound=function(sourceFunc,boundFunc,context,callingContext,args){if(!(callingContext instanceof boundFunc))return sourceFunc.apply(context,args);var self=baseCreate(sourceFunc.prototype);var result=sourceFunc.apply(self,args);if(_.isObject(result))return result;return self};_.bind=function(func,context){if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");var args=slice.call(arguments,2);var bound=function(){return executeBound(func,bound,context,this,args.concat(slice.call(arguments)))};return bound};_.partial=function(func){var boundArgs=slice.call(arguments,1);var bound=function(){var position=0,length=boundArgs.length;var args=Array(length);for(var i=0;i<length;i++){args[i]=boundArgs[i]===_?arguments[position++]:boundArgs[i]}while(position<arguments.length)args.push(arguments[position++]);return executeBound(func,bound,this,this,args)};return bound};_.bindAll=function(obj){var i,length=arguments.length,key;if(length<=1)throw new Error("bindAll must be passed function names");
for(i=1;i<length;i++){key=arguments[i];obj[key]=_.bind(obj[key],obj)}return obj};_.memoize=function(func,hasher){var memoize=function(key){var cache=memoize.cache;var address=""+(hasher?hasher.apply(this,arguments):key);if(!_.has(cache,address))cache[address]=func.apply(this,arguments);return cache[address]};memoize.cache={};return memoize};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=_.partial(_.delay,_,1);_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;if(!options)options={};var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);if(!timeout)context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){if(timeout){clearTimeout(timeout);timeout=null}previous=now;result=func.apply(context,args);if(!timeout)context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait&&last>=0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);if(!timeout)context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout)timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args);context=args=null}return result}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}};_.compose=function(){var args=arguments;var start=args.length-1;return function(){var i=start;var result=args[start].apply(this,arguments);while(i--)result=args[i].call(this,result);return result}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.before=function(times,func){var memo;return function(){if(--times>0){memo=func.apply(this,arguments)}if(times<=1)func=null;return memo}};_.once=_.partial(_.before,2);var hasEnumBug=!{toString:null}.propertyIsEnumerable("toString");var nonEnumerableProps=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];function collectNonEnumProps(obj,keys){var nonEnumIdx=nonEnumerableProps.length;var constructor=obj.constructor;var proto=_.isFunction(constructor)&&constructor.prototype||ObjProto;var prop="constructor";if(_.has(obj,prop)&&!_.contains(keys,prop))keys.push(prop);while(nonEnumIdx--){prop=nonEnumerableProps[nonEnumIdx];if(prop in obj&&obj[prop]!==proto[prop]&&!_.contains(keys,prop)){keys.push(prop)}}}_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys};_.allKeys=function(obj){if(!_.isObject(obj))return[];var keys=[];for(var key in obj)keys.push(key);if(hasEnumBug)collectNonEnumProps(obj,keys);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.mapObject=function(obj,iteratee,context){iteratee=cb(iteratee,context);var keys=_.keys(obj),length=keys.length,results={},currentKey;for(var index=0;index<length;index++){currentKey=keys[index];results[currentKey]=iteratee(obj[currentKey],currentKey,obj)}return results};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=createAssigner(_.allKeys);_.extendOwn=_.assign=createAssigner(_.keys);_.findKey=function(obj,predicate,context){predicate=cb(predicate,context);var keys=_.keys(obj),key;for(var i=0,length=keys.length;i<length;i++){key=keys[i];if(predicate(obj[key],key,obj))return key}};_.pick=function(object,oiteratee,context){var result={},obj=object,iteratee,keys;if(obj==null)return result;if(_.isFunction(oiteratee)){keys=_.allKeys(obj);iteratee=optimizeCb(oiteratee,context)}else{keys=flatten(arguments,false,false,1);iteratee=function(value,key,obj){return key in obj};obj=Object(obj)}for(var i=0,length=keys.length;i<length;i++){var key=keys[i];var value=obj[key];if(iteratee(value,key,obj))result[key]=value}return result};_.omit=function(obj,iteratee,context){if(_.isFunction(iteratee)){iteratee=_.negate(iteratee)}else{var keys=_.map(flatten(arguments,false,false,1),String);iteratee=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iteratee,context)};_.defaults=createAssigner(_.allKeys,true);_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};_.isMatch=function(object,attrs){var keys=_.keys(attrs),length=keys.length;if(object==null)return!length;var obj=Object(object);for(var i=0;i<length;i++){var key=keys[i];if(attrs[key]!==obj[key]||!(key in obj))return false}return true};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a===1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!==toString.call(b))return false;switch(className){case"[object RegExp]":case"[object String]":return""+a===""+b;case"[object Number]":if(+a!==+a)return+b!==+b;return+a===0?1/+a===1/b:+a===+b;case"[object Date]":case"[object Boolean]":return+a===+b}var areArrays=className==="[object Array]";if(!areArrays){if(typeof a!="object"||typeof b!="object")return false;var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}}aStack=aStack||[];bStack=bStack||[];var length=aStack.length;while(length--){if(aStack[length]===a)return bStack[length]===b}aStack.push(a);bStack.push(b);if(areArrays){length=a.length;if(length!==b.length)return false;while(length--){if(!eq(a[length],b[length],aStack,bStack))return false}}else{var keys=_.keys(a),key;length=keys.length;if(_.keys(b).length!==length)return false;while(length--){key=keys[length];if(!(_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))return false}}aStack.pop();bStack.pop();return true};_.isEqual=function(a,b){return eq(a,b)};_.isEmpty=function(obj){if(obj==null)return true;if(isArrayLike(obj)&&(_.isArray(obj)||_.isString(obj)||_.isArguments(obj)))return obj.length===0;return _.keys(obj).length===0};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isObject=function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj};_.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(name){_["is"+name]=function(obj){return toString.call(obj)==="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return _.has(obj,"callee")}}if(typeof/./!="function"&&typeof Int8Array!="object"){_.isFunction=function(obj){return typeof obj=="function"||false}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!==+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)==="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.noop=function(){};_.property=function(key){return function(obj){return obj==null?void 0:obj[key]}};_.propertyOf=function(obj){return obj==null?function(){}:function(key){return obj[key]}};_.matcher=_.matches=function(attrs){attrs=_.extendOwn({},attrs);return function(obj){return _.isMatch(obj,attrs)}};_.times=function(n,iteratee,context){var accum=Array(Math.max(0,n));iteratee=optimizeCb(iteratee,context,1);for(var i=0;i<n;i++)accum[i]=iteratee(i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var escapeMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"};var unescapeMap=_.invert(escapeMap);var createEscaper=function(map){var escaper=function(match){return map[match]};var source="(?:"+_.keys(map).join("|")+")";var testRegexp=RegExp(source);var replaceRegexp=RegExp(source,"g");return function(string){string=string==null?"":""+string;return testRegexp.test(string)?string.replace(replaceRegexp,escaper):string}};_.escape=createEscaper(escapeMap);_.unescape=createEscaper(unescapeMap);_.result=function(object,property,fallback){var value=object==null?void 0:object[property];if(value===void 0){value=fallback}return _.isFunction(value)?value.call(object):value};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\u2028|\u2029/g;var escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,settings,oldSettings){if(!settings&&oldSettings)settings=oldSettings;settings=_.defaults({},settings,_.templateSettings);var matcher=RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}var template=function(data){return render.call(this,data,_)};var argument=settings.variable||"obj";template.source="function("+argument+"){\n"+source+"}";return template};_.chain=function(obj){var instance=_(obj);instance._chain=true;return instance};var result=function(instance,obj){return instance._chain?_(obj).chain():obj};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result(this,func.apply(_,args))}})};_.mixin(_);_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name==="shift"||name==="splice")&&obj.length===0)delete obj[0];return result(this,obj)}});_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result(this,method.apply(this._wrapped,arguments))}});_.prototype.value=function(){return this._wrapped};_.prototype.valueOf=_.prototype.toJSON=_.prototype.value;_.prototype.toString=function(){return""+this._wrapped};if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this)},{}],24:[function(require,module,exports){"use strict";var _=require("./vendor/underscore");var SimpleEmitter=require("./emitter");var Util=require("./util");var periodically=Util.periodically;var _logger=require("./logger");function WindowWatcher(id,url,options){this.id=id;this.url=url;this.options=options;this.window=null;this.isListening=false;this.isExpectedOpen=false;this.closeWatcher=_.bind(this.closeWatcher,this);this.timer=periodically(this.closeWatcher,600);return SimpleEmitter.mixin(this)}WindowWatcher.prototype.isOpened=function(){return this.window&&!this.window.closed};WindowWatcher.prototype.isClosed=function(){return!this.isOpened()};WindowWatcher.prototype.setSrc=function(url){if(!this.window){return _logger.warn("setSrc failed: no window!")}if(this.isClosed()){return _logger.warn("setSrc failed: cannot set location of closed window!")}this.window.location.href=url};WindowWatcher.prototype.addListeners=function(){if(this.isListening||!this.window){return}this.isListening=true;this.timer.start()};WindowWatcher.prototype.removeListeners=function(){if(!this.isListening||!this.window){return}this.isListening=false;this.timer.stop()};WindowWatcher.prototype.closeWatcher=function(){if(!this.window){_logger.debug('no window found for ID "'+this.id+'"');this.removeListeners();return}if(this.isClosed()&&this.isExpectedOpen){_logger.log('window "'+this.id+'" was found closed');this.removeListeners();this.isExpectedOpen=false;this.emit("closed")}};WindowWatcher.prototype.open=function(url,options){if(this.isOpened()&&this.isExpectedOpen){this.focus();return true}this.url=url||this.url;this.options=options||this.options||"";_logger.log('opening window "'+this.id+'" to url "'+this.url+'"');this.window=window.open(this.url,this.id,this.options,true);if(this.window){this.isExpectedOpen=true;this.addListeners();this.focus();this.emit("opened");return true}return false};WindowWatcher.prototype.close=function(){if(this.isClosed()&&!this.isExpectedOpen){return}_logger.log('closing window "'+this.id+'"');try{this.window.close()}catch(e){}this.isExpectedOpen=false;this.removeListeners();this.emit("closed")};WindowWatcher.prototype.focus=function(){if(!this.isOpened()){return}try{this.window.focus()}catch(e){}};module.exports=WindowWatcher},{"./emitter":8,"./logger":11,"./util":19,"./vendor/underscore":23}]},{},[10]);
//# sourceMappingURL=cvp.auth.min.js.map